<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChangeFlow v3 ‚Äî Enterprise Change Management</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
--bg:#0d0f14; --surface:#151820; --surface2:#1c2030; --surface3:#242840; --surface4:#2a2f45;
--border:#2a2f45; --border2:#343a55;
--accent:#4f7cff; --accent2:#00d4aa; --accent3:#ff6b6b; --accent4:#ffa94d; --accent5:#c084fc;
--text:#e8eaf6; --text2:#8890b0; --text3:#525870;
--font:'IBM Plex Sans',sans-serif; --mono:'IBM Plex Mono',monospace;
--radius:8px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;overflow-x:hidden;}
/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app{display:flex;height:100vh;}
.sidebar{width:260px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{height:58px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 22px;gap:14px;flex-shrink:0;}
.content{flex:1;overflow-y:auto;padding:26px;}
/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.logo{padding:18px 20px 14px;border-bottom:1px solid var(--border);}
.logo-text{font-family:var(--mono);font-size:18px;font-weight:600;color:var(--accent);}
.logo-sub{font-size:9px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.logo-ver{font-size:9px;color:var(--text3);font-family:var(--mono);margin-top:1px;}
.nav{padding:10px 0;flex:1;overflow-y:auto;}
.nav-section{padding:10px 16px 4px;font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text3);}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 18px;cursor:pointer;transition:all .12s;font-size:13px;color:var(--text2);border-left:3px solid transparent;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:rgba(79,124,255,.1);color:var(--accent);border-left-color:var(--accent);}
.nav-icon{width:16px;height:16px;opacity:.8;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-family:var(--mono);padding:1px 7px;border-radius:10px;font-weight:600;}
.nav-badge.red{background:var(--accent3);}
.nav-badge.orange{background:var(--accent4);}
.nav-badge.green{background:var(--accent2);}
.user-area{padding:14px 16px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:#fff;flex-shrink:0;}
.user-name{font-size:13px;font-weight:500;}
.user-role{font-size:10px;color:var(--text3);}
.logout-btn{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--text3);font-size:18px;transition:color .12s;}
.logout-btn:hover{color:var(--accent3);}
/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.page-title{font-size:16px;font-weight:600;}
.topbar-actions{margin-left:auto;display:flex;gap:8px;align-items:center;}
.notif-wrap{position:relative;}
.notif-dot{width:7px;height:7px;background:var(--accent3);border-radius:50%;border:2px solid var(--surface);position:absolute;top:-1px;right:-1px;}
/* FREEZE BANNER */
.freeze-banner{background:rgba(192,132,252,.08);border-bottom:1px solid rgba(192,132,252,.2);padding:7px 22px;display:flex;align-items:center;gap:8px;font-size:12px;color:#c084fc;}
/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:var(--radius);font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .12s;font-family:var(--font);}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:#6b91ff;transform:translateY(-1px);}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--surface2);color:var(--text);}
.btn-danger{background:rgba(255,107,107,.15);color:var(--accent3);border:1px solid rgba(255,107,107,.3);}
.btn-danger:hover{background:rgba(255,107,107,.25);}
.btn-success{background:rgba(0,212,170,.15);color:var(--accent2);border:1px solid rgba(0,212,170,.3);}
.btn-success:hover{background:rgba(0,212,170,.25);}
.btn-warning{background:rgba(255,169,77,.15);color:var(--accent4);border:1px solid rgba(255,169,77,.3);}
.btn-sm{padding:5px 11px;font-size:12px;}
.btn-xs{padding:3px 8px;font-size:11px;}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important;}
/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;}
.card-title{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;}
/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;position:relative;overflow:hidden;cursor:pointer;transition:all .15s;}
.stat-card:hover{border-color:var(--accent);transform:translateY(-2px);}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.stat-card.s-open::before{background:var(--accent3);}
.stat-card.s-review::before{background:var(--accent);}
.stat-card.s-impl::before{background:var(--accent4);}
.stat-card.s-ok::before{background:var(--accent2);}
.stat-card.s-freeze::before{background:var(--accent5);}
.stat-number{font-family:var(--mono);font-size:28px;font-weight:600;line-height:1;margin-bottom:4px;}
.stat-card.s-open .stat-number{color:var(--accent3);}
.stat-card.s-review .stat-number{color:var(--accent);}
.stat-card.s-impl .stat-number{color:var(--accent4);}
.stat-card.s-ok .stat-number{color:var(--accent2);}
.stat-card.s-freeze .stat-number{color:var(--accent5);}
.stat-label{font-size:12px;color:var(--text2);}
.stat-trend{font-size:10px;color:var(--text3);margin-top:5px;font-family:var(--mono);}
/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.table-header{padding:13px 17px;display:flex;align-items:center;gap:9px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.table-title{font-size:14px;font-weight:600;}
.search-bar{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:6px 11px;}
.search-bar input{background:none;border:none;outline:none;font-family:var(--font);font-size:13px;color:var(--text);width:200px;}
.search-bar input::placeholder{color:var(--text3);}
table{width:100%;border-collapse:collapse;}
th{padding:9px 13px;text-align:left;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);background:var(--surface2);border-bottom:1px solid var(--border);}
td{padding:11px 13px;font-size:13px;border-bottom:1px solid rgba(42,47,69,.5);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.015);}
.change-id{font-family:var(--mono);font-size:11px;color:var(--accent);}
/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;}
.badge::before{content:'';width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.badge-open{background:rgba(255,107,107,.12);color:#ff8585;} .badge-open::before{background:var(--accent3);}
.badge-review{background:rgba(79,124,255,.12);color:#7b9dff;} .badge-review::before{background:var(--accent);}
.badge-approved{background:rgba(0,212,170,.12);color:#00d4aa;} .badge-approved::before{background:var(--accent2);}
.badge-scheduled{background:rgba(255,169,77,.12);color:#ffa94d;} .badge-scheduled::before{background:var(--accent4);}
.badge-implementing{background:rgba(255,169,77,.2);color:#ffbd6e;animation:pulse 2s infinite;} .badge-implementing::before{background:var(--accent4);}
.badge-closed{background:rgba(82,88,112,.2);color:var(--text3);} .badge-closed::before{background:var(--text3);}
.badge-rejected{background:rgba(255,107,107,.12);color:#ff6b6b;} .badge-rejected::before{background:var(--accent3);}
.badge-freeze{background:rgba(192,132,252,.12);color:#c084fc;} .badge-freeze::before{background:var(--accent5);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.priority{display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:500;}
.priority-critical{color:var(--accent3);}
.priority-high{color:var(--accent4);}
.priority-medium{color:var(--accent);}
.priority-low{color:var(--text3);}
.type-badge{background:var(--surface3);color:var(--text2);padding:2px 7px;border-radius:4px;font-size:10px;font-family:var(--mono);}
/* ‚îÄ‚îÄ ENV PIPELINE ‚îÄ‚îÄ */
.env-pipeline{display:flex;align-items:center;gap:0;width:100%;}
.env-node{flex:1;display:flex;flex-direction:column;align-items:center;position:relative;}
.env-dot{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;z-index:1;border:2px solid var(--border);background:var(--surface2);color:var(--text3);}
.env-node.env-done .env-dot{background:var(--accent2);border-color:var(--accent2);color:#fff;}
.env-node.env-active .env-dot{background:var(--accent4);border-color:var(--accent4);color:#fff;}
.env-node.env-failed .env-dot{background:var(--accent3);border-color:var(--accent3);color:#fff;}
.env-node.env-skip .env-dot{background:var(--accent5);border-color:var(--accent5);color:#fff;}
.env-label{font-size:9px;margin-top:4px;color:var(--text3);font-family:var(--mono);font-weight:600;}
.env-inline{display:flex;align-items:center;gap:3px;}
.env-pip{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;flex-shrink:0;}
.env-arrow-sm{color:var(--text3);font-size:10px;}
/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .18s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:750px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.6);transform:translateY(14px);transition:transform .18s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-wide{width:950px;}
.modal-xl{width:1100px;}
.modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:12px;}
.modal-title{font-size:16px;font-weight:600;}
.modal-subtitle{font-size:12px;color:var(--text2);margin-top:3px;}
.modal-close{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--text3);font-size:20px;line-height:1;}
.modal-close:hover{color:var(--text);}
.modal-body{padding:20px 24px;}
.modal-footer{padding:14px 24px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}
/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-group{display:flex;flex-direction:column;gap:5px;}
.form-group.full{grid-column:1/-1;}
label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;}
input,select,textarea{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:9px 11px;font-family:var(--font);font-size:13px;color:var(--text);outline:none;transition:border-color .12s;width:100%;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
textarea{resize:vertical;min-height:68px;}
.form-section{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);}
.form-section:last-child{border:none;margin:0;padding:0;}
.form-section-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:12px;display:flex;align-items:center;gap:6px;text-transform:uppercase;letter-spacing:.8px;}
/* ‚îÄ‚îÄ WORKFLOW STEPPER ‚îÄ‚îÄ */
.workflow{display:flex;align-items:flex-start;margin:12px 0;overflow-x:auto;padding-bottom:8px;}
.wf-step{flex:1;min-width:100px;text-align:center;position:relative;}
.wf-step-inner{display:flex;flex-direction:column;align-items:center;gap:4px;}
.wf-dot{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;z-index:1;}
.wf-step.done .wf-dot{background:var(--accent2);border-color:var(--accent2);color:#fff;}
.wf-step.active .wf-dot{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 12px rgba(79,124,255,.5);}
.wf-step.rejected .wf-dot{background:var(--accent3);border-color:var(--accent3);color:#fff;}
.wf-label{font-size:9px;color:var(--text3);font-weight:500;}
.wf-step.done .wf-label,.wf-step.active .wf-label{color:var(--text);}
.wf-line{position:absolute;top:13px;left:50%;right:-50%;height:2px;background:var(--border);}
.wf-step.done .wf-line{background:var(--accent2);}
.wf-step:last-child .wf-line{display:none;}
/* ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ */
.detail-grid{display:grid;grid-template-columns:1fr 300px;gap:16px;}
.detail-meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.meta-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:3px;}
.meta-value{font-size:13px;color:var(--text);}
.section-box{background:var(--surface2);border-radius:var(--radius);padding:12px;margin-bottom:10px;}
.section-box-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:6px;}
.section-box p{font-size:13px;line-height:1.6;color:var(--text2);}
/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:16px;}
.tab{padding:9px 16px;font-size:13px;font-weight:500;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .12s;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
/* ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ */
.tl-item{display:flex;gap:10px;margin-bottom:12px;}
.tl-icon{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;}
.tl-header{font-size:13px;font-weight:500;}
.tl-time{font-size:10px;color:var(--text3);font-family:var(--mono);}
.tl-text{font-size:12px;color:var(--text2);margin-top:3px;}
/* ‚îÄ‚îÄ COMMENTS ‚îÄ‚îÄ */
.comment{display:flex;gap:8px;margin-bottom:10px;}
.comment-body{background:var(--surface2);border-radius:var(--radius);padding:9px 12px;flex:1;}
.comment-author{font-size:12px;font-weight:600;}
.comment-time{font-size:10px;color:var(--text3);font-family:var(--mono);}
.comment-text{font-size:13px;color:var(--text2);line-height:1.5;margin-top:3px;}
/* ‚îÄ‚îÄ APPROVAL BAR ‚îÄ‚îÄ */
.approval-bar{background:rgba(79,124,255,.06);border:1px solid rgba(79,124,255,.2);border-radius:var(--radius);padding:10px 14px;display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.approval-text{flex:1;font-size:13px;color:var(--text2);}
/* ‚îÄ‚îÄ CALENDAR PICKER ‚îÄ‚îÄ */
.cal-picker-ov{position:fixed;inset:0;z-index:9999;display:none;}
.cal-picker-ov.open{display:block;}
.cal-picker{position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 24px 64px rgba(0,0,0,.8);width:280px;z-index:10000;max-height:85vh;overflow-y:auto;}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.cal-nav-btn{background:none;border:none;cursor:pointer;color:var(--text2);font-size:18px;padding:4px 8px;border-radius:6px;transition:all .1s;}
.cal-nav-btn:hover{background:var(--surface2);color:var(--text);}
.cal-month-lbl{font-size:13px;font-weight:600;color:var(--text);}
.cal-dow-row{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:6px;}
.cal-dow{font-size:10px;text-align:center;color:var(--text3);font-weight:600;padding:3px 0;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-d{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:12px;border-radius:6px;cursor:pointer;color:var(--text2);transition:all .1s;}
.cal-d:hover{background:var(--surface3);color:var(--text);}
.cal-d.today{background:var(--surface3);color:var(--accent);font-weight:600;}
.cal-d.selected{background:var(--accent);color:#fff;font-weight:600;}
.cal-d.other-month{color:var(--text3);opacity:.4;}
.cal-time-row{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}
.cal-time-lbl{font-size:11px;color:var(--text3);font-weight:600;}
.cal-time-row input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 8px;font-family:var(--mono);font-size:12px;color:var(--text);outline:none;}
.cal-foot{display:flex;gap:8px;margin-top:12px;}
.cal-foot .btn{flex:1;justify-content:center;}
/* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ */
.page{display:none;}
.page.active{display:block;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
/* ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ */
.filter-select{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:5px 9px;font-family:var(--font);font-size:12px;color:var(--text2);}
/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
/* ‚îÄ‚îÄ NOTIF PANEL ‚îÄ‚îÄ */
.notif-panel{position:absolute;top:42px;right:0;width:320px;background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:300;display:none;}
.notif-panel.open{display:block;}
.notif-panel-header{padding:10px 14px;border-bottom:1px solid var(--border);font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center;}
.notif-list{max-height:300px;overflow-y:auto;}
.notif-item{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;cursor:pointer;transition:background .1s;}
.notif-item:hover{background:var(--surface2);}
.notif-item.unread{background:rgba(79,124,255,.04);}
.notif-dot2{width:6px;height:6px;border-radius:50%;background:var(--accent);flex-shrink:0;margin-top:4px;}
.notif-text{font-size:12px;line-height:1.4;}
.notif-time{font-size:10px;color:var(--text3);font-family:var(--mono);margin-top:2px;}
/* ‚îÄ‚îÄ CAB BOARD ‚îÄ‚îÄ */
.cab-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;}
.cab-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all .15s;}
.cab-card:hover{border-color:var(--accent);transform:translateY(-1px);}
.cab-card-id{font-family:var(--mono);font-size:11px;color:var(--accent);margin-bottom:6px;}
.cab-card-title{font-size:13px;font-weight:500;margin-bottom:8px;line-height:1.4;}
.cab-card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;}
.cab-votes{font-size:11px;color:var(--text3);display:flex;gap:10px;}
.vote-yes{color:var(--accent2);}
.vote-no{color:var(--accent3);}
/* ‚îÄ‚îÄ CALENDAR PAGE ‚îÄ‚îÄ */
.cal-header-row{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:6px;}
.cal-hd{font-size:10px;text-align:center;color:var(--text3);font-weight:600;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;border-radius:6px;cursor:pointer;color:var(--text3);transition:all .1s;min-height:60px;}
.cal-day:hover{background:var(--surface3);color:var(--text);}
.cal-day.has-change{background:rgba(79,124,255,.12);color:var(--accent);font-weight:600;}
.cal-day.today{background:var(--accent);color:#fff;font-weight:600;}
.cal-day.freeze-day{background:rgba(192,132,252,.1);color:var(--accent5);}
.cal-pip{width:4px;height:4px;border-radius:50%;margin-top:2px;}
/* ‚îÄ‚îÄ PIPELINE PAGE ‚îÄ‚îÄ */
.pipeline-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
.pipeline-col{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;}
.pipeline-col-title{font-size:12px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.pipeline-col-count{background:var(--surface2);padding:2px 8px;border-radius:10px;font-size:10px;font-family:var(--mono);}
.pipeline-item{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;cursor:pointer;transition:all .12s;}
.pipeline-item:hover{border-color:var(--accent);transform:translateX(2px);}
.pipeline-item-id{font-family:var(--mono);font-size:10px;color:var(--accent);font-weight:600;margin-bottom:4px;}
.pipeline-item-title{font-size:12px;font-weight:500;margin-bottom:6px;}
.pipeline-item-meta{display:flex;gap:6px;font-size:10px;color:var(--text3);}
/* ‚îÄ‚îÄ INCIDENTS ‚îÄ‚îÄ */
.incident-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(255,107,107,.06);border:1px solid rgba(255,107,107,.15);border-radius:var(--radius);margin-bottom:7px;}
.incident-id{font-family:var(--mono);font-size:11px;color:var(--accent3);}
.sev-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:600;}
.sev-p1{background:rgba(255,107,107,.15);color:#ff6b6b;}
.sev-p2{background:rgba(255,169,77,.15);color:#ffa94d;}
.sev-p3{background:rgba(79,124,255,.15);color:#4f7cff;}
.sev-p4{background:rgba(82,88,112,.2);color:var(--text3);}
/* ‚îÄ‚îÄ CMDB ‚îÄ‚îÄ */
.cmdb-item{display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--surface2);border-radius:var(--radius);margin-bottom:8px;}
.cmdb-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.cmdb-name{font-size:13px;font-weight:500;}
.cmdb-type{font-size:11px;color:var(--text3);}
/* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
.settings-grid{display:grid;grid-template-columns:250px 1fr;gap:20px;}
.settings-nav{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px;}
.settings-nav-item{padding:9px 12px;border-radius:6px;cursor:pointer;font-size:13px;color:var(--text2);transition:all .12s;margin-bottom:4px;}
.settings-nav-item:hover{background:var(--surface2);color:var(--text);}
.settings-nav-item.active{background:rgba(79,124,255,.1);color:var(--accent);}
.settings-panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;}
.settings-section{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--border);}
.settings-section:last-child{border:none;margin:0;padding:0;}
.settings-section-title{font-size:13px;font-weight:600;margin-bottom:14px;color:var(--text);}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;}
.setting-label{font-size:13px;color:var(--text2);}
.setting-desc{font-size:11px;color:var(--text3);margin-top:2px;}
/* ‚îÄ‚îÄ ROLE COLORS ‚îÄ‚îÄ */
.role-admin{background:rgba(255,107,107,.12);color:#ff8585;}
.role-change_manager{background:rgba(79,124,255,.12);color:#7b9dff;}
.role-change_requestor{background:rgba(0,212,170,.12);color:#00d4aa;}
.role-env_owner{background:rgba(255,169,77,.12);color:#ffa94d;}
.role-ta{background:rgba(192,132,252,.12);color:#c084fc;}
.role-tester{background:rgba(82,88,112,.2);color:var(--text3);}
/* ‚îÄ‚îÄ FREEZE PERIOD ‚îÄ‚îÄ */
.freeze-period{background:rgba(192,132,252,.06);border:1px solid rgba(192,132,252,.2);border-radius:var(--radius);padding:12px 16px;display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.freeze-icon{font-size:18px;}
.freeze-info{flex:1;}
.freeze-name{font-size:13px;font-weight:600;color:var(--accent5);}
.freeze-dates{font-size:11px;color:var(--text3);font-family:var(--mono);margin-top:2px;}
/* ‚îÄ‚îÄ DEPENDENCIES ‚îÄ‚îÄ */
.dep-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface2);border-radius:var(--radius);margin-bottom:7px;}
.dep-arrow{color:var(--text3);font-size:14px;}
.dep-info{flex:1;}
.dep-id{font-family:var(--mono);font-size:11px;color:var(--accent);}
.dep-title{font-size:12px;color:var(--text2);}
/* ‚îÄ‚îÄ PROMOTE BUTTON ‚îÄ‚îÄ */
.promote-btn{background:rgba(0,212,170,.1);border:1px solid rgba(0,212,170,.25);color:var(--accent2);padding:4px 10px;border-radius:5px;font-size:11px;cursor:pointer;font-family:var(--font);font-weight:500;transition:all .15s;}
.promote-btn:hover{background:rgba(0,212,170,.2);}
/* ‚îÄ‚îÄ DIRECT-TO-PROD TAG ‚îÄ‚îÄ */
.dtp-tag{background:rgba(255,107,107,.1);border:1px solid rgba(255,107,107,.25);border-radius:4px;padding:2px 7px;font-size:10px;color:#ff8585;font-family:var(--mono);}
</style>
</head>
<body>
<div class="app">
<!-- ‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê -->
<nav class="sidebar">
<div class="logo">
<div class="logo-text">ChangeFlow</div>
<div class="logo-sub">Change Management</div>
<div class="logo-ver">v3.0 ‚Äî Enterprise</div>
</div>
<div class="nav" id="sideNav"></div>
<div class="user-area">
<div class="avatar" id="sideAvatar">MA</div>
<div>
<div class="user-name" id="sideName">Marco Albini</div>
<div class="user-role" id="sideRole">Change Manager</div>
</div>
<button class="logout-btn" onclick="doLogout()" title="Esci">‚èª</button>
</div>
</nav>
<!-- ‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê -->
<div class="main">
<!-- Freeze Banner -->
<div class="freeze-banner" id="freezeBanner" style="display:none">
üîí <strong>FREEZE PERIOD ATTIVO:</strong>&nbsp;Fine Anno ‚Äî nessun change su PROD autorizzato
</div>
<div class="topbar">
<div class="page-title" id="pageTitle">Dashboard</div>
<div class="topbar-actions">
<button class="btn btn-ghost btn-sm" id="btnNewChange" onclick="openNewChangeModal()" style="display:none">
<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
Nuovo Change
</button>
<div class="notif-wrap">
<button class="btn btn-ghost btn-sm" onclick="toggleNotif()">üîî</button>
<div class="notif-dot" id="notifDot"></div>
<div class="notif-panel" id="notifPanel">
<div class="notif-panel-header">Notifiche <span style="font-size:10px;color:var(--text3);cursor:pointer" onclick="markAllRead()">Segna tutte lette</span></div>
<div class="notif-list" id="notifList"></div>
</div>
</div>
</div>
</div>
<div class="content">
<!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê -->
<div class="page active" id="page-dashboard"></div>
<!-- ‚ïê‚ïê CHANGES ‚ïê‚ïê -->
<div class="page" id="page-changes"></div>
<!-- ‚ïê‚ïê PIPELINE ‚ïê‚ïê -->
<div class="page" id="page-pipeline"></div>
<!-- ‚ïê‚ïê APPROVALS ‚ïê‚ïê -->
<div class="page" id="page-approvals"></div>
<!-- ‚ïê‚ïê CAB BOARD ‚ïê‚ïê -->
<div class="page" id="page-cab"></div>
<!-- ‚ïê‚ïê CALENDAR ‚ïê‚ïê -->
<div class="page" id="page-calendar"></div>
<!-- ‚ïê‚ïê REPORTS ‚ïê‚ïê -->
<div class="page" id="page-reports"></div>
<!-- ‚ïê‚ïê INCIDENTS ‚ïê‚ïê -->
<div class="page" id="page-incidents"></div>
<!-- ‚ïê‚ïê CMDB ‚ïê‚ïê -->
<div class="page" id="page-cmdb"></div>
<!-- ‚ïê‚ïê SETTINGS ‚ïê‚ïê -->
<div class="page" id="page-settings"></div>
</div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MODAL: NUOVO CHANGE ‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay modal-wide" id="newChangeModal">
<div class="modal">
<div class="modal-header">
<div><div class="modal-title">Nuovo Change Request</div><div class="modal-subtitle">Compila tutti i campi obbligatori</div></div>
<button class="modal-close" onclick="closeModal('newChangeModal')">‚úï</button>
</div>
<div class="modal-body">
<div class="form-section">
<div class="form-section-title">üìã Informazioni Generali</div>
<div class="form-grid">
<div class="form-group full"><label>Titolo *</label><input type="text" id="newTitle" placeholder="Descrizione breve del change..."></div>
<div class="form-group"><label>Tipo Change *</label><select id="newType"><option>Standard</option><option>Normale</option><option>Emergenza</option></select></div>
<div class="form-group"><label>Priorit√† *</label><select id="newPriority"><option>Bassa</option><option>Media</option><option>Alta</option><option>Critica</option></select></div>
<div class="form-group"><label>Categoria CI</label><select id="newCategory"><option>Database</option><option>Network</option><option>Server</option><option>Applicazioni</option><option>Storage</option><option>Security</option></select></div>
<div class="form-group"><label>Assegnato a</label><select id="newAssignee"></select></div>
<div class="form-group full"><label>Descrizione *</label><textarea id="newDesc" placeholder="Descrizione dettagliata, motivazione, sistemi impattati..."></textarea></div>
</div>
</div>
<div class="form-section">
<div class="form-section-title">üîó Incidenti Correlati</div>
<div class="form-group full">
<label>Collega Incidenti (opzionale)</label>
<select id="newIncidents" multiple style="min-height:80px"></select>
<div style="font-size:11px;color:var(--text3);margin-top:4px">Tieni premuto Ctrl/Cmd per selezionare pi√π incidenti</div>
</div>
</div>
<div class="form-section">
<div class="form-section-title">üåç Pipeline Ambienti</div>
<div class="form-grid">
<div class="form-group">
<label>Strategia Deployment</label>
<select id="newPipelineStrategy" onchange="updatePipelinePreview()">
<option value="full">Completo: DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD</option>
<option value="skip-dev">Skip DEV: INTEG ‚Üí CERT ‚Üí PROD</option>
<option value="direct">Direct to PROD (solo Emergenza)</option>
</select>
</div>
<div class="form-group full">
<label>Anteprima Pipeline</label>
<div id="pipelinePreview" style="background:var(--surface2);border-radius:8px;padding:9px 11px;display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:12px;color:var(--text2)">DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD</div>
</div>
</div>
</div>
<div class="form-section">
<div class="form-section-title">üõ° Valutazione Rischio</div>
<div class="form-grid">
<div class="form-group"><label>Livello di Rischio</label><select id="newRisk"><option>Basso</option><option>Medio</option><option>Alto</option><option>Critico</option></select></div>
<div class="form-group"><label>Impatto</label><select id="newImpact"><option>Basso</option><option>Medio</option><option>Alto</option></select></div>
<div class="form-group full"><label>Piano di Rollback</label><textarea id="newRollback" placeholder="Procedure di rollback in caso di fallimento..."></textarea></div>
<div class="form-group full"><label>Test Plan</label><textarea id="newTest" placeholder="Come verr√† verificato il corretto completamento..."></textarea></div>
</div>
</div>
<div class="form-section">
<div class="form-section-title">üìÖ Pianificazione</div>
<div class="form-grid">
<div class="form-group"><label>Data Inizio Prevista</label><input type="text" id="newStart" placeholder="Clicca per selezionare data..." readonly style="cursor:pointer" onclick="openCalPicker('newStart',event)"></div>
<div class="form-group"><label>Data Fine Prevista</label><input type="text" id="newEnd" placeholder="Clicca per selezionare data..." readonly style="cursor:pointer" onclick="openCalPicker('newEnd',event)"></div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-ghost" onclick="closeModal('newChangeModal')">Annulla</button>
<button class="btn btn-primary" onclick="submitNewChange()">‚úì Invia Change Request</button>
</div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MODAL: DETTAGLIO ‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay modal-xl" id="detailModal">
<div class="modal">
<div class="modal-header">
<div style="flex:1">
<div class="modal-title" id="detailTitle"></div>
<div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap" id="detailBadges"></div>
</div>
<button class="modal-close" onclick="closeModal('detailModal')">‚úï</button>
</div>
<div class="modal-body">
<div class="workflow" id="detailWorkflow"></div>
<div id="approvalBar" style="display:none" class="approval-bar">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
<div class="approval-text">In attesa di approvazione <strong>CAB</strong></div>
<button class="btn btn-success btn-sm" onclick="approveChange()">‚úì Approva</button>
<button class="btn btn-danger btn-sm" onclick="rejectChange()">‚úï Rifiuta</button>
</div>
<div class="tabs">
<div class="tab active" onclick="switchTab(this,'tab-detail')">Dettagli</div>
<div class="tab" onclick="switchTab(this,'tab-pipeline')">Pipeline</div>
<div class="tab" onclick="switchTab(this,'tab-deps')">Dipendenze</div>
<div class="tab" onclick="switchTab(this,'tab-incidents')">Incidenti</div>
<div class="tab" onclick="switchTab(this,'tab-activity')">Attivit√†</div>
<div class="tab" onclick="switchTab(this,'tab-comments')">Commenti</div>
</div>
<div id="tab-detail"></div>
<div id="tab-pipeline" style="display:none"></div>
<div id="tab-deps" style="display:none"></div>
<div id="tab-incidents" style="display:none"></div>
<div id="tab-activity" style="display:none"></div>
<div id="tab-comments" style="display:none"></div>
</div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MODAL: INCIDENTE ‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="incidentModal">
<div class="modal">
<div class="modal-header">
<div><div class="modal-title">Nuovo Incidente</div><div class="modal-subtitle">Registra un nuovo incidente</div></div>
<button class="modal-close" onclick="closeModal('incidentModal')">‚úï</button>
</div>
<div class="modal-body">
<div class="form-group full"><label>Titolo *</label><input type="text" id="incTitle" placeholder="Descrizione breve incidente..."></div>
<div class="form-grid">
<div class="form-group"><label>Severit√†</label><select id="incSev"><option value="P1">P1 - Critica</option><option value="P2">P2 - Alta</option><option value="P3">P3 - Media</option><option value="P4">P4 - Bassa</option></select></div>
<div class="form-group"><label>Stato</label><select id="incStatus"><option>Aperto</option><option>In Lavorazione</option><option>In Attesa</option><option>Risolto</option><option>Chiuso</option></select></div>
</div>
<div class="form-grid">
<div class="form-group"><label>Categoria</label><select id="incCat"><option>Database</option><option>Network</option><option>Server</option><option>Applicazioni</option><option>Security</option></select></div>
<div class="form-group"><label>Assegnato a</label><select id="incAssignee"></select></div>
</div>
<div class="form-group full"><label>Descrizione</label><textarea id="incDesc" placeholder="Descrizione dettagliata..."></textarea></div>
</div>
<div class="modal-footer">
<button class="btn btn-ghost" onclick="closeModal('incidentModal')">Annulla</button>
<button class="btn btn-primary" onclick="submitIncident()">üíæ Crea Incidente</button>
</div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MODAL: CI ‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="ciModal">
<div class="modal">
<div class="modal-header">
<div><div class="modal-title">Aggiungi Configuration Item</div><div class="modal-subtitle">CMDB ‚Äî Configuration Management Database</div></div>
<button class="modal-close" onclick="closeModal('ciModal')">‚úï</button>
</div>
<div class="modal-body">
<div class="form-grid">
<div class="form-group"><label>Nome CI *</label><input type="text" id="ciName" placeholder="es. db-prod-01"></div>
<div class="form-group"><label>Tipo</label><select id="ciType"><option>Server</option><option>Database</option><option>Network</option><option>Application</option><option>Storage</option><option>Security</option></select></div>
<div class="form-group"><label>Ambiente</label><select id="ciEnv"><option>DEV</option><option>INTEG</option><option>CERT</option><option>PROD</option></select></div>
</div>
<div class="form-grid">
<div class="form-group"><label>Owner</label><select id="ciOwner"></select></div>
<div class="form-group"><label>Stato</label><select id="ciStatus"><option>Operational</option><option>Maintenance</option><option>Decommissioned</option></select></div>
<div class="form-group"><label>Versione</label><input type="text" id="ciVersion" placeholder="es. 2.4.1"></div>
</div>
<div class="form-group full"><label>Note</label><textarea id="ciNotes" placeholder="Informazioni aggiuntive..."></textarea></div>
</div>
<div class="modal-footer">
<button class="btn btn-ghost" onclick="closeModal('ciModal')">Annulla</button>
<button class="btn btn-primary" onclick="submitCI()">üíæ Salva CI</button>
</div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê CALENDAR PICKER OVERLAY ‚ïê‚ïê‚ïê‚ïê -->
<div class="cal-picker-ov" id="calPickerOv" onclick="closeCalPickerIfOutside(event)">
<div class="cal-picker" id="calPicker">
<div class="cal-nav">
<button class="cal-nav-btn" onclick="calNavMonth(-1)">‚ùÆ</button>
<div class="cal-month-lbl" id="calMonthLbl"></div>
<button class="cal-nav-btn" onclick="calNavMonth(1)">‚ùØ</button>
</div>
<div class="cal-dow-row">
<div class="cal-dow">Lun</div><div class="cal-dow">Mar</div><div class="cal-dow">Mer</div>
<div class="cal-dow">Gio</div><div class="cal-dow">Ven</div><div class="cal-dow">Sab</div><div class="cal-dow">Dom</div>
</div>
<div class="cal-days" id="calDays"></div>
<div class="cal-time-row">
<span class="cal-time-lbl">Ora:</span>
<input type="time" id="calTime" value="09:00">
</div>
<div class="cal-foot">
<button class="btn btn-ghost btn-sm" onclick="closeCalPicker()">Annulla</button>
<button class="btn btn-primary btn-sm" onclick="confirmCalPicker()">Conferma</button>
</div>
</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG & CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LS_CHANGES = 'cf_changes_v3';
const LS_INCIDENTS = 'cf_incidents_v3';
const LS_CMDB = 'cf_cmdb_v3';
const LS_NOTIFS = 'cf_notifs_v3';
const LS_FREEZES = 'cf_freezes_v3';
const LS_SETTINGS = 'cf_settings_v3';
const LS_USER = 'cf_current_user';

const ENVS = ['DEV','INTEG','CERT','PROD'];
const ENV_COLORS = {DEV:'#4f7cff',INTEG:'#ffa94d',CERT:'#c084fc',PROD:'#00d4aa'};
const ROLE_LABELS = {admin:'Admin', change_manager:'Change Manager', change_requestor:'Requestor', env_owner:'Env Owner', ta:'Technical Analyst', tester:'Tester'};
const STATUS_ORDER = ['Aperto','In Review','Approvato','Schedulato','Implementazione','Chiuso','Rifiutato'];
const STATUS_WF_IDX = Object.fromEntries(STATUS_ORDER.map((s,i)=>[s,i]));
const WF_STEPS = ['Aperto','In Review','Approvato','Schedulato','Implementazione','Chiuso'];

const TRANSITIONS = {
'Aperto': [{to:'In Review', label:'Invia in Review', roles:['change_requestor','change_manager','admin']}],
'In Review': [{to:'Approvato', label:'Approva', roles:['change_manager','admin']},{to:'Rifiutato', label:'Rifiuta', roles:['change_manager','admin']}],
'Approvato': [{to:'Schedulato', label:'Pianifica', roles:['change_manager','admin']}],
'Schedulato': [{to:'Implementazione', label:'Autorizza Esecuzione', roles:['env_owner','admin']}],
'Implementazione': [{to:'Chiuso', label:'Chiudi (Successo)', roles:['ta','tester','admin']}],
'Chiuso': [],
'Rifiutato': [{to:'Aperto', label:'Riapri', roles:['change_requestor','change_manager','admin']}]
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const USERS_FALLBACK = [
{id:'u1', name:'Mario Albini', username:'malbini', password:'demo', role:'admin', team:'Infra', initials:'MA'},
{id:'u2', name:'Laura Bianchi', username:'lbianchi', password:'demo', role:'change_manager', team:'Change', initials:'LB'},
{id:'u3', name:'Giuseppe Rossi', username:'grossi', password:'demo', role:'change_requestor', team:'Dev', initials:'GR'},
{id:'u4', name:'Anna Verdi', username:'averdi', password:'demo', role:'env_owner', team:'ProdOps', initials:'AV'},
{id:'u5', name:'Marco Neri', username:'mneri', password:'demo', role:'ta', team:'Infra', initials:'MN'},
{id:'u6', name:'Sofia Colombo', username:'scolombo', password:'demo', role:'tester', team:'QA', initials:'SC'}
];
let USERS = [...USERS_FALLBACK];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEFAULT DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CHANGES_DEFAULT = [
{id:'CHG-2025-001', title:'Aggiornamento firewall regole DMZ', type:'Normale', priority:'Alta', status:'In Review', requesterId:'u3', assigneeId:'u5', category:'Security', risk:'Medio', impact:'Alto', opened:'2025-02-10', window:'2025-02-20 22:00', windowEnd:'2025-02-20 23:30', pipeline:['done','active','pending','pending'], pipelineStrategy:'full', currentEnv:1, incidentIds:[], desc:'Aggiornamento regole firewall per nuova applicazione in DMZ.', rollback:'Ripristino configurazione precedente da backup.', test:'Verifica connettivit√† applicazione.', comments:[], history:[{action:'Change aperto', userId:'u3', time:'2025-02-10 14:30'}]}
];

const INCIDENTS_DEFAULT = [
{id:'INC-2025-001', title:'Performance degradation database Oracle', severity:'P1', status:'In Lavorazione', category:'Database', assigneeId:'u5', reporterId:'u3', opened:'2025-02-09', description:'Lentezza query critiche su db-prod-01', relatedChanges:[]},
{id:'INC-2025-002', title:'Errore connessione applicazione', severity:'P2', status:'Aperto', category:'Applicazioni', assigneeId:'u5', reporterId:'u4', opened:'2025-02-11', description:'Timeout connessione microservizio fatturazione', relatedChanges:[]}
];

const CMDB_DEFAULT = [
{id:'ci1', name:'db-prod-oracle-01', type:'Database', env:'PROD', ownerId:'u4', status:'Operational', version:'19c'},
{id:'ci2', name:'fw-dmz-primary', type:'Security', env:'PROD', ownerId:'u5', status:'Operational', version:'7.2.1'},
{id:'ci3', name:'app-invoice-svc', type:'Application', env:'PROD', ownerId:'u3', status:'Operational', version:'3.4.2'}
];

const FREEZES_DEFAULT = [
{id:'f1', name:'Fine Anno 2025', start:'2025-12-20', end:'2026-01-05', envs:['PROD'], active:false},
{id:'f2', name:'Black Friday 2025', start:'2025-11-25', end:'2025-11-29', envs:['PROD','CERT'], active:false}
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;
let changes = [];
let incidents = [];
let cmdbItems = [];
let freezes = [];
let notifications = [];
let currentChangeId = null;
let settings = {emailNotifications: true, requireCABApproval: true, defaultPipeline: 'full', workingHours: {start:'09:00', end:'18:00'}};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
function loadData(key, fallback) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : fallback; } catch { return fallback; } }
function userInitials(uid) { const u = USERS.find(x=>x.id===uid); return u?.initials || '?'; }
function userName(uid) { const u = USERS.find(x=>x.id===uid); return u?.name || 'Sconosciuto'; }
function canDo(roles) { return currentUser && roles.includes(currentUser.role); }

function sBadge(s) {
const cls = {Aperto:'badge-open','In Review':'badge-review',Approvato:'badge-approved',Schedulato:'badge-scheduled',Implementazione:'badge-implementing',Chiuso:'badge-closed',Rifiutato:'badge-rejected'}[s]||'badge-closed';
return `<span class="badge ${cls}">${s}</span>`;
}
function pBadge(p) {
const cls = {Bassa:'priority-low',Media:'priority-medium',Alta:'priority-high',Critica:'priority-critical'}[p]||'priority-medium';
return `<span class="priority ${cls}">${p}</span>`;
}
function sevBadge(s) {
const cls = {P1:'sev-p1',P2:'sev-p2',P3:'sev-p3',P4:'sev-p4'}[s]||'sev-p4';
return `<span class="sev-badge ${cls}">${s}</span>`;
}
function rBadge(r) {
const col = {Basso:'var(--accent2)',Medio:'var(--accent4)',Alto:'var(--accent3)',Critico:'#ff4757'}[r]||'var(--text3)';
return `<span style="font-size:12px;color:${col}">‚óè ${r}</span>`;
}
function envInline(c) {
const idx = c.currentEnv ?? 0;
return `<div class="env-inline">${ENVS.map((e,i)=>`<span class="env-pip" style="background:${i<idx?'var(--accent2)':i===idx?'var(--accent)':'var(--surface3)'};color:${i<=idx?'#fff':'var(--text3)'}">${e.charAt(0)}</span>${i<3?'<span class="env-arrow-sm">‚Ä∫</span>':''}`).join('')}</div>`;
}
function incBadge(status) {
const colors = {Aperto:'#ff6b6b','In Lavorazione':'#4f7cff','In Attesa':'#ffa94d',Risolto:'#00d4aa',Chiuso:'#525870'};
return `<span style="font-size:11px;padding:2px 7px;border-radius:4px;background:${colors[status]||'#525870'}20;color:${colors[status]||'#525870'}">${status}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN / LOGOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initLogin() {
const saved = localStorage.getItem(LS_USER);
if(saved) {
try {
const u = JSON.parse(saved);
const valid = USERS.find(x=>x.username===u.username && x.password===u.password);
if(valid) { currentUser = valid; showApp(); return; }
} catch {}
}
currentUser = USERS[0];
showApp();
}

function doLogout() {
currentUser = null;
localStorage.removeItem(LS_USER);
location.reload();
}

function showApp() {
document.getElementById('sideName').textContent = currentUser.name;
document.getElementById('sideRole').textContent = ROLE_LABELS[currentUser.role];
document.getElementById('sideAvatar').textContent = currentUser.initials;

const btnNewChange = document.getElementById('btnNewChange');
if(btnNewChange) {
const allowedRoles = ['change_requestor', 'change_manager', 'admin'];
btnNewChange.style.display = allowedRoles.includes(currentUser.role) ? 'inline-flex' : 'none';
}

changes = loadData(LS_CHANGES, [...CHANGES_DEFAULT]);
incidents = loadData(LS_INCIDENTS, [...INCIDENTS_DEFAULT]);
cmdbItems = loadData(LS_CMDB, [...CMDB_DEFAULT]);
freezes = loadData(LS_FREEZES, [...FREEZES_DEFAULT]);
notifications = loadData(LS_NOTIFS, []);
settings = loadData(LS_SETTINGS, settings);

checkFreezeBanner();
renderNav();
renderNotifList();
updateBadges();
showPage('dashboard', document.getElementById('nav-dashboard'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderNav() {
const nav = document.getElementById('sideNav');
const items = [
{sect:'PRINCIPALE'},
{id:'dashboard', icon:'üìä', label:'Dashboard'},
{id:'changes', icon:'üîÑ', label:'Tutti i Change', badge:'open'},
{id:'pipeline', icon:'üåê', label:'Pipeline Ambienti'},
{id:'approvals', icon:'‚è±', label:'Approvazioni', roles:['change_manager','admin'], badge:'approvals'},
{id:'cab', icon:'üë•', label:'CAB Board', roles:['change_manager','admin','env_owner'], badge:'cab'},
{id:'calendar', icon:'üìÖ', label:'Calendario & Freeze'},
{sect:'ANALISI'},
{id:'reports', icon:'üìà', label:'Report & Analytics', roles:['change_manager','admin']},
{id:'incidents', icon:'‚ö†Ô∏è', label:'Incidenti Correlati', badge:'incidents'},
{sect:'CONFIGURAZIONE'},
{id:'cmdb', icon:'üóÑ', label:'CMDB'},
{id:'settings', icon:'‚öôÔ∏è', label:'Impostazioni', roles:['admin']}
];

nav.innerHTML = items.map(it=>{
if(it.sect) return `<div class="nav-section">${it.sect}</div>`;
if(it.roles && !it.roles.includes(currentUser.role)) return '';
const badge = it.badge ? `<span class="nav-badge ${it.badge==='incidents'?'red':it.badge==='cab'?'green':'orange'}" id="badge-${it.badge}" style="display:none">0</span>` : '';
return `<div class="nav-item" id="nav-${it.id}" onclick="showPage('${it.id}',this)"><span class="nav-icon">${it.icon}</span> ${it.label}${badge}</div>`;
}).join('');
}

function showPage(pageId, navEl) {
document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
document.getElementById(`page-${pageId}`).classList.add('active');
document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
if(navEl) navEl.classList.add('active');

const titles = {dashboard:'Dashboard', changes:'Tutti i Change', pipeline:'Pipeline Ambienti', approvals:'Approvazioni', cab:'CAB Board', calendar:'Calendario & Freeze', reports:'Report & Analytics', incidents:'Incidenti Correlati', cmdb:'CMDB', settings:'Impostazioni'};
document.getElementById('pageTitle').textContent = titles[pageId] || 'ChangeFlow';

if(pageId==='dashboard') renderDashboard();
if(pageId==='changes') renderChanges();
if(pageId==='pipeline') renderPipeline();
if(pageId==='approvals') renderApprovals();
if(pageId==='cab') renderCAB();
if(pageId==='calendar') renderCalendar();
if(pageId==='reports') renderReports();
if(pageId==='incidents') renderIncidents();
if(pageId==='cmdb') renderCMDB();
if(pageId==='settings') renderSettings();
}

function updateBadges() {
const open = changes.filter(c=>c.status==='Aperto').length;
const appr = changes.filter(c=>c.status==='In Review').length;
const cab = changes.filter(c=>c.status==='Approvato' || c.status==='Schedulato').length;
const inc = incidents.filter(i=>i.status!=='Chiuso').length;

const badges = {open, approvals:appr, cab, incidents:inc};
Object.entries(badges).forEach(([key,val])=>{
const el = document.getElementById(`badge-${key}`);
if(el) { el.textContent = val; el.style.display = val>0?'inline-block':'none'; }
});
}

function checkFreezeBanner() {
const now = new Date().toISOString().split('T')[0];
const activeFreeze = freezes.find(f=>f.start<=now && f.end>=now && f.envs.includes('PROD'));
const banner = document.getElementById('freezeBanner');
if(banner) banner.style.display = activeFreeze ? 'flex' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
const vc = changes;
const byStatus = Object.fromEntries(STATUS_ORDER.map(s=>[s, vc.filter(c=>c.status===s).length]));
const stats = [
{n:byStatus['Aperto']||0, l:'Aperti', t:'Da prendere in carico', c:'#ff6b6b', cls:'s-open'},
{n:byStatus['In Review']||0, l:'In Review', t:'In attesa di approvazione', c:'#4f7cff', cls:'s-review'},
{n:byStatus['Schedulato']||0, l:'Schedulati', t:'In pianificazione', c:'#ffa94d', cls:'s-impl'},
{n:byStatus['Implementazione']||0, l:'In Esecuzione', t:'Change attivi', c:'#ffa94d', cls:'s-impl'},
{n:byStatus['Chiuso']||0, l:'Chiusi', t:'Completati con successo', c:'#00d4aa', cls:'s-ok'}
];

document.getElementById('page-dashboard').innerHTML = `
<div class="stats-grid">
${stats.map(st=>`<div class="stat-card ${st.cls}" onclick="filterAndShow('${st.l.replace(' ','')}')"><div class="stat-number">${st.n}</div><div class="stat-label">${st.l}</div><div class="stat-trend">${st.t}</div></div>`).join('')}
</div>
<div class="table-wrap">
<div class="table-header"><div class="table-title">Change Recenti</div></div>
<table><thead><tr><th>ID</th><th>Titolo</th><th>Tipo</th><th>Priorit√†</th><th>Stato</th><th>Richiedente</th><th>Ambiente</th></tr></thead>
<tbody id="dashboardTable">
${vc.slice(0,10).map(c=>`<tr onclick="openDetail('${c.id}')" style="cursor:pointer"><td><span class="change-id">${c.id}</span></td><td style="font-weight:500">${c.title}</td><td><span class="type-badge">${c.type}</span></td><td>${pBadge(c.priority)}</td><td>${sBadge(c.status)}</td><td style="color:var(--text2)">${userName(c.requesterId)}</td><td>${envInline(c)}</td></tr>`).join('')}
</tbody></table>
</div>`;
}

function filterAndShow(status) {
showPage('changes', document.getElementById('nav-changes'));
setTimeout(()=>{ document.getElementById('filterStatus').value=status; filterChanges(); },50);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANGES LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderChanges() {
const vc = changes.filter(c=> canDo(['admin','change_manager']) || c.requesterId===currentUser.id || c.assigneeId===currentUser.id);
document.getElementById('page-changes').innerHTML = `
<div class="table-wrap">
<div class="table-header">
<div class="table-title">Tutti i Change (${vc.length})</div>
<div class="search-bar"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Cerca..." id="searchInput" oninput="filterChanges()"></div>
<select class="filter-select" id="filterStatus" onchange="filterChanges()"><option value="">Tutti gli stati</option>${STATUS_ORDER.map(s=>`<option>${s}</option>`).join('')}</select>
</div>
<table><thead><tr><th>ID</th><th>Titolo</th><th>Tipo</th><th>Priorit√†</th><th>Stato</th><th>Richiedente</th><th>Assegnato</th><th>Incidenti</th><th>Azioni</th></tr></thead>
<tbody id="changesTable">
${vc.map(c=>`<tr><td><span class="change-id">${c.id}</span></td><td style="font-weight:500">${c.title}</td><td><span class="type-badge">${c.type}</span></td><td>${pBadge(c.priority)}</td><td>${sBadge(c.status)}</td><td style="color:var(--text2)">${userName(c.requesterId)}</td><td style="color:var(--text2)">${userName(c.assigneeId)}</td><td>${c.incidentIds?.length?`<span style="font-family:var(--mono);font-size:11px;color:var(--accent3)">${c.incidentIds.length}</span>`:'-'}</td><td><button class="btn btn-ghost btn-xs" onclick="openDetail('${c.id}')">Dettaglio</button></td></tr>`).join('')}
</tbody></table>
</div>`;
}

function filterChanges() {
const s = document.getElementById('searchInput')?.value.toLowerCase() || '';
const st = document.getElementById('filterStatus')?.value || '';
const rows = document.getElementById('changesTable')?.querySelectorAll('tr') || [];
rows.forEach(r=>{
const txt = r.textContent.toLowerCase();
const matchSearch = !s || txt.includes(s);
const matchStatus = !st || txt.includes(st.toLowerCase());
r.style.display = matchSearch && matchStatus ? '' : 'none';
});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIPELINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPipeline() {
const byEnv = {DEV: changes.filter(c=>c.currentEnv===0 && c.status!=='Chiuso'), INTEG: changes.filter(c=>c.currentEnv===1 && c.status!=='Chiuso'), CERT: changes.filter(c=>c.currentEnv===2 && c.status!=='Chiuso'), PROD: changes.filter(c=>c.currentEnv===3 && c.status!=='Chiuso')};

document.getElementById('page-pipeline').innerHTML = `
<div class="pipeline-grid">
${['DEV','INTEG','CERT','PROD'].map(env=>`<div class="pipeline-col"><div class="pipeline-col-title"><span style="width:8px;height:8px;border-radius:50%;background:${env==='PROD'?'var(--accent3)':'var(--accent2)'}"></span>${env}<span class="pipeline-col-count">${byEnv[env].length}</span></div>${byEnv[env].map(c=>`<div class="pipeline-item" onclick="openDetail('${c.id}')"><div class="pipeline-item-id">${c.id}</div><div class="pipeline-item-title">${c.title}</div><div class="pipeline-item-meta"><span>${pBadge(c.priority)}</span><span>‚Ä¢</span><span>${userName(c.assigneeId)}</span></div></div>`).join('')||'<div style="color:var(--text3);font-size:12px;text-align:center;padding:20px">Nessun change</div>'}</div>`).join('')}
</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPROVALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderApprovals() {
const vc = changes.filter(c=> c.status==='In Review' && canDo(['change_manager','admin']));
document.getElementById('page-approvals').innerHTML = `
<div class="table-wrap">
<div class="table-header"><div class="table-title">In attesa di approvazione (${vc.length})</div></div>
<table><thead><tr><th>ID</th><th>Titolo</th><th>Richiedente</th><th>Rischio</th><th>Impatto</th><th>Azioni</th></tr></thead>
<tbody>${vc.length? vc.map(c=>`<tr><td><span class="change-id">${c.id}</span></td><td>${c.title}</td><td>${userName(c.requesterId)}</td><td>${rBadge(c.risk)}</td><td>${rBadge(c.impact)}</td><td><button class="btn btn-success btn-xs" onclick="quickTransition('${c.id}','Approvato')">‚úÖ Approva</button><button class="btn btn-danger btn-xs" onclick="quickTransition('${c.id}','Rifiutato')">‚ùå Rifiuta</button></td></tr>`).join(''):`<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:20px">Nessun change in attesa</td></tr>`}</tbody></table>
</div>`;
}

function quickTransition(id, toStatus) {
doTransition(id, toStatus);
renderApprovals();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAB BOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const cabVotes = {};
function renderCAB() {
const vc = changes.filter(c=> ['Approvato','Schedulato'].includes(c.status));
document.getElementById('page-cab').innerHTML = `
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-size:16px;font-weight:600">CAB Board ‚Äî Change Advisory Board</div><div style="color:var(--text3);font-size:13px">${vc.length} change in revisione</div></div>
${vc.map(c=>`<div class="cab-card" onclick="openDetail('${c.id}')"><div class="cab-card-id">${c.id}</div><div class="cab-card-title">${c.title}</div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">${statusBadge(c.status)} ${pBadge(c.priority)} ${rBadge(c.risk)}</div><div class="cab-card-footer"><div class="cab-votes"><span class="vote-yes">‚úì ${Object.values(cabVotes[c.id]||{}).filter(v=>v==='yes').length}</span><span class="vote-no">‚úï ${Object.values(cabVotes[c.id]||{}).filter(v=>v==='no').length}</span></div><div style="display:flex;gap:5px"><button class="btn btn-success btn-xs" onclick="event.stopPropagation();cabVote('${c.id}','yes')">‚úì</button><button class="btn btn-danger btn-xs" onclick="event.stopPropagation();cabVote('${c.id}','no')">‚úï</button></div></div></div>`).join('')||'<div class="card" style="text-align:center;color:var(--text3);padding:40px">Nessun change in CAB</div>'}`;
}

function cabVote(id, vote) {
if(!cabVotes[id]) cabVotes[id]={sara:null,luigi:null};
cabVotes[id].sara = vote;
renderCAB();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCalendar() {
const today = new Date();
const month = today.toLocaleString('it-IT',{month:'long', year:'numeric'}).replace(/^\w/,c=>c.toUpperCase());
const days = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];

let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-size:16px;font-weight:600">${month}</div><div style="display:flex;gap:8px;align-items:center"><label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer"><input type="checkbox" id="showFreezes" checked onchange="renderCalendar()" style="width:14px;height:14px"> Mostra Freeze</label>${canDo(['admin'])?`<button class="btn btn-primary btn-sm" onclick="openFreezeModal()">+ Aggiungi Freeze</button>`:''}</div></div><div class="cal-header-row">${days.map(d=>`<div class="cal-hd">${d}</div>`).join('')}</div><div class="cal-grid">`;

const showFreezes = document.getElementById('showFreezes')?.checked ?? true;
for(let i=1;i<=42;i++) {
const dayNum = i - (today.getDay()===0?6:today.getDay()-1);
const dateStr = dayNum>0 ? `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}` : '';
const hasChg = changes.some(c=> c.window && c.window.startsWith(dateStr));
const isFreeze = showFreezes && freezes.some(f=>f.start<=dateStr && f.end>=dateStr);
const isToday = dayNum===today.getDate() && i>=(today.getDay()===0?7:today.getDay()) && i<=(today.getDay()===0?7:today.getDay())+31;
html += `<div class="cal-day ${hasChg?'has-change':''} ${isFreeze?'freeze-day':''} ${isToday?'today':''}">${dayNum>0&&dayNum<=31?dayNum:''}${hasChg?'<div class="cal-pip" style="background:var(--accent)"></div>':''}${isFreeze?'<div style="font-size:8px;margin-top:2px">‚ùÑÔ∏è</div>':''}</div>`;
}
html += `</div>`;

document.getElementById('page-calendar').innerHTML = `
<div class="card" style="margin-bottom:16px"><div class="card-title">Change Pianificati</div>${changes.filter(c=>c.window).slice(0,5).map(c=>`<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:13px;font-weight:500">${c.title}</div><div style="font-size:11px;color:var(--text3);font-family:var(--mono)">${c.window} ‚Üí ${c.windowEnd||'TBD'}</div></div><div style="display:flex;align-items:center;gap:8px">${sBadge(c.status)}<button class="btn btn-ghost btn-xs" onclick="openDetail('${c.id}')">‚Üí</button></div></div>`).join('')||'<div style="color:var(--text3);font-size:13px">Nessun change pianificato</div>'}</div>
<div class="card" style="margin-bottom:16px"><div class="card-title">Periodi di Freeze</div>${freezes.map(f=>`<div class="freeze-period"><div class="freeze-icon">‚ùÑÔ∏è</div><div class="freeze-info"><div class="freeze-name">${f.name}</div><div class="freeze-dates">${f.start} ‚Üí ${f.end}</div></div><span class="badge badge-freeze">${f.envs.join(', ')}</span></div>`).join('')||'<div style="color:var(--text3);font-size:13px">Nessun periodo di freeze configurato</div>'}</div>
${html}`;
}

function openFreezeModal() {
const name = prompt('Nome periodo di freeze (es. "Black Friday 2025"):');
if(!name) return;
const start = prompt('Data inizio (YYYY-MM-DD):');
if(!start) return;
const end = prompt('Data fine (YYYY-MM-DD):');
if(!end) return;
const envs = prompt('Ambienti (separati da virgola, es. PROD,CERT):','PROD');
freezes.push({id:'f'+Date.now(), name, start, end, envs:envs.split(',').map(e=>e.trim().toUpperCase()), active:true});
saveData(LS_FREEZES, freezes);
renderCalendar();
checkFreezeBanner();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INCIDENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderIncidents() {
document.getElementById('page-incidents').innerHTML = `
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-size:16px;font-weight:600">Incidenti Correlati</div><button class="btn btn-primary btn-sm" onclick="openModal('incidentModal')">+ Nuovo Incidente</button></div>
<div class="table-wrap">
<div class="table-header"><div class="table-title">Tutti gli Incidenti (${incidents.length})</div></div>
<table><thead><tr><th>ID</th><th>Titolo</th><th>Severit√†</th><th>Stato</th><th>Categoria</th><th>Assegnato</th><th>Change Correlati</th></tr></thead>
<tbody id="incidentsTable">${incidents.map(inc=>`<tr><td><span style="font-family:var(--mono);font-size:12px;color:var(--accent3)">${inc.id}</span></td><td style="font-weight:500">${inc.title}</td><td>${sevBadge(inc.severity)}</td><td>${incBadge(inc.status)}</td><td><span class="type-badge">${inc.category}</span></td><td style="color:var(--text2)">${userName(inc.assigneeId)}</td><td>${inc.relatedChanges?.length?`<span style="font-family:var(--mono);font-size:11px;color:var(--accent)">${inc.relatedChanges.length}</span>`:'-'}</td></tr>`).join('')}</tbody></table>
</div>`;
}

function submitIncident() {
const title = document.getElementById('incTitle')?.value?.trim();
if(!title) { alert('Inserisci il titolo'); return; }
const num = String(incidents.length+1).padStart(3,'0');
const inc = {id: `INC-${new Date().getFullYear()}-${num}`, title, severity: document.getElementById('incSev')?.value||'P3', status: document.getElementById('incStatus')?.value||'Aperto', category: document.getElementById('incCat')?.value||'Applicazioni', assigneeId: document.getElementById('incAssignee')?.value||currentUser.id, reporterId: currentUser.id, opened: new Date().toISOString().split('T')[0], description: document.getElementById('incDesc')?.value||'', relatedChanges: []};
incidents.unshift(inc);
saveData(LS_INCIDENTS, incidents);
addNotification(`Nuovo incidente ${inc.id} creato: "${title}"`);
closeModal('incidentModal');
['incTitle','incDesc'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
renderIncidents();
updateBadges();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReports() {
if(!canDo(['admin','change_manager'])){ document.getElementById('page-reports').innerHTML='<div class="access-denied"><div class="icon">üîí</div><h3>Accesso non autorizzato</h3></div>'; return; }
const vc = changes;
const total = vc.length;
const closed = vc.filter(c=>c.status==='Chiuso').length;
const byStatus = Object.fromEntries(STATUS_ORDER.map(s=>[s, vc.filter(c=>c.status===s).length]));

document.getElementById('page-reports').innerHTML = `
<div class="stats-grid" style="grid-template-columns:repeat(4,1fr)">
<div class="stat-card s-ok"><div class="stat-number">${total}</div><div class="stat-label">Totali</div></div>
<div class="stat-card s-open"><div class="stat-number">${vc.filter(c=>c.status==='Aperto').length}</div><div class="stat-label">Aperti</div></div>
<div class="stat-card s-ok"><div class="stat-number">${closed}</div><div class="stat-label">Chiusi</div></div>
<div class="stat-card s-ok"><div class="stat-number">${total?Math.round(closed/total*100):0}%</div><div class="stat-label">Success Rate</div></div>
</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CMDB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CI_ICONS={Network:'üåê',Database:'üóÑ',Server:'üñ•',Application:'üì¶',Storage:'üíæ',Security:'üîí'};
function renderCMDB() {
document.getElementById('page-cmdb').innerHTML=`
<div style="display:grid;grid-template-columns:1fr 280px;gap:16px">
<div class="table-wrap">
<div class="table-header"><div class="table-title">Configuration Items (${cmdbItems.length})</div>${canDo(['admin','change_manager','env_owner'])?`<button class="btn btn-primary btn-sm" style="margin-left:auto" onclick="openModal('ciModal')">+ Aggiungi CI</button>`:''}</div>
<table><thead><tr><th>CI</th><th>Tipo</th><th>Ambiente</th><th>Owner</th><th>Stato</th><th>Versione</th></tr></thead>
<tbody>${cmdbItems.map(ci=>`<tr><td><div style="display:flex;align-items:center;gap:8px"><span style="font-size:16px">${CI_ICONS[ci.type]||'üìÅ'}</span><span style="font-family:var(--mono);font-size:12px">${ci.name}</span></div></td><td><span class="type-badge">${ci.type}</span></td><td style="font-family:var(--mono);font-size:11px">${ci.env}</td><td style="color:var(--text2)">${userName(ci.ownerId)}</td><td><span style="font-size:12px;color:${ci.status==='Operational'?'var(--accent2)':'var(--accent4)'}">‚óè ${ci.status}</span></td><td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${ci.version||'‚Äî'}</td></tr>`).join('')}</tbody></table>
</div>
<div class="card"><div class="card-title">Riepilogo per Tipo</div>${Object.entries(CI_ICONS).map(([t,ic])=>{const cnt=cmdbItems.filter(c=>c.type===t).length;return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><span style="font-size:18px">${ic}</span><span style="font-size:13px;flex:1">${t}</span><span style="font-family:var(--mono);font-size:13px;font-weight:600;color:var(--accent)">${cnt}</span></div>`;}).join('')}</div>
</div>`;
}

function submitCI() {
const name = document.getElementById('ciName')?.value?.trim();
if(!name) { alert('Inserisci il nome del CI'); return; }
const ci = {id: 'ci'+Date.now(), name, type: document.getElementById('ciType')?.value||'Server', env: document.getElementById('ciEnv')?.value||'PROD', ownerId: document.getElementById('ciOwner')?.value||currentUser.id, status: document.getElementById('ciStatus')?.value||'Operational', version: document.getElementById('ciVersion')?.value||'‚Äî', notes: document.getElementById('ciNotes')?.value||'', createdAt: new Date().toISOString().split('T')[0]};
cmdbItems.push(ci);
saveData(LS_CMDB, cmdbItems);
addNotification(`Nuovo CI aggiunto: ${name} (${ci.type})`);
closeModal('ciModal');
['ciName','ciVersion','ciNotes'].forEach(fid=>{ const el=document.getElementById(fid); if(el)el.value=''; });
renderCMDB();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSettings() {
if(!canDo(['admin'])){ document.getElementById('page-settings').innerHTML='<div class="access-denied"><div class="icon">üîí</div><h3>Accesso non autorizzato</h3></div>'; return; }

document.getElementById('page-settings').innerHTML = `
<div class="settings-grid">
<div class="settings-nav">
<div class="settings-nav-item active" onclick="showSettingsPanel('general',this)">‚öôÔ∏è Generale</div>
<div class="settings-nav-item" onclick="showSettingsPanel('workflow',this)">üîÑ Workflow</div>
<div class="settings-nav-item" onclick="showSettingsPanel('notifications',this)">üîî Notifiche</div>
<div class="settings-nav-item" onclick="showSettingsPanel('users',this)">üë• Utenti</div>
</div>
<div>
<div id="settings-general" class="settings-panel">
<div class="settings-section"><div class="settings-section-title">Configurazione Generale</div>
<div class="setting-row"><div><div class="setting-label">Nome Sistema</div><div class="setting-desc">Nome visualizzato nell'applicazione</div></div><input type="text" value="ChangeFlow" style="width:200px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:6px 10px;font-size:13px;color:var(--text)"></div>
</div>
<button class="btn btn-primary" onclick="saveSettings()">üíæ Salva Impostazioni</button>
</div>
<div id="settings-workflow" class="settings-panel" style="display:none"><div class="settings-section"><div class="settings-section-title">Configurazione Workflow</div><div class="setting-row"><div><div class="setting-label">Richiedi Approvazione CAB</div></div><label style="display:flex;align-items:center;cursor:pointer"><input type="checkbox" ${settings.requireCABApproval?'checked':''} style="width:18px;height:18px;margin-right:8px"><span style="font-size:13px">Attivo</span></label></div></div><button class="btn btn-primary" onclick="saveSettings()">üíæ Salva Impostazioni</button></div>
<div id="settings-notifications" class="settings-panel" style="display:none"><div class="settings-section"><div class="settings-section-title">Notifiche Email</div><div class="setting-row"><div><div class="setting-label">Attiva Notifiche Email</div></div><label style="display:flex;align-items:center;cursor:pointer"><input type="checkbox" ${settings.emailNotifications?'checked':''} style="width:18px;height:18px;margin-right:8px"><span style="font-size:13px">Attivo</span></label></div></div><button class="btn btn-primary" onclick="saveSettings()">üíæ Salva Impostazioni</button></div>
<div id="settings-users" class="settings-panel" style="display:none"><div class="settings-section"><div class="settings-section-title">Gestione Utenti</div><table><thead><tr><th>Nome</th><th>Username</th><th>Ruolo</th><th>Team</th></tr></thead><tbody>${USERS.map(u=>`<tr><td>${u.name}</td><td style="font-family:var(--mono);font-size:12px;color:var(--accent)">${u.username}</td><td><span class="type-badge">${ROLE_LABELS[u.role]}</span></td><td style="color:var(--text2)">${u.team}</td></tr>`).join('')}</tbody></table></div></div>
</div>
</div>`;
}

function showSettingsPanel(panelId, el) {
document.querySelectorAll('.settings-nav-item').forEach(i=>i.classList.remove('active'));
el.classList.add('active');
['general','workflow','notifications','users'].forEach(p=>{document.getElementById(`settings-${p}`).style.display = p===panelId?'block':'none';});
}

function saveSettings() {
settings.emailNotifications = document.querySelector('#settings-notifications input[type="checkbox"]')?.checked ?? true;
settings.requireCABApproval = document.querySelector('#settings-workflow input[type="checkbox"]')?.checked ?? true;
saveData(LS_SETTINGS, settings);
alert('Impostazioni salvate con successo!');
addNotification('Impostazioni sistema aggiornate');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetail(id) {
currentChangeId = id;
const c = changes.find(x=>x.id===id);
if(!c) return;

document.getElementById('detailTitle').textContent = `${c.id} ‚Äî ${c.title}`;
const dtpBadge = c.pipelineStrategy==='direct'?'<span class="dtp-tag">DIRECT</span>':'';
document.getElementById('detailBadges').innerHTML = `${sBadge(c.status)} ${pBadge(c.priority)} <span class="type-badge">${c.type}</span> ${dtpBadge}`;

const wfIdx = STATUS_WF_IDX[c.status]??0;
document.getElementById('detailWorkflow').innerHTML = WF_STEPS.map((step,i)=>{
const cls = i<wfIdx?'done':i===wfIdx&&c.status!=='Rifiutato'?'active':c.status==='Rifiutato'&&i===1?'rejected':'';
return `<div class="wf-step ${cls}" style="flex:1;min-width:100px;text-align:center;position:relative"><div class="wf-line" style="position:absolute;top:13px;left:50%;right:-50%;height:2px;background:${i<wfIdx?'var(--accent2)':'var(--border)'};${i===WF_STEPS.length-1?'display:none':''}"></div><div class="wf-step-inner"><div class="wf-dot">${i<wfIdx?'‚úì':c.status==='Rifiutato'&&i===1?'‚úï':(i+1)}</div><div class="wf-label">${step}</div></div></div>`;
}).join('');

document.getElementById('approvalBar').style.display = c.status==='In Review'?'flex':'none';

document.querySelectorAll('#detailModal .tab').forEach((t,i)=>t.classList.toggle('active',i===0));
renderDetailTab(c, 'tab-detail');
['tab-pipeline','tab-deps','tab-incidents','tab-activity','tab-comments'].forEach(id=>{ document.getElementById(id).style.display='none'; });
document.getElementById('tab-detail').style.display='block';

openModal('detailModal');
}

function renderDetailTab(c, tabId) {
if(tabId==='tab-detail') {
const relatedIncs = c.incidentIds?.map(incId=>incidents.find(i=>i.id===incId)).filter(Boolean)||[];
document.getElementById('tab-detail').innerHTML=`<div class="detail-grid"><div><div class="detail-meta"><div><div class="meta-label">Richiedente</div><div class="meta-value">${userName(c.requesterId)}</div></div><div><div class="meta-label">Assegnato a</div><div class="meta-value">${userName(c.assigneeId)}</div></div><div><div class="meta-label">Categoria CI</div><div class="meta-value">${c.category}</div></div><div><div class="meta-label">Finestra</div><div class="meta-value" style="font-family:var(--mono);font-size:12px">${c.window||'TBD'}</div></div><div><div class="meta-label">Rischio</div><div class="meta-value">${rBadge(c.risk)}</div></div><div><div class="meta-label">Impatto</div><div class="meta-value">${rBadge(c.impact)}</div></div></div><div class="section-box"><div class="section-box-title">Descrizione</div><p>${c.desc}</p></div><div class="section-box"><div class="section-box-title">Piano di Rollback</div><p>${c.rollback}</p></div><div class="section-box"><div class="section-box-title">Test Plan</div><p>${c.test}</p></div>${relatedIncs.length?`<div class="section-box"><div class="section-box-title">üîó Incidenti Correlati</div>${relatedIncs.map(inc=>`<div style="padding:6px 0;border-bottom:1px solid var(--border)"><div><span style="font-family:var(--mono);font-size:11px;color:var(--accent3)">${inc.id}</span> ‚Äî ${inc.title}</div></div>`).join('')}</div>`:''}</div><div><div class="card" style="margin-bottom:10px"><div class="card-title">Azioni Disponibili</div>${getActionButtons(c)}</div></div></div>`;
}
if(tabId==='tab-pipeline') {
document.getElementById('tab-pipeline').innerHTML=`<div class="env-pipeline">${ENVS.map((e,i)=>{const s=c.pipeline[i];const cls=s==='done'?'env-done':s==='active'?'env-active':s==='failed'?'env-failed':s==='skip'?'env-skip':'';const icon=s==='done'?'‚úì':s==='active'?'‚ñ∂':s==='failed'?'‚úï':s==='skip'?'‚§µ':(i+1);return `<div class="env-node ${cls}"><div class="wf-step-inner"><div class="env-dot">${icon}</div><div class="env-label">${e}</div></div></div>`;}).join('')}</div>`;
}
if(tabId==='tab-deps') {
document.getElementById('tab-deps').innerHTML=`<div style="color:var(--text3);font-size:13px">Nessuna dipendenza configurata</div>`;
}
if(tabId==='tab-incidents') {
const linked = incidents.filter(inc=>inc.relatedChanges?.includes(c.id));
document.getElementById('tab-incidents').innerHTML=linked.length?linked.map(inc=>`<div class="incident-item"><span style="font-size:16px">‚ö†</span><div style="flex:1"><div style="display:flex;align-items:center;gap:8px"><span class="incident-id">${inc.id}</span>${sevBadge(inc.severity)}<span style="font-size:11px;color:${inc.status==='Chiuso'||inc.status==='Risolto'?'var(--accent2)':'var(--accent4)'}">${inc.status}</span></div><div style="font-size:13px;color:var(--text2);margin-top:3px">${inc.title}</div></div></div>`).join(''):'<div style="color:var(--text3);font-size:13px">Nessun incidente correlato</div>';
}
if(tabId==='tab-activity') {
document.getElementById('tab-activity').innerHTML=`<div>${(c.history||[]).slice().reverse().map(h=>`<div class="tl-item"><div class="tl-icon">üìã</div><div><div class="tl-header">${h.action}</div><div class="tl-time">${h.time}</div></div></div>`).join('')}</div>`;
}
if(tabId==='tab-comments') {
document.getElementById('tab-comments').innerHTML=`<div>${(c.comments||[]).map(cm=>`<div class="comment"><div class="avatar" style="width:28px;height:28px;font-size:10px;flex-shrink:0">${cm.avatar||userInitials(cm.userId)}</div><div class="comment-body"><div style="display:flex;justify-content:space-between"><span class="comment-author">${cm.user||userName(cm.userId)}</span><span class="comment-time">${cm.time}</span></div><div class="comment-text">${cm.text}</div></div></div>`).join('')||'<div style="color:var(--text3);font-size:13px;margin-bottom:12px">Nessun commento.</div>'}</div><div style="display:flex;gap:8px;margin-top:10px"><div class="avatar" style="width:28px;height:28px;font-size:10px;flex-shrink:0">${currentUser.initials}</div><textarea id="commentInput" placeholder="Aggiungi commento..." style="flex:1;min-height:52px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;font-family:var(--font);font-size:13px;color:var(--text);outline:none;resize:vertical"></textarea><button class="btn btn-primary btn-sm" onclick="addComment('${c.id}')">Invia</button></div>`;
}
}

function switchTab(el, tabId) {
document.querySelectorAll('#detailModal .tab').forEach(t=>t.classList.remove('active'));
el.classList.add('active');
['tab-detail','tab-pipeline','tab-deps','tab-incidents','tab-activity','tab-comments'].forEach(id=>{ document.getElementById(id).style.display=id===tabId?'block':'none'; });
const c = changes.find(x=>x.id===currentChangeId);
if(c) renderDetailTab(c, tabId);
}

function getActionButtons(c) {
const myTrans = (TRANSITIONS[c.status]||[]).filter(t=>t.roles.includes(currentUser.role));
if(!myTrans.length) return `<div style="color:var(--text3);font-size:12px">Nessuna azione disponibile</div>`;
return myTrans.map(t=>`<button class="btn ${t.to==='Rifiutato'?'btn-danger':t.to==='Chiuso'?'btn-success':'btn-primary'} btn-sm" style="width:100%;justify-content:center;margin-bottom:6px" onclick="doTransition('${c.id}','${t.to}')">${t.label}</button>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doTransition(id, toStatus) {
const c = changes.find(x=>x.id===id);
if(!c) return;
const trans = (TRANSITIONS[c.status]||[]).find(t=>t.to===toStatus);
if(!trans || !trans.roles.includes(currentUser.role)) { alert('Non sei autorizzato'); return; }
const prevStatus = c.status;
c.status = toStatus;
if(!c.history) c.history=[];
c.history.push({action:`${prevStatus} ‚Üí ${toStatus}`, userId:currentUser.id, time:new Date().toLocaleString('it-IT')});
if(toStatus==='Implementazione' && c.currentEnv<4) { c.pipeline[c.currentEnv]='active'; }
if(toStatus==='Chiuso') { if(c.currentEnv<4) c.pipeline[c.currentEnv]='done'; }
saveData(LS_CHANGES, changes);
addNotification(`${c.id}: transizione ${prevStatus} ‚Üí ${toStatus}`);
updateBadges();
openDetail(id);
}

function approveChange() { doTransition(currentChangeId, 'Approvato'); }
function rejectChange() { doTransition(currentChangeId, 'Rifiutato'); }

function addComment(id) {
const text = document.getElementById('commentInput')?.value?.trim();
if(!text) return;
const c = changes.find(x=>x.id===id);
if(!c.comments) c.comments=[];
const now = new Date().toLocaleString('it-IT');
c.comments.push({userId:currentUser.id, name:currentUser.name, initials:currentUser.initials, time:now, text});
saveData(LS_CHANGES, changes);
openDetail(id);
setTimeout(()=>{ document.querySelectorAll('#detailModal .tab')[5]?.click(); },60);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW CHANGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openNewChangeModal() {
['newTitle','newDesc','newRollback','newTest','newStart','newEnd'].forEach(fid=>{ const el=document.getElementById(fid); if(el) el.value=''; });

const defaults = {newType:'Standard', newPriority:'Media', newCategory:'Server', newRisk:'Basso', newImpact:'Basso', newPipelineStrat:'full'};
Object.entries(defaults).forEach(([id,val])=>{ const el=document.getElementById(id); if(el) el.value=val; });

updatePipelinePreview();

const assigneeSel = document.getElementById('newAssignee');
if(assigneeSel) {
assigneeSel.innerHTML = USERS.filter(u => ['change_manager','admin','ta'].includes(u.role) || u.team === currentUser.team).map(u => `<option value="${u.id}">${u.name} (${ROLE_LABELS[u.role]||u.role})</option>`).join('');
}

const incSel = document.getElementById('newIncidents');
if(incSel) {
const openIncs = incidents.filter(i=>i.status!=='Chiuso');
incSel.innerHTML = openIncs.map(inc=>`<option value="${inc.id}">${inc.id} ‚Äî ${inc.title} [${inc.severity}]</option>`).join('');
}

openModal('newChangeModal');
setTimeout(()=>document.getElementById('newTitle')?.focus(), 100);
}

function updatePipelinePreview() {
const s = document.getElementById('newPipelineStrategy')?.value;
const m = {full:'DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD','skip-dev':'INTEG ‚Üí CERT ‚Üí PROD',direct:'‚ö° Direct to PROD'};
const el = document.getElementById('pipelinePreview');
if(el) el.textContent = m[s]||'‚Äî';
}

function submitNewChange() {
const title = document.getElementById('newTitle')?.value?.trim();
if(!title) { alert('Inserisci il titolo'); return; }
const strategy = document.getElementById('newPipelineStrategy')?.value||'full';
const pipeline = strategy==='direct'?['skip','skip','skip','active']:strategy==='skip-dev'?['skip','active','pending','pending']:['active','pending','pending','pending'];
const startEnv = strategy==='direct'?3:strategy==='skip-dev'?1:0;
const today = new Date().toISOString().split('T')[0];
const num = String(changes.length+1).padStart(3,'0');
const id = `CHG-${new Date().getFullYear()}-${num}`;

const incSel = document.getElementById('newIncidents');
const incidentIds = incSel?Array.from(incSel.selectedOptions).map(o=>o.value):[];

const newChange = {id, title, type: document.getElementById('newType')?.value||'Standard', priority: document.getElementById('newPriority')?.value||'Media', status: 'Aperto', requesterId: currentUser.id, assigneeId: document.getElementById('newAssignee')?.value||currentUser.id, category: document.getElementById('newCategory')?.value||'Server', risk: document.getElementById('newRisk')?.value||'Basso', impact: document.getElementById('newImpact')?.value||'Basso', opened: today, window: document.getElementById('newStart')?.value||'', windowEnd: document.getElementById('newEnd')?.value||'', pipeline, pipelineStrategy:strategy, currentEnv:startEnv, incidentIds, desc: document.getElementById('newDesc')?.value||'', rollback: document.getElementById('newRollback')?.value||'Da definire.', test: document.getElementById('newTest')?.value||'Da definire.', comments:[], history:[{action:'Change aperto', userId:currentUser.id, time:new Date().toLocaleString('it-IT')}]};

incidentIds.forEach(incId=>{ const inc = incidents.find(i=>i.id===incId); if(inc) { if(!inc.relatedChanges) inc.relatedChanges=[]; inc.relatedChanges.push(id); }});
saveData(LS_INCIDENTS, incidents);

changes.unshift(newChange);
saveData(LS_CHANGES, changes);
addNotification(`Nuovo change ${id} creato: "${title}"`);
closeModal('newChangeModal');
['newTitle','newDesc','newRollback','newTest','newStart','newEnd'].forEach(fid=>{ const el=document.getElementById(fid); if(el)el.value=''; });
renderDashboard();
renderChanges();
updateBadges();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addNotification(text) {
notifications.unshift({text, time:new Date().toLocaleString('it-IT'), read:false});
if(notifications.length>50) notifications=notifications.slice(0,50);
saveData(LS_NOTIFS, notifications);
renderNotifList();
}
function renderNotifList() {
const unread = notifications.filter(n=>!n.read).length;
const dot = document.getElementById('notifDot');
if(dot) dot.style.display = unread>0?'block':'none';
const list = document.getElementById('notifList');
if(!list) return;
list.innerHTML = notifications.slice(0,20).map((n,i)=>`<div class="notif-item ${n.read?'':'unread'}" onclick="markRead(${i})"><div class="notif-dot2" style="${n.read?'opacity:0':''}"></div><div><div class="notif-text">${n.text}</div><div class="notif-time">${n.time}</div></div></div>`).join('') || '<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px">Nessuna notifica</div>';
}
function markRead(i) { notifications[i].read=true; saveData(LS_NOTIFS,notifications); renderNotifList(); }
function markAllRead() { notifications.forEach(n=>n.read=true); saveData(LS_NOTIFS,notifications); renderNotifList(); }
function toggleNotif() { document.getElementById('notifPanel').classList.toggle('open'); }
document.addEventListener('click',e=>{ if(!e.target.closest('.notif-wrap')) document.getElementById('notifPanel')?.classList.remove('open'); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); }));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR PICKER - CORRETTO ‚úÖ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let calTargetInput = null;
let calDate = new Date();
let calSelected = null;

function openCalPicker(inputId, event) {
event.preventDefault();
event.stopPropagation();

calTargetInput = inputId;
const input = document.getElementById(inputId);

if(input?.value) {
const d = new Date(input.value);
if(!isNaN(d.getTime())) { calDate = new Date(d); calSelected = new Date(d); }
else { calDate = new Date(); calSelected = new Date(); }
} else {
calDate = new Date(); calSelected = new Date();
}

const ov = document.getElementById('calPickerOv');
const picker = document.getElementById('calPicker');

ov.classList.add('open');

const rect = event.target.getBoundingClientRect();
const pickerHeight = 380;
const pickerWidth = 280;
const spaceBelow = window.innerHeight - rect.bottom;
const spaceAbove = rect.top;

if(spaceBelow < pickerHeight && spaceAbove > spaceBelow) {
picker.style.top = Math.max(8, rect.top - pickerHeight - 8) + 'px';
} else {
picker.style.top = Math.min(window.innerHeight - pickerHeight - 8, rect.bottom + 8) + 'px';
}

picker.style.left = Math.min(Math.max(8, rect.left), window.innerWidth - pickerWidth - 8) + 'px';

renderCalPicker();
setTimeout(()=>document.getElementById('calTime')?.focus(), 100);
}

function calSetDate(y, m, d, event) {
// ‚úÖ FERMA IL BUBBLING PER EVITARE CHIUSURA PREMATURA
if(event) {
event.stopPropagation();
event.preventDefault();
}

calSelected = new Date(y, m, d);
calDate = new Date(y, m, d);
renderCalPicker();
// ‚úÖ NON CHIUDERE: utente deve poter aggiustare ora e confermare
}

function confirmCalPicker() {
if(!calSelected || !calTargetInput) { closeCalPicker(); return; }

const time = document.getElementById('calTime').value || '09:00';
const [hh, mm] = time.split(':');

calSelected.setHours(parseInt(hh) || 0, parseInt(mm) || 0, 0, 0);

const pad = n => String(n).padStart(2, '0');
const str = `${calSelected.getFullYear()}-${pad(calSelected.getMonth()+1)}-${pad(calSelected.getDate())} ${pad(calSelected.getHours())}:${pad(calSelected.getMinutes())}`;

const el = document.getElementById(calTargetInput);
if(el) {
el.value = str;
el.dispatchEvent(new Event('change', { bubbles: true }));
}

closeCalPicker();
}

function closeCalPicker() {
document.getElementById('calPickerOv').classList.remove('open');
calSelected = null;
calTargetInput = null;
}

function closeCalPickerIfOutside(e) {
const ov = document.getElementById('calPickerOv');
const picker = document.getElementById('calPicker');

// ‚úÖ CHIUDI SOLO SE CLICK SULL'OVERLAY VUOTO
if(e.target === ov) {
closeCalPicker();
return;
}
// ‚úÖ NON CHIUDERE SE CLICK DENTRO IL PICKER
if(picker && picker.contains(e.target)) {
return;
}
// ‚úÖ CHIUDI SE CLICK FUORI DA TUTTO
closeCalPicker();
}

function renderCalPicker() {
const months=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
document.getElementById('calMonthLbl').textContent = `${months[calDate.getMonth()]} ${calDate.getFullYear()}`;
const firstDay = new Date(calDate.getFullYear(), calDate.getMonth(), 1);
const lastDay = new Date(calDate.getFullYear(), calDate.getMonth()+1, 0);
const today = new Date();
let offset = firstDay.getDay()-1; if(offset<0) offset=6;
let html='';
for(let i=0;i<offset;i++){
const d=new Date(calDate.getFullYear(),calDate.getMonth(),-(offset-1-i));
html+=`<div class="cal-d other-month" onclick="calSetDate(${d.getFullYear()},${d.getMonth()},${d.getDate()},event)">${d.getDate()}</div>`;
}
for(let d=1;d<=lastDay.getDate();d++){
const isToday=(d===today.getDate()&&calDate.getMonth()===today.getMonth()&&calDate.getFullYear()===today.getFullYear());
const isSel=(calSelected&&d===calSelected.getDate()&&calDate.getMonth()===calSelected.getMonth()&&calDate.getFullYear()===calSelected.getFullYear());
html+=`<div class="cal-d ${isToday?'today':''} ${isSel?'selected':''}" onclick="calSetDate(${calDate.getFullYear()},${calDate.getMonth()},${d},event)">${d}</div>`;
}
document.getElementById('calDays').innerHTML=html;
if(calSelected) {
const h=String(calSelected.getHours()).padStart(2,'0');
const m=String(calSelected.getMinutes()).padStart(2,'0');
document.getElementById('calTime').value=`${h}:${m}`;
}
}

function calNavMonth(dir) {
calDate.setMonth(calDate.getMonth()+dir);
renderCalPicker();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
initLogin();
</script>
</body>
</html>
