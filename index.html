// ════════════════════════════════════════════
// CALENDAR PICKER - CORRETTO
// ════════════════════════════════════════════
let calTargetInput = null;
let calDate = new Date();
let calSelected = null;

function openCalPicker(inputId, event) {
  event.preventDefault();
  event.stopPropagation();
  
  calTargetInput = inputId;
  const input = document.getElementById(inputId);
  
  // Inizializza sempre calSelected
  if(input?.value) {
    const d = new Date(input.value);
    if(!isNaN(d.getTime())) { 
      calDate = new Date(d); 
      calSelected = new Date(d); 
    } else {
      calDate = new Date(); 
      calSelected = new Date();
    }
  } else {
    calDate = new Date(); 
    calSelected = new Date();
  }
  
  const ov = document.getElementById('calPickerOv');
  const picker = document.getElementById('calPicker');
  
  ov.classList.add('open');
  
  // Posizionamento intelligente
  const rect = event.target.getBoundingClientRect();
  const pickerHeight = 380;
  const pickerWidth = 280;
  const spaceBelow = window.innerHeight - rect.bottom;
  const spaceAbove = rect.top;
  
  if(spaceBelow < pickerHeight && spaceAbove > spaceBelow) {
    picker.style.top = Math.max(8, rect.top - pickerHeight - 8) + 'px';
  } else {
    picker.style.top = Math.min(window.innerHeight - pickerHeight - 8, rect.bottom + 8) + 'px';
  }
  
  picker.style.left = Math.min(Math.max(8, rect.left), window.innerWidth - pickerWidth - 8) + 'px';
  
  renderCalPicker();
  setTimeout(()=>document.getElementById('calTime')?.focus(), 100);
}

function calSetDate(y, m, d) {
  calSelected = new Date(y, m, d);
  calDate = new Date(y, m, d);
  renderCalPicker();
}

function confirmCalPicker() {
  if(!calSelected || !calTargetInput) { 
    console.error('Calendar: calSelected o calTargetInput non definiti', {calSelected, calTargetInput});
    closeCalPicker(); 
    return; 
  }
  
  const time = document.getElementById('calTime').value || '09:00';
  const [hh, mm] = time.split(':');
  
  calSelected.setHours(parseInt(hh) || 0, parseInt(mm) || 0, 0, 0);
  
  const pad = n => String(n).padStart(2, '0');
  const str = `${calSelected.getFullYear()}-${pad(calSelected.getMonth()+1)}-${pad(calSelected.getDate())} ${pad(calSelected.getHours())}:${pad(calSelected.getMinutes())}`;
  
  const el = document.getElementById(calTargetInput);
  if(el) {
    el.value = str;
    console.log('Calendar: data impostata', str, 'su input', calTargetInput);
  } else {
    console.error('Calendar: elemento input non trovato', calTargetInput);
  }
  
  closeCalPicker();
}

function closeCalPicker() { 
  document.getElementById('calPickerOv').classList.remove('open'); 
  calSelected = null;
  calTargetInput = null;
}
