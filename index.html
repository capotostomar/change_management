<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChangeFlow v2 ‚Äî Change Management</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0f14; --surface:#151820; --surface2:#1c2030; --surface3:#242840; --surface4:#2a2f45;
  --border:#2a2f45; --border2:#343a55;
  --accent:#4f7cff; --accent2:#00d4aa; --accent3:#ff6b6b; --accent4:#ffa94d; --accent5:#c084fc;
  --text:#e8eaf6; --text2:#8890b0; --text3:#525870;
  --font:'IBM Plex Sans',sans-serif; --mono:'IBM Plex Mono',monospace;
  --radius:8px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;overflow-x:hidden;}
/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app{display:flex;height:100vh;}
.sidebar{width:248px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{height:60px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:16px;flex-shrink:0;}
.content{flex:1;overflow-y:auto;padding:28px;}
/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.logo{padding:20px 20px 16px;border-bottom:1px solid var(--border);}
.logo-text{font-family:var(--mono);font-size:18px;font-weight:600;color:var(--accent);}
.logo-sub{font-size:10px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.logo-ver{font-size:9px;color:var(--text3);font-family:var(--mono);margin-top:1px;}
.nav{padding:10px 0;flex:1;overflow-y:auto;}
.nav-section{padding:10px 16px 4px;font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text3);}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;cursor:pointer;transition:all .15s;font-size:13.5px;color:var(--text2);border-left:3px solid transparent;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:rgba(79,124,255,.1);color:var(--accent);border-left-color:var(--accent);}
.nav-icon{width:16px;height:16px;opacity:.8;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-family:var(--mono);padding:2px 6px;border-radius:10px;font-weight:600;}
.nav-badge.red{background:var(--accent3);}
.user-area{padding:14px 16px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:#fff;flex-shrink:0;}
.user-name{font-size:13px;font-weight:500;}
.user-role{font-size:11px;color:var(--text3);}
/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.page-title{font-size:17px;font-weight:600;}
.topbar-actions{margin-left:auto;display:flex;gap:8px;align-items:center;}
.notif-wrap{position:relative;}
.notif-dot{width:8px;height:8px;background:var(--accent3);border-radius:50%;border:2px solid var(--surface);position:absolute;top:-1px;right:-1px;}
/* FREEZE BANNER */
.freeze-banner{background:rgba(255,107,107,.08);border-bottom:1px solid rgba(255,107,107,.2);padding:8px 24px;display:flex;align-items:center;gap:10px;font-size:12px;color:#ff8585;}
.freeze-banner svg{flex-shrink:0;}
/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:7px;padding:8px 16px;border-radius:var(--radius);font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .15s;font-family:var(--font);}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:#6b91ff;transform:translateY(-1px);box-shadow:0 4px 12px rgba(79,124,255,.4);}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--surface2);color:var(--text);}
.btn-danger{background:rgba(255,107,107,.15);color:var(--accent3);border:1px solid rgba(255,107,107,.3);}
.btn-danger:hover{background:rgba(255,107,107,.25);}
.btn-success{background:rgba(0,212,170,.15);color:var(--accent2);border:1px solid rgba(0,212,170,.3);}
.btn-sm{padding:5px 10px;font-size:12px;}
.btn-xs{padding:3px 8px;font-size:11px;}
/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;}
.card-title{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;}
/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:22px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;position:relative;overflow:hidden;cursor:pointer;transition:all .2s;}
.stat-card:hover{border-color:var(--accent);transform:translateY(-2px);}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.stat-card.s-open::before{background:var(--accent3);}
.stat-card.s-review::before{background:var(--accent);}
.stat-card.s-impl::before{background:var(--accent4);}
.stat-card.s-ok::before{background:var(--accent2);}
.stat-card.s-freeze::before{background:var(--accent5);}
.stat-number{font-family:var(--mono);font-size:32px;font-weight:600;line-height:1;margin-bottom:5px;}
.stat-card.s-open .stat-number{color:var(--accent3);}
.stat-card.s-review .stat-number{color:var(--accent);}
.stat-card.s-impl .stat-number{color:var(--accent4);}
.stat-card.s-ok .stat-number{color:var(--accent2);}
.stat-card.s-freeze .stat-number{color:var(--accent5);}
.stat-label{font-size:12px;color:var(--text2);}
.stat-trend{font-size:10px;color:var(--text3);margin-top:6px;font-family:var(--mono);}
/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.table-header{padding:14px 18px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px;}
.table-title{font-size:14px;font-weight:600;}
.search-bar{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:6px 12px;}
.search-bar input{background:none;border:none;outline:none;font-family:var(--font);font-size:13px;color:var(--text);width:200px;}
.search-bar input::placeholder{color:var(--text3);}
table{width:100%;border-collapse:collapse;}
th{padding:9px 14px;text-align:left;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);background:var(--surface2);border-bottom:1px solid var(--border);}
td{padding:11px 14px;font-size:13px;border-bottom:1px solid rgba(42,47,69,.5);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.015);}
.change-id{font-family:var(--mono);font-size:11px;color:var(--accent);}
/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:.3px;}
.badge::before{content:'';width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.badge-open{background:rgba(255,107,107,.12);color:#ff8585;} .badge-open::before{background:var(--accent3);}
.badge-review{background:rgba(79,124,255,.12);color:#7b9dff;} .badge-review::before{background:var(--accent);}
.badge-approved{background:rgba(0,212,170,.12);color:#00d4aa;} .badge-approved::before{background:var(--accent2);}
.badge-scheduled{background:rgba(255,169,77,.12);color:#ffa94d;} .badge-scheduled::before{background:var(--accent4);}
.badge-implementing{background:rgba(255,169,77,.2);color:#ffbd6e;animation:pulse 2s infinite;} .badge-implementing::before{background:var(--accent4);}
.badge-closed{background:rgba(82,88,112,.2);color:var(--text3);} .badge-closed::before{background:var(--text3);}
.badge-rejected{background:rgba(255,107,107,.12);color:#ff6b6b;} .badge-rejected::before{background:var(--accent3);}
.badge-freeze{background:rgba(192,132,252,.12);color:#c084fc;} .badge-freeze::before{background:var(--accent5);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.priority{display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:500;}
.priority-critical{color:var(--accent3);}
.priority-high{color:var(--accent4);}
.priority-medium{color:var(--accent);}
.priority-low{color:var(--text3);}
.type-badge{background:var(--surface3);color:var(--text2);padding:2px 7px;border-radius:4px;font-size:10px;font-family:var(--mono);}
/* ‚îÄ‚îÄ ENV PIPELINE ‚îÄ‚îÄ */
.env-pipeline{display:flex;align-items:center;gap:0;width:100%;}
.env-node{flex:1;display:flex;flex-direction:column;align-items:center;position:relative;}
.env-node:not(:last-child)::after{content:'';position:absolute;top:14px;left:50%;width:100%;height:2px;z-index:0;}
.env-node:not(:last-child).env-done::after{background:var(--accent2);}
.env-node:not(:last-child).env-active::after{background:linear-gradient(90deg,var(--accent),var(--border));animation:flowAnim 1.5s linear infinite;}
.env-node:not(:last-child)::after{background:var(--border);}
@keyframes flowAnim{0%{background-position:0 0}100%{background-position:40px 0}}
.env-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;z-index:1;border:2px solid var(--border);background:var(--surface2);color:var(--text3);transition:all .2s;cursor:pointer;}
.env-node.env-done .env-dot{background:var(--accent2);border-color:var(--accent2);color:#fff;}
.env-node.env-active .env-dot{background:var(--accent4);border-color:var(--accent4);color:#fff;box-shadow:0 0 12px rgba(255,169,77,.5);animation:pulse 1.5s infinite;}
.env-node.env-failed .env-dot{background:var(--accent3);border-color:var(--accent3);color:#fff;}
.env-node.env-skip .env-dot{background:var(--accent5);border-color:var(--accent5);color:#fff;}
.env-label{font-size:10px;margin-top:5px;color:var(--text3);font-family:var(--mono);font-weight:600;letter-spacing:.5px;}
.env-node.env-done .env-label{color:var(--accent2);}
.env-node.env-active .env-label{color:var(--accent4);}
.env-node.env-failed .env-label{color:var(--accent3);}
.env-node.env-skip .env-label{color:var(--accent5);}
.env-date{font-size:9px;color:var(--text3);font-family:var(--mono);margin-top:2px;}
/* pipeline card in list */
.pipeline-cell{min-width:260px;}
/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(4px);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:760px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.6);transform:translateY(16px);transition:transform .2s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-wide{width:940px;}
.modal-header{padding:22px 26px 18px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:14px;}
.modal-title{font-size:17px;font-weight:600;}
.modal-subtitle{font-size:13px;color:var(--text2);margin-top:3px;}
.modal-close{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--text3);font-size:20px;padding:4px;transition:color .15s;line-height:1;}
.modal-close:hover{color:var(--text);}
.modal-body{padding:22px 26px;}
.modal-footer{padding:14px 26px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}
/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-group{display:flex;flex-direction:column;gap:5px;}
.form-group.full{grid-column:1/-1;}
label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;}
input,select,textarea{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:9px 11px;font-family:var(--font);font-size:13px;color:var(--text);outline:none;transition:border-color .15s;width:100%;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
select option{background:var(--surface2);}
textarea{resize:vertical;min-height:72px;}
.form-section{margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid var(--border);}
.form-section:last-child{border:none;margin:0;padding:0;}
.form-section-title{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:12px;display:flex;align-items:center;gap:7px;text-transform:uppercase;letter-spacing:.8px;}
/* ‚îÄ‚îÄ WORKFLOW STEPPER ‚îÄ‚îÄ */
.workflow{display:flex;align-items:flex-start;gap:0;margin:14px 0;}
.wf-step{flex:1;text-align:center;position:relative;}
.wf-step-inner{display:flex;flex-direction:column;align-items:center;gap:5px;}
.wf-dot{width:32px;height:32px;border-radius:50%;background:var(--surface2);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;transition:all .2s;z-index:1;}
.wf-step.done .wf-dot{background:var(--accent2);border-color:var(--accent2);color:#fff;}
.wf-step.active .wf-dot{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 14px rgba(79,124,255,.5);}
.wf-step.rejected .wf-dot{background:var(--accent3);border-color:var(--accent3);color:#fff;}
.wf-label{font-size:10px;color:var(--text3);font-weight:500;}
.wf-step.done .wf-label,.wf-step.active .wf-label{color:var(--text);}
.wf-line{position:absolute;top:15px;left:50%;right:-50%;height:2px;background:var(--border);}
.wf-step.done .wf-line{background:var(--accent2);}
.wf-step:last-child .wf-line{display:none;}
/* ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ */
.detail-grid{display:grid;grid-template-columns:1fr 300px;gap:18px;}
.detail-meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.meta-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:3px;}
.meta-value{font-size:13px;color:var(--text);}
.section-box{background:var(--surface2);border-radius:var(--radius);padding:12px;margin-bottom:10px;}
.section-box-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:7px;}
.section-box p{font-size:13px;line-height:1.6;color:var(--text2);}
/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:18px;}
.tab{padding:9px 18px;font-size:13px;font-weight:500;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
/* ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ */
.tl-item{display:flex;gap:10px;margin-bottom:14px;}
.tl-icon{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;}
.tl-header{font-size:13px;font-weight:500;}
.tl-time{font-size:10px;color:var(--text3);font-family:var(--mono);margin-top:1px;}
.tl-text{font-size:12px;color:var(--text2);margin-top:3px;}
/* ‚îÄ‚îÄ COMMENTS ‚îÄ‚îÄ */
.comment{display:flex;gap:9px;margin-bottom:12px;}
.comment-body{background:var(--surface2);border-radius:var(--radius);padding:10px 13px;flex:1;}
.comment-author{font-size:12px;font-weight:600;color:var(--text);}
.comment-time{font-size:10px;color:var(--text3);font-family:var(--mono);}
.comment-text{font-size:13px;color:var(--text2);line-height:1.5;margin-top:4px;}
/* ‚îÄ‚îÄ APPROVAL BAR ‚îÄ‚îÄ */
.approval-bar{background:rgba(79,124,255,.06);border:1px solid rgba(79,124,255,.2);border-radius:var(--radius);padding:11px 14px;display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.approval-text{flex:1;font-size:13px;color:var(--text2);}
/* ‚îÄ‚îÄ FREEZE ‚îÄ‚îÄ */
.freeze-period{background:rgba(192,132,252,.06);border:1px solid rgba(192,132,252,.2);border-radius:var(--radius);padding:12px 16px;display:flex;align-items:center;gap:10px;}
.freeze-icon{font-size:18px;}
.freeze-info{flex:1;}
.freeze-name{font-size:13px;font-weight:600;color:var(--accent5);}
.freeze-dates{font-size:11px;color:var(--text3);font-family:var(--mono);margin-top:2px;}
/* ‚îÄ‚îÄ CAB BOARD ‚îÄ‚îÄ */
.cab-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;}
.cab-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all .15s;}
.cab-card:hover{border-color:var(--accent);transform:translateY(-1px);}
.cab-card-id{font-family:var(--mono);font-size:11px;color:var(--accent);margin-bottom:6px;}
.cab-card-title{font-size:13px;font-weight:500;margin-bottom:8px;line-height:1.4;}
.cab-card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;}
.cab-votes{font-size:11px;color:var(--text3);display:flex;gap:10px;}
.vote-yes{color:var(--accent2);}
.vote-no{color:var(--accent3);}
/* ‚îÄ‚îÄ DEPENDENCIES ‚îÄ‚îÄ */
.dep-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface2);border-radius:var(--radius);margin-bottom:7px;}
.dep-arrow{color:var(--text3);font-size:14px;}
.dep-info{flex:1;}
.dep-id{font-family:var(--mono);font-size:11px;color:var(--accent);}
.dep-title{font-size:12px;color:var(--text2);}
/* ‚îÄ‚îÄ INCIDENT LINK ‚îÄ‚îÄ */
.incident-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(255,107,107,.06);border:1px solid rgba(255,107,107,.15);border-radius:var(--radius);margin-bottom:7px;}
.incident-id{font-family:var(--mono);font-size:11px;color:var(--accent3);}
/* ‚îÄ‚îÄ CMDB ‚îÄ‚îÄ */
.cmdb-item{display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--surface2);border-radius:var(--radius);margin-bottom:8px;cursor:pointer;transition:all .15s;}
.cmdb-item:hover{border:1px solid var(--border2);}
.cmdb-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.cmdb-name{font-size:13px;font-weight:500;}
.cmdb-type{font-size:11px;color:var(--text3);}
.cmdb-status{margin-left:auto;font-size:11px;}
/* ‚îÄ‚îÄ NOTIF ‚îÄ‚îÄ */
.notif-list{max-height:360px;overflow-y:auto;}
.notif-item{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:10px;cursor:pointer;transition:background .1s;}
.notif-item:hover{background:var(--surface2);}
.notif-item.unread{background:rgba(79,124,255,.04);}
.notif-dot2{width:7px;height:7px;border-radius:50%;background:var(--accent);flex-shrink:0;margin-top:4px;}
.notif-text{font-size:13px;line-height:1.4;}
.notif-time{font-size:10px;color:var(--text3);font-family:var(--mono);margin-top:3px;}
/* ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ */
.reports-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:18px;}
.chart-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;}
.chart-title{font-size:13px;font-weight:600;margin-bottom:14px;}
.bar-chart{display:flex;flex-direction:column;gap:7px;}
.bar-row{display:flex;align-items:center;gap:10px;}
.bar-label{width:90px;font-size:11px;color:var(--text2);text-align:right;flex-shrink:0;}
.bar-track{flex:1;height:18px;background:var(--surface2);border-radius:4px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:7px;transition:width .8s cubic-bezier(.4,0,.2,1);}
.bar-value{font-size:10px;font-family:var(--mono);font-weight:600;color:#fff;}
.donut-wrap{display:flex;align-items:center;gap:20px;}
.donut{width:110px;height:110px;flex-shrink:0;}
.legend{display:flex;flex-direction:column;gap:7px;}
.legend-item{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--text2);}
.legend-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px;}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center;}
.kpi-value{font-family:var(--mono);font-size:26px;font-weight:600;color:var(--accent2);}
.kpi-label{font-size:10px;color:var(--text3);margin-top:3px;text-transform:uppercase;letter-spacing:1px;}
/* ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ */
.cal-header-row{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:6px;}
.cal-hd{font-size:10px;text-align:center;color:var(--text3);font-weight:600;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;border-radius:6px;cursor:pointer;color:var(--text3);transition:all .1s;position:relative;}
.cal-day:hover{background:var(--surface3);color:var(--text);}
.cal-day.has-change{background:rgba(79,124,255,.12);color:var(--accent);font-weight:600;}
.cal-day.today{background:var(--accent);color:#fff;font-weight:600;}
.cal-day.freeze-day{background:rgba(192,132,252,.1);color:var(--accent5);}
.cal-pip{width:4px;height:4px;border-radius:50%;margin-top:2px;}
/* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ */
.page{display:none;}
.page.active{display:block;animation:fadeIn .25s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
/* ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ */
.filter-select{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:6px 10px;font-family:var(--font);font-size:12px;color:var(--text2);cursor:pointer;}
/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
/* ‚îÄ‚îÄ DIVIDERS ‚îÄ‚îÄ */
.sep{height:1px;background:var(--border);margin:16px 0;}
/* ‚îÄ‚îÄ ENV TABLE CELL ‚îÄ‚îÄ */
.env-inline{display:flex;align-items:center;gap:4px;}
.env-pip{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;flex-shrink:0;}
.env-arrow-sm{color:var(--text3);font-size:10px;}
/* ‚îÄ‚îÄ DIRECT-TO-PROD TAG ‚îÄ‚îÄ */
.dtp-tag{background:rgba(255,107,107,.1);border:1px solid rgba(255,107,107,.25);border-radius:4px;padding:2px 7px;font-size:10px;color:#ff8585;font-family:var(--mono);}
/* ‚îÄ‚îÄ PROMOTE BUTTON ‚îÄ‚îÄ */
.promote-btn{background:rgba(0,212,170,.1);border:1px solid rgba(0,212,170,.25);color:var(--accent2);padding:4px 10px;border-radius:5px;font-size:11px;cursor:pointer;font-family:var(--font);font-weight:500;transition:all .15s;}
.promote-btn:hover{background:rgba(0,212,170,.2);}
/* ‚îÄ‚îÄ ENV DETAIL PANEL ‚îÄ‚îÄ */
.env-panel{background:var(--surface2);border-radius:10px;padding:16px;margin-bottom:14px;}
.env-panel-title{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;}
.env-row{display:flex;align-items:center;gap:0;width:100%;padding:10px 0;border-bottom:1px solid var(--border);}
.env-row:last-child{border:none;}
.env-row-name{width:80px;font-size:12px;font-family:var(--mono);font-weight:600;color:var(--text2);}
.env-row-status{flex:1;}
.env-row-date{font-size:10px;color:var(--text3);font-family:var(--mono);width:130px;text-align:right;}
.env-row-action{width:100px;text-align:right;}
/* notification panel */
.notif-panel{position:absolute;top:46px;right:0;width:320px;background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:200;display:none;}
.notif-panel.open{display:block;}
.notif-panel-header{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:600;display:flex;justify-content:space-between;align-items:center;}
/* ‚îÄ‚îÄ REPORT TOGGLES ‚îÄ‚îÄ */
.col-toggle{display:inline-flex;align-items:center;gap:6px;cursor:pointer;padding:5px 10px;border-radius:6px;border:1px solid var(--border);font-size:12px;color:var(--text2);transition:all .15s;user-select:none;}
.col-toggle.on{background:rgba(79,124,255,.1);border-color:rgba(79,124,255,.4);color:var(--accent);}
.col-toggle input{display:none;}
/* export overlay */
.export-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:200;display:flex;align-items:center;justify-content:center;}
.export-modal-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:420px;padding:28px;box-shadow:0 24px 64px rgba(0,0,0,.6);}
.export-progress{height:5px;background:var(--surface2);border-radius:3px;overflow:hidden;margin-top:14px;}
.export-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;width:0%;transition:width .3s;}
/* report table */
.report-group-header td{background:rgba(79,124,255,.06);font-weight:600;color:var(--accent);font-size:12px;letter-spacing:.5px;padding:8px 14px;}
.report-subtotal td{background:rgba(0,0,0,.15);font-weight:600;font-size:12px;color:var(--text2);border-top:1px solid var(--border);}
.report-total td{background:rgba(79,124,255,.08);font-weight:700;color:var(--text);border-top:2px solid var(--accent);font-size:13px;}
</style>
</head>
<body>
<div class="app">
<!-- ‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê -->
<nav class="sidebar">
  <div class="logo">
    <div class="logo-text">ChangeFlow</div>
    <div class="logo-sub">Change Management</div>
    <div class="logo-ver">v2.0 ‚Äî Enterprise</div>
  </div>
  <div class="nav">
    <div class="nav-section">Principale</div>
    <div class="nav-item active" onclick="showPage('dashboard',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>Dashboard
    </div>
    <div class="nav-item" onclick="showPage('changes',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
      Tutti i Change <span class="nav-badge" id="nbAll">12</span>
    </div>
    <div class="nav-item" onclick="showPage('pipeline',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Pipeline Ambienti
    </div>
    <div class="nav-item" onclick="showPage('approvals',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      Approvazioni <span class="nav-badge red" id="nbAppr">3</span>
    </div>
    <div class="nav-item" onclick="showPage('cab',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      CAB Board <span class="nav-badge" id="nbCab">3</span>
    </div>
    <div class="nav-item" onclick="showPage('calendar',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Calendario &amp; Freeze
    </div>
    <div class="nav-section">Analisi</div>
    <div class="nav-item" onclick="showPage('reports',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Report &amp; Analytics
    </div>
    <div class="nav-item" onclick="showPage('incidents',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      Incidenti Correlati <span class="nav-badge red">2</span>
    </div>
    <div class="nav-section">Configurazione</div>
    <div class="nav-item" onclick="showPage('cmdb',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>CMDB
    </div>
    <div class="nav-item" onclick="showPage('config',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 010 14.14M4.93 4.93a10 10 0 000 14.14"/></svg>Impostazioni
    </div>
  </div>
  <div class="user-area">
    <div class="avatar">MA</div>
    <div>
      <div class="user-name">Marco Albini</div>
      <div class="user-role">Change Manager</div>
    </div>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê -->
<div class="main">
  <!-- Freeze Banner -->
  <div class="freeze-banner" id="freezeBanner" style="display:none">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
    <strong>FREEZE PERIOD ATTIVO:</strong>&nbsp;Fine Anno ‚Äî nessun change su PROD autorizzato fino al 02/01/2025
  </div>

  <div class="topbar">
    <div class="page-title" id="pageTitle">Dashboard</div>
    <div class="topbar-actions">
      <button class="btn btn-ghost btn-sm" onclick="openNewChangeModal()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Nuovo Change
      </button>
      <div class="notif-wrap" style="position:relative">
        <button class="btn btn-ghost btn-sm" onclick="toggleNotif()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg>
        </button>
        <div class="notif-dot"></div>
        <div class="notif-panel" id="notifPanel">
          <div class="notif-panel-header">Notifiche <span style="font-size:10px;color:var(--text3);cursor:pointer" onclick="markAllRead()">Segna tutte lette</span></div>
          <div class="notif-list" id="notifList"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">

    <!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card s-open" onclick="filterAndShow('Aperto')"><div class="stat-number" id="st-open">5</div><div class="stat-label">Aperti</div><div class="stat-trend">‚Üë +2 questa settimana</div></div>
        <div class="stat-card s-review" onclick="filterAndShow('In Review')"><div class="stat-number" id="st-review">3</div><div class="stat-label">In Approvazione</div><div class="stat-trend">‚è≥ CAB mercoled√¨</div></div>
        <div class="stat-card s-impl" onclick="filterAndShow('Implementazione')"><div class="stat-number" id="st-impl">2</div><div class="stat-label">In Implementazione</div><div class="stat-trend">‚Üí Live ora</div></div>
        <div class="stat-card s-ok" onclick="filterAndShow('Chiuso')"><div class="stat-number">48</div><div class="stat-label">Chiusi YTD</div><div class="stat-trend">‚Üë 94% success rate</div></div>
        <div class="stat-card s-freeze"><div class="stat-number">2</div><div class="stat-label">Freeze Attivi</div><div class="stat-trend">Fine Anno + Pasqua</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 340px;gap:18px">
        <div>
          <div class="table-wrap">
            <div class="table-header"><div class="table-title">Change Recenti</div><button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="showPage('changes',document.querySelector('[onclick*=\"changes\"]'))">Vedi tutti ‚Üí</button></div>
            <table><thead><tr><th>ID</th><th>Titolo</th><th>Tipo</th><th>Stato</th><th>Pipeline</th><th>Priorit√†</th></tr></thead>
            <tbody id="dashboardTable"></tbody></table>
          </div>
        </div>
        <div>
          <div class="card" style="margin-bottom:14px">
            <div class="card-title">Approvazioni Pendenti</div>
            <div id="pendingApprovals"></div>
          </div>
          <div class="card">
            <div class="card-title">Prossime Implementazioni</div>
            <div id="upcomingSchedules"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê CHANGES LIST ‚ïê‚ïê -->
    <div class="page" id="page-changes">
      <div class="table-wrap">
        <div class="table-header">
          <div class="table-title">Tutti i Change</div>
          <div class="search-bar"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Cerca..." id="searchInput" oninput="filterChanges()"></div>
          <select class="filter-select" id="filterStatus" onchange="filterChanges()">
            <option value="">Tutti gli stati</option><option>Aperto</option><option>In Review</option><option>Approvato</option><option>Schedulato</option><option>Implementazione</option><option>Chiuso</option><option>Rifiutato</option>
          </select>
          <select class="filter-select" id="filterType" onchange="filterChanges()">
            <option value="">Tutti i tipi</option><option>Standard</option><option>Normale</option><option>Emergenza</option>
          </select>
          <select class="filter-select" id="filterEnv" onchange="filterChanges()">
            <option value="">Tutti gli ambienti</option><option>DEV</option><option>INTEG</option><option>CERT</option><option>PROD</option>
          </select>
          <button class="btn btn-primary btn-sm" onclick="openNewChangeModal()">+ Nuovo</button>
        </div>
        <table><thead><tr><th>ID</th><th>Titolo</th><th>Tipo</th><th>Priorit√†</th><th>Stato</th><th>Pipeline</th><th>Richiedente</th><th>Apertura</th><th></th></tr></thead>
        <tbody id="changesTable"></tbody></table>
      </div>
    </div>

    <!-- ‚ïê‚ïê PIPELINE AMBIENTI ‚ïê‚ïê -->
    <div class="page" id="page-pipeline">
      <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px">
        <div style="font-size:14px;color:var(--text2)">Visualizzazione avanzamento change per ambiente. La promozione segue il path configurato.</div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3)"><div style="width:10px;height:10px;border-radius:50%;background:var(--accent2)"></div>Completato</div>
          <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3)"><div style="width:10px;height:10px;border-radius:50%;background:var(--accent4)"></div>In corso</div>
          <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3)"><div style="width:10px;height:10px;border-radius:50%;background:var(--accent3)"></div>Fallito</div>
          <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3)"><div style="width:10px;height:10px;border-radius:50%;background:var(--accent5)"></div>Skip (direct)</div>
        </div>
      </div>
      <div class="table-wrap">
        <div class="table-header"><div class="table-title">Stato Pipeline per Change</div></div>
        <table>
          <thead><tr><th>ID</th><th>Titolo</th><th>Tipo</th><th style="min-width:340px">DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD</th><th>Env Corrente</th><th>Azione</th></tr></thead>
          <tbody id="pipelineTable"></tbody>
        </table>
      </div>
    </div>

    <!-- ‚ïê‚ïê APPROVALS ‚ïê‚ïê -->
    <div class="page" id="page-approvals">
      <div class="table-wrap">
        <div class="table-header"><div class="table-title">Approvazioni Pendenti</div></div>
        <table><thead><tr><th>ID</th><th>Titolo</th><th>Tipo</th><th>Rischio</th><th>Richiedente</th><th>In attesa da</th><th>Dipendenze</th><th>Azione</th></tr></thead>
        <tbody id="approvalsTable"></tbody></table>
      </div>
    </div>

    <!-- ‚ïê‚ïê CAB BOARD ‚ïê‚ïê -->
    <div class="page" id="page-cab">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:18px">
        <div>
          <div style="font-size:15px;font-weight:600">CAB Meeting ‚Äî Mercoled√¨ 29 Jan 2025, 10:00</div>
          <div style="font-size:12px;color:var(--text3);margin-top:3px">Change Advisory Board ¬∑ 3 change in agenda ¬∑ 2 approvatori presenti</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn btn-ghost btn-sm">üìã Esporta Agenda</button>
          <button class="btn btn-primary btn-sm" onclick="approveAllCAB()">‚úì Approva Tutti</button>
        </div>
      </div>
      <div class="cab-grid" id="cabGrid"></div>
      <div class="card">
        <div class="card-title">Voti CAB</div>
        <table><thead><tr><th>Change</th><th>Sara Conte</th><th>Luigi Ferri</th><th>Outcome</th><th>Note</th></tr></thead>
        <tbody id="cabVotesTable"></tbody></table>
      </div>
    </div>

    <!-- ‚ïê‚ïê CALENDAR ‚ïê‚ïê -->
    <div class="page" id="page-calendar">
      <div style="display:grid;grid-template-columns:1fr 300px;gap:18px">
        <div>
          <div class="card">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
              <div class="card-title" style="margin:0">Calendario ‚Äî Febbraio 2025</div>
              <div style="margin-left:auto;display:flex;gap:8px">
                <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--accent)">‚óè Change</div>
                <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--accent5)">‚óè Freeze</div>
              </div>
            </div>
            <div class="cal-header-row"><div class="cal-hd">LUN</div><div class="cal-hd">MAR</div><div class="cal-hd">MER</div><div class="cal-hd">GIO</div><div class="cal-hd">VEN</div><div class="cal-hd">SAB</div><div class="cal-hd">DOM</div></div>
            <div class="cal-grid" id="calGrid"></div>
          </div>
          <div class="card" style="margin-top:16px">
            <div class="card-title">Freeze Periods Configurati</div>
            <div style="display:flex;flex-direction:column;gap:10px" id="freezeList"></div>
          </div>
        </div>
        <div>
          <div class="card">
            <div class="card-title">Change Schedulati</div>
            <div id="scheduledList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê REPORTS ‚ïê‚ïê -->
    <div class="page" id="page-reports">

      <!-- ‚îÄ‚îÄ FILTER PANEL ‚îÄ‚îÄ -->
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div style="font-size:15px;font-weight:600;">üîç Generatore Report</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost btn-sm" onclick="resetReportFilters()">‚Ü∫ Reset</button>
            <button class="btn btn-primary btn-sm" onclick="runReport()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
              Genera Report
            </button>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:14px;">
          <div class="form-group">
            <label>Data Apertura Da</label>
            <input type="date" id="rf-dateFrom" value="2025-01-01">
          </div>
          <div class="form-group">
            <label>Data Apertura A</label>
            <input type="date" id="rf-dateTo" value="2025-12-31">
          </div>
          <div class="form-group">
            <label>Stato</label>
            <select id="rf-status">
              <option value="">Tutti</option>
              <option>Aperto</option><option>In Review</option><option>Approvato</option>
              <option>Schedulato</option><option>Implementazione</option><option>Chiuso</option><option>Rifiutato</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tipo Change</label>
            <select id="rf-type">
              <option value="">Tutti</option>
              <option>Standard</option><option>Normale</option><option>Emergenza</option>
            </select>
          </div>
          <div class="form-group">
            <label>Priorit√†</label>
            <select id="rf-priority">
              <option value="">Tutte</option>
              <option>Critica</option><option>Alta</option><option>Media</option><option>Bassa</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ambiente</label>
            <select id="rf-env">
              <option value="">Tutti</option>
              <option>DEV</option><option>INTEG</option><option>CERT</option><option>PROD</option>
            </select>
          </div>
          <div class="form-group">
            <label>Categoria CI</label>
            <select id="rf-category">
              <option value="">Tutte</option>
              <option>Database</option><option>Network</option><option>Server</option>
              <option>Applicazioni</option><option>Storage</option><option>Security</option>
            </select>
          </div>
          <div class="form-group">
            <label>Rischio</label>
            <select id="rf-risk">
              <option value="">Tutti</option>
              <option>Basso</option><option>Medio</option><option>Alto</option><option>Critico</option>
            </select>
          </div>
          <div class="form-group">
            <label>Richiedente</label>
            <select id="rf-requester">
              <option value="">Tutti</option>
              <option>G. Bianchi</option><option>A. Russo</option><option>M. Albini</option>
              <option>S. Conte</option><option>L. Ferri</option>
            </select>
          </div>
          <div class="form-group">
            <label>Assegnato a</label>
            <select id="rf-assignee">
              <option value="">Tutti</option>
              <option>Anna Russo</option><option>Marco Albini</option>
              <option>Luigi Ferri</option><option>Sara Conte</option>
            </select>
          </div>
          <div class="form-group">
            <label>Con Incidenti Correlati</label>
            <select id="rf-incidents">
              <option value="">Indifferente</option>
              <option value="yes">S√¨</option><option value="no">No</option>
            </select>
          </div>
          <div class="form-group">
            <label>Raggruppa per</label>
            <select id="rf-groupby">
              <option value="">Nessun raggruppamento</option>
              <option value="status">Stato</option>
              <option value="type">Tipo</option>
              <option value="priority">Priorit√†</option>
              <option value="category">Categoria</option>
              <option value="assignee">Assegnato</option>
            </select>
          </div>
        </div>
        <!-- Colonne visibili -->
        <div style="border-top:1px solid var(--border);padding-top:14px;">
          <div style="font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Colonne da includere nel report</div>
          <div style="display:flex;gap:16px;flex-wrap:wrap;" id="colToggles"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ REPORT RESULTS ‚îÄ‚îÄ -->
      <div id="reportResults" style="display:none;">
        <!-- KPI Summary -->
        <div class="kpi-row" id="reportKpis" style="margin-bottom:18px;"></div>

        <!-- Charts row -->
        <div class="reports-grid" id="reportCharts" style="margin-bottom:20px;"></div>

        <!-- Table + export -->
        <div class="table-wrap">
          <div class="table-header">
            <div class="table-title" id="reportTableTitle">Risultati</div>
            <div style="font-size:12px;color:var(--text3);font-family:var(--mono);" id="reportCount"></div>
            <div style="margin-left:auto;display:flex;gap:8px;">
              <button class="btn btn-ghost btn-sm" onclick="exportCSV()">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                CSV
              </button>
              <button class="btn btn-ghost btn-sm" onclick="exportExcel()" style="color:var(--accent2);border-color:rgba(0,212,170,.3);">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
                Excel
              </button>
              <button class="btn btn-ghost btn-sm" onclick="exportPDF()" style="color:var(--accent3);border-color:rgba(255,107,107,.3);">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                PDF
              </button>
            </div>
          </div>
          <div id="reportTableWrap" style="overflow-x:auto;">
            <table id="reportTable">
              <thead id="reportThead"></thead>
              <tbody id="reportTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div id="reportEmptyState" style="text-align:center;padding:60px 20px;color:var(--text3);">
        <div style="font-size:48px;margin-bottom:16px;">üìä</div>
        <div style="font-size:16px;font-weight:600;color:var(--text2);margin-bottom:8px;">Configura e genera il tuo report</div>
        <div style="font-size:13px;">Imposta i filtri sopra e clicca <strong style="color:var(--accent)">Genera Report</strong></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê INCIDENTS ‚ïê‚ïê -->
    <div class="page" id="page-incidents">
      <div style="margin-bottom:16px;font-size:13px;color:var(--text2)">Incidenti causati o correlati a change recenti. Ogni incidente √® collegabile a uno o pi√π change tramite la scheda dettaglio.</div>
      <div class="table-wrap">
        <div class="table-header"><div class="table-title">Incidenti Correlati a Change</div></div>
        <table><thead><tr><th>ID Incidente</th><th>Descrizione</th><th>Severit√†</th><th>Change Correlato</th><th>Stato</th><th>Data</th><th>Risoluzione</th></tr></thead>
        <tbody id="incidentsTable"></tbody></table>
      </div>
    </div>

    <!-- ‚ïê‚ïê CMDB ‚ïê‚ïê -->
    <div class="page" id="page-cmdb">
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:18px">
        <div>
          <div class="table-wrap">
            <div class="table-header">
              <div class="table-title">Configuration Items</div>
              <div class="search-bar"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Cerca CI..."></div>
              <select class="filter-select"><option value="">Tutti i tipi</option><option>Server</option><option>Database</option><option>Network</option><option>Application</option></select>
            </div>
            <table><thead><tr><th>CI</th><th>Tipo</th><th>Ambiente</th><th>Owner</th><th>Stato</th><th>Change Aperti</th></tr></thead>
            <tbody id="cmdbTable"></tbody></table>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Relazioni CI</div>
          <div style="font-size:12px;color:var(--text3);margin-bottom:12px">Seleziona un CI per vedere le dipendenze</div>
          <div id="cmdbRelations"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê CONFIG ‚ïê‚ïê -->
    <div class="page" id="page-config">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
        <div class="card">
          <div class="card-title">Utenti e Ruoli</div>
          <table style="width:100%;font-size:13px">
            <thead><tr><th style="background:none;padding:8px 0;border-bottom:1px solid var(--border)">Utente</th><th style="background:none;padding:8px 0;border-bottom:1px solid var(--border)">Ruolo</th><th style="background:none;border-bottom:1px solid var(--border)">Stato</th></tr></thead>
            <tbody>
              <tr><td style="padding:9px 0">Marco Albini</td><td><span class="badge badge-approved">Change Manager</span></td><td><span style="color:var(--accent2);font-size:11px">‚óè Attivo</span></td></tr>
              <tr><td style="padding:9px 0">Sara Conte</td><td><span class="badge badge-review">CAB Member</span></td><td><span style="color:var(--accent2);font-size:11px">‚óè Attivo</span></td></tr>
              <tr><td style="padding:9px 0">Luigi Ferri</td><td><span class="badge badge-review">CAB Member</span></td><td><span style="color:var(--accent2);font-size:11px">‚óè Attivo</span></td></tr>
              <tr><td style="padding:9px 0">Anna Russo</td><td><span class="type-badge">Implementer</span></td><td><span style="color:var(--accent2);font-size:11px">‚óè Attivo</span></td></tr>
              <tr><td style="padding:9px 0">Gianni Bianchi</td><td><span class="type-badge">Richiedente</span></td><td><span style="color:var(--accent2);font-size:11px">‚óè Attivo</span></td></tr>
            </tbody>
          </table>
        </div>
        <div>
          <div class="card" style="margin-bottom:14px">
            <div class="card-title">Pipeline Ambienti</div>
            <div style="font-size:13px;color:var(--text2);margin-bottom:10px">Path standard di promozione:</div>
            <div style="display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:13px">
              <span style="background:rgba(79,124,255,.15);color:var(--accent);padding:4px 10px;border-radius:5px">DEV</span>
              <span style="color:var(--text3)">‚Üí</span>
              <span style="background:rgba(255,169,77,.15);color:var(--accent4);padding:4px 10px;border-radius:5px">INTEG</span>
              <span style="color:var(--text3)">‚Üí</span>
              <span style="background:rgba(192,132,252,.15);color:var(--accent5);padding:4px 10px;border-radius:5px">CERT</span>
              <span style="color:var(--text3)">‚Üí</span>
              <span style="background:rgba(0,212,170,.15);color:var(--accent2);padding:4px 10px;border-radius:5px">PROD</span>
            </div>
            <div style="margin-top:12px;font-size:12px;color:var(--text3)">I change di tipo <strong style="color:var(--text2)">Standard</strong> e <strong style="color:var(--text2)">Emergenza</strong> possono bypassare uno o pi√π ambienti con approvazione speciale.</div>
          </div>
          <div class="card">
            <div class="card-title">Notifiche Automatiche</div>
            <div style="display:flex;flex-direction:column;gap:8px;font-size:13px;color:var(--text2)">
              <div style="display:flex;justify-content:space-between"><span>Apertura change</span><span style="color:var(--accent2)">‚úì Email + Slack</span></div>
              <div style="display:flex;justify-content:space-between"><span>Richiesta approvazione</span><span style="color:var(--accent2)">‚úì Email + Slack</span></div>
              <div style="display:flex;justify-content:space-between"><span>Promozione ambiente</span><span style="color:var(--accent2)">‚úì Slack</span></div>
              <div style="display:flex;justify-content:space-between"><span>Freeze violation</span><span style="color:var(--accent3)">‚úì Email urgente</span></div>
              <div style="display:flex;justify-content:space-between"><span>Escalation (48h)</span><span style="color:var(--accent4)">‚úì Email Manager</span></div>
              <div style="display:flex;justify-content:space-between"><span>Incidente correlato</span><span style="color:var(--accent2)">‚úì Email + PagerDuty</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- ‚ïê‚ïê‚ïê‚ïê MODAL: NUOVO CHANGE ‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="newChangeModal">
  <div class="modal">
    <div class="modal-header">
      <div><div class="modal-title">Nuovo Change Request</div><div class="modal-subtitle">Compila tutti i campi obbligatori</div></div>
      <button class="modal-close" onclick="closeModal('newChangeModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-section">
        <div class="form-section-title">üìã Informazioni Generali</div>
        <div class="form-grid">
          <div class="form-group full"><label>Titolo *</label><input type="text" id="newTitle" placeholder="Descrizione breve del change..."></div>
          <div class="form-group"><label>Tipo Change *</label><select id="newType"><option>Standard</option><option>Normale</option><option>Emergenza</option></select></div>
          <div class="form-group"><label>Priorit√† *</label><select id="newPriority"><option>Bassa</option><option>Media</option><option>Alta</option><option>Critica</option></select></div>
          <div class="form-group"><label>Categoria CI</label><select id="newCategory"><option>Database</option><option>Network</option><option>Server</option><option>Applicazioni</option><option>Storage</option><option>Security</option></select></div>
          <div class="form-group"><label>Assegnato a</label><select id="newAssignee"><option>Anna Russo</option><option>Marco Albini</option><option>Luigi Ferri</option></select></div>
          <div class="form-group full"><label>Descrizione *</label><textarea id="newDesc" placeholder="Descrizione dettagliata, motivazione, sistemi impattati..."></textarea></div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">üåç Pipeline Ambienti</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Strategia Deployment</label>
            <select id="newPipelineStrategy" onchange="updatePipelinePreview()">
              <option value="full">Completo: DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD</option>
              <option value="skip-dev">Skip DEV: INTEG ‚Üí CERT ‚Üí PROD</option>
              <option value="direct">Direct to PROD (solo Emergenza)</option>
              <option value="custom">Personalizzato</option>
            </select>
          </div>
          <div class="form-group"><label>Ambiente di Partenza</label><select id="newStartEnv"><option>DEV</option><option>INTEG</option><option>CERT</option><option>PROD</option></select></div>
          <div class="form-group full">
            <label>Anteprima Pipeline</label>
            <div id="pipelinePreview" style="background:var(--surface2);border-radius:8px;padding:12px;display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:12px;color:var(--text2)">
              DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD
            </div>
          </div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">üîó Dipendenze</div>
        <div class="form-group full">
          <label>Change Prerequisiti</label>
          <select id="newDeps" multiple style="height:70px">
            <option value="CHG-2025-001">CHG-2025-001 ‚Äî Aggiornamento firmware switch</option>
            <option value="CHG-2025-003">CHG-2025-003 ‚Äî Migrazione database</option>
            <option value="CHG-2025-006">CHG-2025-006 ‚Äî Espansione storage</option>
          </select>
          <div style="font-size:11px;color:var(--text3);margin-top:4px">Tieni CTRL premuto per selezionare pi√π change</div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">üõ° Valutazione Rischio</div>
        <div class="form-grid">
          <div class="form-group"><label>Livello di Rischio</label><select id="newRisk"><option>Basso</option><option>Medio</option><option>Alto</option><option>Critico</option></select></div>
          <div class="form-group"><label>Impatto</label><select id="newImpact"><option>Basso</option><option>Medio</option><option>Alto</option></select></div>
          <div class="form-group full"><label>Piano di Rollback</label><textarea id="newRollback" placeholder="Procedure di rollback in caso di fallimento..."></textarea></div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">üìÖ Pianificazione</div>
        <div class="form-grid">
          <div class="form-group"><label>Data Inizio Prevista</label><input type="datetime-local" id="newStart"></div>
          <div class="form-group"><label>Data Fine Prevista</label><input type="datetime-local" id="newEnd"></div>
          <div class="form-group full"><label>Test Plan</label><textarea id="newTest" placeholder="Come verr√† verificato il corretto completamento..."></textarea></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('newChangeModal')">Annulla</button>
      <button class="btn btn-primary" onclick="submitNewChange()">‚úì Invia Change Request</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MODAL: DETAIL ‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="detailModal">
  <div class="modal modal-wide">
    <div class="modal-header">
      <div style="flex:1">
        <div class="modal-title" id="detailTitle"></div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap" id="detailBadges"></div>
      </div>
      <button class="modal-close" onclick="closeModal('detailModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <!-- Workflow stepper -->
      <div class="workflow" id="detailWorkflow"></div>
      <!-- Approval bar -->
      <div id="approvalBar" style="display:none" class="approval-bar">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <div class="approval-text">In attesa di approvazione <strong>CAB</strong></div>
        <button class="btn btn-success btn-sm" onclick="approveChange()">‚úì Approva</button>
        <button class="btn btn-danger btn-sm" onclick="rejectChange()">‚úï Rifiuta</button>
      </div>
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab(this,'tab-detail')">Dettagli</div>
        <div class="tab" onclick="switchTab(this,'tab-pipeline')">Pipeline Ambienti</div>
        <div class="tab" onclick="switchTab(this,'tab-deps')">Dipendenze</div>
        <div class="tab" onclick="switchTab(this,'tab-incidents')">Incidenti</div>
        <div class="tab" onclick="switchTab(this,'tab-activity')">Attivit√†</div>
        <div class="tab" onclick="switchTab(this,'tab-comments')">Commenti</div>
      </div>
      <!-- Tab: Dettagli -->
      <div id="tab-detail">
        <div class="detail-grid">
          <div>
            <div class="detail-meta" id="detailMeta"></div>
            <div class="section-box"><div class="section-box-title">Descrizione</div><p id="detailDesc"></p></div>
            <div class="section-box"><div class="section-box-title">Piano di Rollback</div><p id="detailRollback"></p></div>
            <div class="section-box"><div class="section-box-title">Test Plan</div><p id="detailTest"></p></div>
          </div>
          <div>
            <div class="card" style="margin-bottom:12px">
              <div class="card-title">Azioni</div>
              <div id="detailActions" style="display:flex;flex-direction:column;gap:8px"></div>
            </div>
            <div class="card">
              <div class="card-title">Notifiche Inviate</div>
              <div id="detailNotifs" style="font-size:12px;color:var(--text2);display:flex;flex-direction:column;gap:6px"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- Tab: Pipeline -->
      <div id="tab-pipeline" style="display:none">
        <div class="env-panel">
          <div class="env-panel-title">Avanzamento per Ambiente</div>
          <div id="envDetailRows"></div>
        </div>
        <div id="envPromoteArea"></div>
      </div>
      <!-- Tab: Dipendenze -->
      <div id="tab-deps" style="display:none">
        <div style="margin-bottom:14px">
          <div class="section-box-title" style="margin-bottom:8px">QUESTO CHANGE DIPENDE DA</div>
          <div id="depsRequired"></div>
        </div>
        <div>
          <div class="section-box-title" style="margin-bottom:8px">BLOCCATO DA QUESTO CHANGE</div>
          <div id="depsBlocking"></div>
        </div>
      </div>
      <!-- Tab: Incidenti -->
      <div id="tab-incidents" style="display:none">
        <div id="linkedIncidents"></div>
        <button class="btn btn-ghost btn-sm" onclick="linkIncident()">+ Collega Incidente</button>
      </div>
      <!-- Tab: Attivit√† -->
      <div id="tab-activity" style="display:none">
        <div class="timeline" id="detailTimeline"></div>
      </div>
      <!-- Tab: Commenti -->
      <div id="tab-comments" style="display:none">
        <div id="detailComments"></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <div class="avatar" style="width:28px;height:28px;font-size:10px;flex-shrink:0">MA</div>
          <textarea id="commentInput" placeholder="Aggiungi un commento..." style="flex:1;min-height:54px"></textarea>
          <button class="btn btn-primary btn-sm" onclick="addComment()">Invia</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA STRUCTURES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ENVS = ['DEV','INTEG','CERT','PROD'];
const ENV_COLORS = {DEV:'#4f7cff',INTEG:'#ffa94d',CERT:'#c084fc',PROD:'#00d4aa'};

// env statuses per change: done/active/pending/failed/skip
function makeEnvStatus(active, failed, skip) {
  // active = index of current env (0-3), failed = index or -1, skip = array of skipped
  return ENVS.map((e,i) => {
    if(skip && skip.includes(i)) return 'skip';
    if(i < active) return 'done';
    if(i === active) return failed===i ? 'failed' : 'active';
    return 'pending';
  });
}

let changes = [
  { id:'CHG-2025-001', title:'Aggiornamento firmware switch core DC01', type:'Normale', priority:'Alta', status:'In Review',
    requester:'G. Bianchi', assignee:'A. Russo', category:'Network', risk:'Alto', impact:'Alto',
    opened:'2025-01-15', window:'2025-02-01 22:00',
    pipeline: makeEnvStatus(1, -1, []), pipelineStrategy:'full', currentEnv:1,
    deps:[], blocks:['CHG-2025-002'],
    incidents:[{id:'INC-0042',desc:'Flap interfaccia dopo patch precedente',sev:'P3'}],
    desc:'Aggiornamento firmware switch core DC01 alla versione 15.2.7. Necessario per CVE-2024-3892 e miglioramenti routing BGP.',
    rollback:'Downgrade alla versione 15.2.5 tramite USB recovery. Tempo: 15 min.',
    test:'Ping sweep, test BGP neighbors, verifica connettivit√† tutti segmenti.',
    comments:[{user:'S. Conte',avatar:'SC',time:'15 Jan 14:30',text:'Documentazione tecnica OK. Aggiungere notifica utenti.'},{user:'L. Ferri',avatar:'LF',time:'16 Jan 09:00',text:'Finestra confermata con operations.'}]},

  { id:'CHG-2025-002', title:'Deploy applicazione CRM v3.4.1', type:'Standard', priority:'Media', status:'Approvato',
    requester:'A. Russo', assignee:'A. Russo', category:'Applicazioni', risk:'Medio', impact:'Medio',
    opened:'2025-01-18', window:'2025-02-07 23:00',
    pipeline:[...makeEnvStatus(2,-1,[])], pipelineStrategy:'full', currentEnv:2,
    deps:['CHG-2025-001'], blocks:[],
    incidents:[],
    desc:'Deploy CRM v3.4.1: integrazione billing, nuova dashboard analytics, fix 12 bug critici.',
    rollback:'Revert container Docker v3.3.8 via pipeline CI/CD. Rollback auto se health check fallisce.',
    test:'Smoke test suite automatizzata + verifica manuale flussi critici.',
    comments:[]},

  { id:'CHG-2025-003', title:'Migrazione database Oracle ‚Üí PostgreSQL', type:'Normale', priority:'Critica', status:'Aperto',
    requester:'M. Albini', assignee:'L. Ferri', category:'Database', risk:'Critico', impact:'Alto',
    opened:'2025-01-20', window:'TBD',
    pipeline: makeEnvStatus(0,-1,[]), pipelineStrategy:'full', currentEnv:0,
    deps:[], blocks:['CHG-2025-008'],
    incidents:[],
    desc:'Migrazione DB applicativo Oracle 19c ‚Üí PostgreSQL 16. Include schema, dati storici 5 anni, stored procedure, job notturni.',
    rollback:'Oracle attivo 30 giorni post-migrazione come fallback. Replica bidirezionale durante transizione.',
    test:'Test performance query critiche. Verifica integrit√† via checksum. UAT team applicativo.',
    comments:[]},

  { id:'CHG-2025-004', title:'Sostituzione certificati SSL scaduti', type:'Standard', priority:'Alta', status:'Schedulato',
    requester:'S. Conte', assignee:'S. Conte', category:'Security', risk:'Basso', impact:'Basso',
    opened:'2025-01-22', window:'2025-01-28 02:00',
    pipeline:[...makeEnvStatus(3,-1,[0,1])], pipelineStrategy:'skip-dev', currentEnv:3,
    deps:[], blocks:[],
    incidents:[],
    desc:'Rinnovo e deploy certificati SSL/TLS per domini aziendali. Scadenza 15 febbraio 2025.',
    rollback:'Restore certificati precedenti da backup. Nessuna interruzione con rolling update.',
    test:'Verifica catena certificazione con openssl. Test HTTPS su tutti i servizi.',
    comments:[]},

  { id:'CHG-2025-005', title:'Patching emergenza server web prod', type:'Emergenza', priority:'Critica', status:'Implementazione',
    requester:'G. Bianchi', assignee:'A. Russo', category:'Server', risk:'Alto', impact:'Alto',
    opened:'2025-01-24', window:'2025-01-24 NOW',
    pipeline:[...makeEnvStatus(3,-1,[0,1,2])], pipelineStrategy:'direct', currentEnv:3,
    deps:[], blocks:[],
    incidents:[{id:'INC-0051',desc:'Exploit attivo CVE-2025-0234 rilevato in produzione',sev:'P1'}],
    desc:'Patch di sicurezza CVE-2025-0234 (CVSS 9.8) su server web PROD. Vulnerabilit√† RCE attivamente sfruttata.',
    rollback:'Snapshot VM eseguito. Rollback max 10 min via ripristino snapshot.',
    test:'Scanner vulnerabilit√† post-patch. Test funzionale applicazione.',
    comments:[{user:'M. Albini',avatar:'MA',time:'24 Jan 08:45',text:'URGENTE: Procedura emergenza CAB attivata. Autorizzazione verbale CIO.'}]},

  { id:'CHG-2025-006', title:'Espansione storage SAN cluster prod', type:'Normale', priority:'Media', status:'Aperto',
    requester:'L. Ferri', assignee:'M. Albini', category:'Storage', risk:'Medio', impact:'Medio',
    opened:'2025-01-25', window:'TBD',
    pipeline: makeEnvStatus(0,-1,[]), pipelineStrategy:'full', currentEnv:0,
    deps:[], blocks:[],
    incidents:[],
    desc:'Aggiunta 4 shelf da 48TB al cluster SAN di produzione. Crescita dati prevista Q1 2025.',
    rollback:'Rimozione shelf aggiuntivi se instabilit√†. Configurazione precedente documentata.',
    test:'Test I/O performance post-espansione. Verifica ridondanza e failover.',
    comments:[]},

  { id:'CHG-2025-007', title:'Aggiornamento policy firewall perimetrale', type:'Standard', priority:'Bassa', status:'Chiuso',
    requester:'S. Conte', assignee:'S. Conte', category:'Network', risk:'Basso', impact:'Basso',
    opened:'2025-01-10', window:'2025-01-12 22:00',
    pipeline:[...makeEnvStatus(4,-1,[0,1])], pipelineStrategy:'skip-dev', currentEnv:4,
    deps:[], blocks:[],
    incidents:[],
    desc:'Aggiornamento ruleset firewall: blocco range IP malevoli, apertura porte per partner.',
    rollback:'Restore configurazione da backup automatico firewall.',
    test:'Test connettivit√† applicazioni. Verifica blocco IP malevoli.',
    comments:[]},

  { id:'CHG-2025-008', title:'Deploy middleware ESB versione 4.2', type:'Normale', priority:'Media', status:'In Review',
    requester:'A. Russo', assignee:'L. Ferri', category:'Applicazioni', risk:'Medio', impact:'Medio',
    opened:'2025-01-26', window:'2025-02-14 22:00',
    pipeline: makeEnvStatus(1,-1,[]), pipelineStrategy:'full', currentEnv:1,
    deps:['CHG-2025-003'], blocks:[],
    incidents:[],
    desc:'Aggiornamento ESB che gestisce 47 integrazioni. Performance migliorata, nuovi connettori.',
    rollback:'Rollback v4.1.3. Configurazioni su Git.',
    test:'Test smoke 47 integrazioni. Monitoring intensivo 72h post-deploy.',
    comments:[]},

  { id:'CHG-2025-009', title:'Configurazione VPN site-to-site Milano', type:'Standard', priority:'Media', status:'Approvato',
    requester:'G. Bianchi', assignee:'A. Russo', category:'Network', risk:'Basso', impact:'Basso',
    opened:'2025-01-27', window:'2025-02-08 22:00',
    pipeline:[...makeEnvStatus(2,-1,[0])], pipelineStrategy:'skip-dev', currentEnv:2,
    deps:[], blocks:[],
    incidents:[],
    desc:'Tunnel VPN IPSec tra sede Milano e datacenter principale.',
    rollback:'Rimozione configurazione VPN, ripristino routing precedente.',
    test:'Test connettivit√† e performance VPN. Misura latenza e throughput.',
    comments:[]},

  { id:'CHG-2025-010', title:'Upgrade kernel server Linux farm web', type:'Normale', priority:'Alta', status:'Chiuso',
    requester:'M. Albini', assignee:'L. Ferri', category:'Server', risk:'Medio', impact:'Medio',
    opened:'2025-01-05', window:'2025-01-07 02:00',
    pipeline:[...makeEnvStatus(4,-1,[])], pipelineStrategy:'full', currentEnv:4,
    deps:[], blocks:[],
    incidents:[],
    desc:'Upgrade kernel Linux 5.15 ‚Üí 6.1 LTS su tutta la web farm.',
    rollback:'Boot su kernel precedente da GRUB.',
    test:'Test funzionale applicazioni. Benchmark performance.',
    comments:[]},
];

const incidents = [
  {id:'INC-0042',desc:'Flap interfaccia dopo patch firmware precedente',sev:'P3',changeId:'CHG-2025-001',status:'Chiuso',date:'2025-01-12',resolution:'Rollback patch e riapertura change con fix'},
  {id:'INC-0051',desc:'Exploit attivo CVE-2025-0234 rilevato in produzione',sev:'P1',changeId:'CHG-2025-005',status:'Risolto',date:'2025-01-24',resolution:'Patch applicata in emergenza, sistema ripristinato'},
  {id:'INC-0055',desc:'Degradazione performance DB dopo aggiornamento statistiche',sev:'P2',changeId:'CHG-2025-010',status:'Chiuso',date:'2025-01-08',resolution:'Rebuild index e aggiornamento query plan'},
];

const cmdbItems = [
  {name:'switch-core-dc01',type:'Network',env:'PROD',owner:'A. Russo',status:'Operational',changes:1},
  {name:'db-oracle-prod01',type:'Database',env:'PROD',owner:'L. Ferri',status:'Operational',changes:2},
  {name:'web-farm-01/02/03',type:'Server',env:'PROD',owner:'A. Russo',status:'Patching',changes:1},
  {name:'san-cluster-01',type:'Storage',env:'PROD',owner:'M. Albini',status:'Operational',changes:1},
  {name:'crm-app',type:'Application',env:'MULTI',owner:'A. Russo',status:'Operational',changes:1},
  {name:'firewall-peri-01',type:'Network',env:'PROD',owner:'S. Conte',status:'Operational',changes:0},
  {name:'esb-middleware',type:'Application',env:'MULTI',owner:'L. Ferri',status:'Updating',changes:1},
];

const freezePeriods = [
  {name:'Fine Anno',start:'2024-12-20',end:'2025-01-02',envs:['PROD'],color:'#c084fc'},
  {name:'Pasqua',start:'2025-04-18',end:'2025-04-22',envs:['CERT','PROD'],color:'#c084fc'},
  {name:'Black Friday',start:'2025-11-28',end:'2025-12-01',envs:['PROD'],color:'#c084fc'},
];

const notifications = [
  {text:'CHG-2025-008 √® in attesa di approvazione CAB',time:'10 min fa',read:false,id:'CHG-2025-008'},
  {text:'CHG-2025-001 promosso da DEV a INTEG con successo',time:'2 ore fa',read:false,id:'CHG-2025-001'},
  {text:'Nuovo incidente INC-0051 collegato a CHG-2025-005',time:'5 ore fa',read:false,id:'CHG-2025-005'},
  {text:'CHG-2025-004 schedulato per 28 Jan 02:00',time:'1 giorno fa',read:true,id:'CHG-2025-004'},
  {text:'Freeze period "Fine Anno" terminato il 02/01/2025',time:'2 giorni fa',read:true,id:null},
];

let currentChangeId = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATUS / WORKFLOW CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const statusConfig = {
  'Aperto':          {badge:'badge-open',        wf:0},
  'In Review':       {badge:'badge-review',       wf:1},
  'Approvato':       {badge:'badge-approved',     wf:2},
  'Schedulato':      {badge:'badge-scheduled',    wf:3},
  'Implementazione': {badge:'badge-implementing', wf:4},
  'Chiuso':          {badge:'badge-closed',       wf:5},
  'Rifiutato':       {badge:'badge-rejected',     wf:-1},
};
const wfSteps = ['Aperto','In Review','Approvato','Schedulato','Implementazione','Chiuso'];

function statusBadge(s) {
  const c = statusConfig[s] || {badge:'badge-closed'};
  return `<span class="badge ${c.badge}">${s}</span>`;
}
function prioBadge(p) {
  const icons={Critica:'üî¥',Alta:'üü†',Media:'üîµ',Bassa:'‚ö™'};
  const cls={Critica:'priority-critical',Alta:'priority-high',Media:'priority-medium',Bassa:'priority-low'};
  return `<span class="priority ${cls[p]||''}">${icons[p]||''} ${p}</span>`;
}
function riskBadge(r) {
  const m={Basso:'badge-approved',Medio:'badge-review',Alto:'badge-scheduled',Critico:'badge-rejected'};
  return `<span class="badge ${m[r]||'badge-closed'}">${r}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIPELINE RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPipelineInline(c) {
  return `<div class="env-inline">${ENVS.map((e,i)=>{
    const s = c.pipeline[i];
    const bg = s==='done'?ENV_COLORS[e] : s==='active'?ENV_COLORS[e] : s==='failed'?'#ff6b6b' : s==='skip'?'#c084fc' : 'var(--surface3)';
    const opacity = s==='pending'?'.3':'1';
    const icon = s==='done'?'‚úì' : s==='active'?'‚ñ∂' : s==='failed'?'‚úï' : s==='skip'?'‚§µ' : e[0];
    return `<div class="env-pip" style="background:${bg};opacity:${opacity};color:${s==='pending'?'var(--text3)':'#fff'}" title="${e}: ${s}">${icon}</div>${i<3?`<span class="env-arrow-sm">‚Ä∫</span>`:''}`;
  }).join('')}</div>`;
}

function renderPipelineFull(c) {
  return `<div class="env-pipeline">${ENVS.map((e,i)=>{
    const s = c.pipeline[i];
    const cls = s==='done'?'env-done' : s==='active'?'env-active' : s==='failed'?'env-failed' : s==='skip'?'env-skip' : '';
    const icon = s==='done'?'‚úì' : s==='active'?'‚ñ∂' : s==='failed'?'‚úï' : s==='skip'?'‚§µ' : (i+1);
    return `<div class="env-node ${cls}">${i<3?`<div class="wf-line"></div>`:''}
      <div class="wf-step-inner">
        <div class="env-dot">${icon}</div>
        <div class="env-label">${e}</div>
      </div></div>`;
  }).join('')}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(id, el) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const pg = document.getElementById('page-'+id);
  if(pg) pg.classList.add('active');
  if(el) el.classList.add('active');
  const titles={dashboard:'Dashboard',changes:'Tutti i Change',pipeline:'Pipeline Ambienti',approvals:'Approvazioni',cab:'CAB Board',calendar:'Calendario & Freeze',reports:'Report & Analytics',incidents:'Incidenti Correlati',cmdb:'CMDB',config:'Configurazione'};
  document.getElementById('pageTitle').textContent = titles[id]||id;
  if(id==='reports') { initReportPage(); }
  if(id==='dashboard') renderDashboard();
  if(id==='changes') renderChanges();
  if(id==='pipeline') renderPipelinePage();
  if(id==='approvals') renderApprovals();
  if(id==='cab') renderCAB();
  if(id==='calendar') renderCalendar();
  if(id==='incidents') renderIncidents();
  if(id==='cmdb') renderCMDB();
}

function filterAndShow(status) {
  showPage('changes', document.querySelectorAll('.nav-item')[1]);
  setTimeout(()=>{ document.getElementById('filterStatus').value=status; filterChanges(); },50);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const open = changes.filter(c=>c.status==='Aperto').length;
  const review = changes.filter(c=>c.status==='In Review').length;
  const impl = changes.filter(c=>c.status==='Implementazione').length;
  document.getElementById('st-open').textContent=open;
  document.getElementById('st-review').textContent=review;
  document.getElementById('st-impl').textContent=impl;

  const recent = changes.filter(c=>c.status!=='Chiuso').slice(0,6);
  document.getElementById('dashboardTable').innerHTML = recent.map(c=>`
    <tr style="cursor:pointer" onclick="openDetail('${c.id}')">
      <td><span class="change-id">${c.id}</span></td>
      <td style="font-weight:500;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.title}</td>
      <td><span class="type-badge">${c.type}</span></td>
      <td>${statusBadge(c.status)}</td>
      <td>${renderPipelineInline(c)}</td>
      <td>${prioBadge(c.priority)}</td>
    </tr>`).join('');

  const pending = changes.filter(c=>c.status==='In Review');
  document.getElementById('pendingApprovals').innerHTML = pending.length
    ? pending.map(c=>`<div style="padding:9px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="openDetail('${c.id}')">
        <div style="font-size:13px;font-weight:500;margin-bottom:3px">${c.title}</div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="change-id">${c.id}</span>${prioBadge(c.priority)}
        </div></div>`).join('')
    : '<div style="color:var(--text3);font-size:13px">Nessuna approvazione pendente ‚úì</div>';

  const sched = changes.filter(c=>['Schedulato','Approvato'].includes(c.status));
  document.getElementById('upcomingSchedules').innerHTML = sched.map(c=>`
    <div style="padding:9px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="openDetail('${c.id}')">
      <div style="font-size:13px;font-weight:500;margin-bottom:2px">${c.title}</div>
      <div style="font-size:11px;color:var(--accent);font-family:var(--mono)">${c.window!=='TBD'?c.window:'‚è≥ Da pianificare'}</div>
    </div>`).join('') || '<div style="color:var(--text3);font-size:13px">Nessuna implementazione pianificata</div>';

  document.getElementById('nbAll').textContent = changes.filter(c=>c.status!=='Chiuso').length;
  document.getElementById('nbAppr').textContent = pending.length;
  document.getElementById('nbCab').textContent = pending.length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANGES TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderChanges(data) {
  const d = data || changes;
  document.getElementById('changesTable').innerHTML = d.map(c=>`
    <tr style="cursor:pointer" onclick="openDetail('${c.id}')">
      <td><span class="change-id">${c.id}</span></td>
      <td style="font-weight:500;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
        ${c.type==='Emergenza'?'üö® ':''} ${c.title}
      </td>
      <td><span class="type-badge">${c.type}</span></td>
      <td>${prioBadge(c.priority)}</td>
      <td>${statusBadge(c.status)}</td>
      <td class="pipeline-cell">${renderPipelineInline(c)}</td>
      <td style="color:var(--text2)">${c.requester}</td>
      <td style="color:var(--text3);font-family:var(--mono);font-size:11px">${c.opened}</td>
      <td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openDetail('${c.id}')">Apri ‚Üí</button></td>
    </tr>`).join('');
}

function filterChanges() {
  const s = document.getElementById('searchInput').value.toLowerCase();
  const st = document.getElementById('filterStatus').value;
  const tp = document.getElementById('filterType').value;
  const env = document.getElementById('filterEnv').value;
  const filtered = changes.filter(c=>{
    const matchSearch = !s || c.title.toLowerCase().includes(s) || c.id.toLowerCase().includes(s);
    const matchStatus = !st || c.status===st;
    const matchType = !tp || c.type===tp;
    const matchEnv = !env || (env==='PROD' && (c.pipeline[3]==='done'||c.pipeline[3]==='active'||c.pipeline[3]==='failed'))
      || (env==='CERT' && (c.pipeline[2]==='done'||c.pipeline[2]==='active'))
      || (env==='INTEG' && (c.pipeline[1]==='done'||c.pipeline[1]==='active'))
      || (env==='DEV' && c.pipeline[0]==='active');
    return matchSearch && matchStatus && matchType && matchEnv;
  });
  renderChanges(filtered);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIPELINE PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPipelinePage() {
  const active = changes.filter(c=>!['Chiuso','Rifiutato'].includes(c.status));
  document.getElementById('pipelineTable').innerHTML = active.map(c=>`
    <tr>
      <td><span class="change-id">${c.id}</span></td>
      <td style="font-weight:500;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.title}</td>
      <td>
        <span class="type-badge">${c.type}</span>
        ${c.pipelineStrategy==='direct'?`<span class="dtp-tag" style="margin-left:4px">DIRECT</span>`:''}
      </td>
      <td>
        <div class="env-pipeline" style="min-width:320px">${ENVS.map((e,i)=>{
          const s = c.pipeline[i];
          const cls = s==='done'?'env-done':s==='active'?'env-active':s==='failed'?'env-failed':s==='skip'?'env-skip':'';
          const icon = s==='done'?'‚úì':s==='active'?'‚ñ∂':s==='failed'?'‚úï':s==='skip'?'‚§µ':(i+1);
          return `<div class="env-node ${cls}" style="cursor:pointer" onclick="openDetail('${c.id}');setTimeout(()=>document.querySelectorAll('#detailModal .tab')[1].click(),80)" title="${e}: ${s}">
            ${i<3?`<div class="wf-line"></div>`:''}
            <div class="wf-step-inner">
              <div class="env-dot">${icon}</div>
              <div class="env-label">${e}</div>
            </div></div>`;
        }).join('')}</div>
      </td>
      <td>${statusBadge(c.status)}</td>
      <td>
        ${canPromote(c) ? `<button class="promote-btn" onclick="promoteChange('${c.id}')">Promuovi ‚Üí</button>` : `<span style="font-size:11px;color:var(--text3)">${getPromoteBlock(c)}</span>`}
      </td>
    </tr>`).join('');
}

function canPromote(c) {
  if(c.status==='Chiuso'||c.status==='Rifiutato') return false;
  if(c.deps && c.deps.length > 0) {
    const unmet = c.deps.some(depId=>{
      const dep = changes.find(x=>x.id===depId);
      return dep && dep.status!=='Chiuso';
    });
    if(unmet) return false;
  }
  return ['Approvato','Schedulato','Implementazione'].includes(c.status) && c.currentEnv < 3;
}

function getPromoteBlock(c) {
  if(c.status==='In Review') return '‚è≥ In approvazione';
  if(c.status==='Aperto') return '‚è≥ Non approvato';
  if(c.currentEnv >= 3) return c.status==='Chiuso' ? '‚úì Completato' : '‚è≥ In PROD';
  if(c.deps && c.deps.length>0) {
    const unmet = c.deps.filter(d=>{ const dep=changes.find(x=>x.id===d); return dep&&dep.status!=='Chiuso'; });
    if(unmet.length) return `üîó Attende ${unmet[0]}`;
  }
  return '';
}

function promoteChange(id) {
  const c = changes.find(x=>x.id===id);
  if(!c || c.currentEnv >= 3) return;
  c.pipeline[c.currentEnv] = 'done';
  c.currentEnv++;
  c.pipeline[c.currentEnv] = 'active';
  if(c.currentEnv === 3) {
    c.status = 'Implementazione';
    addNotification(`${c.id} promosso a PROD ‚Äî implementazione avviata`);
  } else {
    addNotification(`${c.id} promosso a ${ENVS[c.currentEnv]} con successo`);
  }
  renderPipelinePage();
  renderDashboard();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPROVALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderApprovals() {
  const pend = changes.filter(c=>c.status==='In Review');
  document.getElementById('approvalsTable').innerHTML = pend.map(c=>`
    <tr>
      <td><span class="change-id">${c.id}</span></td>
      <td style="font-weight:500;cursor:pointer" onclick="openDetail('${c.id}')">${c.title}</td>
      <td><span class="type-badge">${c.type}</span></td>
      <td>${riskBadge(c.risk)}</td>
      <td style="color:var(--text2)">${c.requester}</td>
      <td style="color:var(--text3);font-family:var(--mono);font-size:11px">${c.opened}</td>
      <td style="font-size:11px">${c.deps.length ? c.deps.map(d=>`<span class="change-id">${d}</span>`).join(', ') : '<span style="color:var(--text3)">‚Äî</span>'}</td>
      <td>
        <button class="btn btn-success btn-sm" style="margin-right:6px" onclick="quickApprove('${c.id}')">‚úì Approva</button>
        <button class="btn btn-danger btn-sm" onclick="quickReject('${c.id}')">‚úï Rifiuta</button>
      </td>
    </tr>`).join('') || '<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--text3)">Nessuna approvazione pendente ‚úì</td></tr>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAB BOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const cabVotes = {};
function renderCAB() {
  const pend = changes.filter(c=>c.status==='In Review');
  pend.forEach(c=>{ if(!cabVotes[c.id]) cabVotes[c.id]={sara:null,luigi:null}; });

  document.getElementById('cabGrid').innerHTML = pend.map(c=>`
    <div class="cab-card" onclick="openDetail('${c.id}')">
      <div class="cab-card-id">${c.id}</div>
      <div class="cab-card-title">${c.title}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${statusBadge(c.status)} ${prioBadge(c.priority)} ${riskBadge(c.risk)}
      </div>
      <div class="cab-card-footer">
        <div class="cab-votes">
          <span class="vote-yes">‚úì ${Object.values(cabVotes[c.id]).filter(v=>v==='yes').length}</span>
          <span class="vote-no">‚úï ${Object.values(cabVotes[c.id]).filter(v=>v==='no').length}</span>
        </div>
        <div style="display:flex;gap:5px">
          <button class="btn btn-success btn-xs" onclick="event.stopPropagation();cabVote('${c.id}','yes')">‚úì</button>
          <button class="btn btn-danger btn-xs" onclick="event.stopPropagation();cabVote('${c.id}','no')">‚úï</button>
        </div>
      </div>
    </div>`).join('') || '<div style="color:var(--text3);font-size:13px;padding:20px">Nessun change in agenda</div>';

  document.getElementById('cabVotesTable').innerHTML = pend.map(c=>`
    <tr>
      <td><span class="change-id">${c.id}</span> ${c.title.substring(0,30)}...</td>
      <td>${voteCell(cabVotes[c.id]?.sara)}</td>
      <td>${voteCell(cabVotes[c.id]?.luigi)}</td>
      <td>${getCABOutcome(c.id)}</td>
      <td style="color:var(--text3);font-size:12px">‚Äî</td>
    </tr>`).join('');
}

function voteCell(v) {
  if(v==='yes') return `<span style="color:var(--accent2);font-weight:600">‚úì Approva</span>`;
  if(v==='no') return `<span style="color:var(--accent3);font-weight:600">‚úï Rifiuta</span>`;
  return `<span style="color:var(--text3)">In attesa</span>`;
}

function getCABOutcome(id) {
  const v = cabVotes[id];
  if(!v) return `<span style="color:var(--text3)">‚Äî</span>`;
  const yes = Object.values(v).filter(x=>x==='yes').length;
  const no = Object.values(v).filter(x=>x==='no').length;
  if(yes >= 2) return `<span style="color:var(--accent2);font-weight:600">‚úì Approvato</span>`;
  if(no >= 1) return `<span style="color:var(--accent3);font-weight:600">‚úï Rifiutato</span>`;
  return `<span style="color:var(--accent4)">‚è≥ Pending</span>`;
}

function cabVote(id, vote) {
  if(!cabVotes[id]) cabVotes[id]={sara:null,luigi:null};
  cabVotes[id].sara = vote;
  renderCAB();
}

function approveAllCAB() {
  changes.filter(c=>c.status==='In Review').forEach(c=>{
    c.status='Approvato';
    cabVotes[c.id]={sara:'yes',luigi:'yes'};
    addNotification(`${c.id} approvato dal CAB`);
  });
  renderCAB(); renderDashboard();
}

function quickApprove(id) {
  const c = changes.find(x=>x.id===id);
  c.status='Approvato';
  addNotification(`${c.id} approvato`);
  renderApprovals(); renderDashboard();
}
function quickReject(id) {
  const c = changes.find(x=>x.id===id);
  c.status='Rifiutato';
  renderApprovals(); renderDashboard();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCalendar() {
  const sched = changes.filter(c=>c.window!=='TBD');
  const scheduledDays = sched.map(c=>parseInt((c.window||'').split('-')[2])).filter(Boolean);
  // Feb freeze days (none in feb for our test data)
  let html='';
  for(let i=0;i<4;i++) html+=`<div class="cal-day"></div>`;
  for(let d=1;d<=28;d++) {
    const isToday = d===24;
    const hasChange = scheduledDays.includes(d);
    html+=`<div class="cal-day ${isToday?'today':''} ${!isToday&&hasChange?'has-change':''}">${d}${hasChange&&!isToday?`<div class="cal-pip" style="background:var(--accent)"></div>`:''}
    </div>`;
  }
  document.getElementById('calGrid').innerHTML = html;

  document.getElementById('freezeList').innerHTML = freezePeriods.map(f=>`
    <div class="freeze-period">
      <div class="freeze-icon">üîí</div>
      <div class="freeze-info">
        <div class="freeze-name">${f.name}</div>
        <div class="freeze-dates">${f.start} ‚Üí ${f.end} ¬∑ Ambienti: ${f.envs.join(', ')}</div>
      </div>
      <span class="badge badge-freeze">${new Date(f.end) > new Date('2025-01-29') ? 'Attivo' : 'Passato'}</span>
    </div>`).join('');

  document.getElementById('scheduledList').innerHTML = sched.map(c=>`
    <div style="padding:9px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="openDetail('${c.id}')">
      <div style="font-size:11px;font-family:var(--mono);color:var(--accent);margin-bottom:2px">${c.window}</div>
      <div style="font-size:13px;font-weight:500">${c.title}</div>
      <div style="margin-top:4px;display:flex;gap:6px">${statusBadge(c.status)} ${renderPipelineInline(c)}</div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INCIDENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderIncidents() {
  const sevColor = {P1:'var(--accent3)',P2:'var(--accent4)',P3:'var(--accent)',P4:'var(--text3)'};
  document.getElementById('incidentsTable').innerHTML = incidents.map(inc=>`
    <tr>
      <td><span style="font-family:var(--mono);font-size:12px;color:${sevColor[inc.sev]||'var(--accent)'}">${inc.id}</span></td>
      <td style="font-weight:500">${inc.desc}</td>
      <td><span class="badge ${inc.sev==='P1'?'badge-rejected':inc.sev==='P2'?'badge-scheduled':'badge-review'}">${inc.sev}</span></td>
      <td><span class="change-id" style="cursor:pointer" onclick="openDetail('${inc.changeId}')">${inc.changeId}</span></td>
      <td>${inc.status==='Chiuso'||inc.status==='Risolto'?`<span style="color:var(--accent2);font-size:12px">‚úì ${inc.status}</span>`:`<span style="color:var(--accent4);font-size:12px">‚è≥ ${inc.status}</span>`}</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${inc.date}</td>
      <td style="font-size:12px;color:var(--text2)">${inc.resolution}</td>
    </tr>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CMDB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const typeIcons = {Network:'üåê',Database:'üóÑ',Server:'üñ•',Application:'üì¶',Storage:'üíæ'};
const typeColors = {Network:'rgba(79,124,255,.15)',Database:'rgba(0,212,170,.15)',Server:'rgba(255,169,77,.15)',Application:'rgba(192,132,252,.15)',Storage:'rgba(255,107,107,.15)'};
function renderCMDB() {
  document.getElementById('cmdbTable').innerHTML = cmdbItems.map(ci=>`
    <tr>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="width:26px;height:26px;border-radius:6px;background:${typeColors[ci.type]||'var(--surface2)'};display:flex;align-items:center;justify-content:center;font-size:13px">${typeIcons[ci.type]||'üìÅ'}</div>
          <span style="font-family:var(--mono);font-size:12px">${ci.name}</span>
        </div>
      </td>
      <td><span class="type-badge">${ci.type}</span></td>
      <td><span style="font-size:12px;font-family:var(--mono);color:var(--text2)">${ci.env}</span></td>
      <td style="color:var(--text2)">${ci.owner}</td>
      <td><span style="font-size:12px;color:${ci.status==='Operational'?'var(--accent2)':'var(--accent4)'}">‚óè ${ci.status}</span></td>
      <td><span style="font-family:var(--mono);font-size:12px;color:${ci.changes>0?'var(--accent)':'var(--text3)'}">${ci.changes} open</span></td>
    </tr>`).join('');
  document.getElementById('cmdbRelations').innerHTML = `<div style="color:var(--text3);font-size:12px">Clicca su un CI per vedere le relazioni</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetail(id) {
  currentChangeId = id;
  const c = changes.find(x=>x.id===id);
  if(!c) return;

  document.getElementById('detailTitle').textContent = `${c.id} ‚Äî ${c.title}`;
  const dtpBadge = c.pipelineStrategy==='direct' ? `<span class="dtp-tag">DIRECT TO PROD</span>` : '';
  document.getElementById('detailBadges').innerHTML = `${statusBadge(c.status)} ${prioBadge(c.priority)} <span class="type-badge">${c.type}</span> ${dtpBadge}`;

  // Workflow stepper
  const wfI = statusConfig[c.status]?.wf ?? 0;
  document.getElementById('detailWorkflow').innerHTML = wfSteps.map((step,i)=>`
    <div class="wf-step ${i<wfI?'done':''} ${i===wfI&&c.status!=='Rifiutato'?'active':''} ${c.status==='Rifiutato'&&i===1?'rejected':''}">
      <div class="wf-line"></div>
      <div class="wf-step-inner">
        <div class="wf-dot">${i<wfI?'‚úì':(c.status==='Rifiutato'&&i===1?'‚úï':(i+1))}</div>
        <div class="wf-label">${step}</div>
      </div>
    </div>`).join('');

  document.getElementById('approvalBar').style.display = c.status==='In Review'?'flex':'none';

  // Meta
  document.getElementById('detailMeta').innerHTML = `
    <div><div class="meta-label">Richiedente</div><div class="meta-value">${c.requester}</div></div>
    <div><div class="meta-label">Assegnato a</div><div class="meta-value">${c.assignee}</div></div>
    <div><div class="meta-label">Categoria CI</div><div class="meta-value">${c.category}</div></div>
    <div><div class="meta-label">Finestra</div><div class="meta-value" style="font-family:var(--mono);font-size:12px">${c.window}</div></div>
    <div><div class="meta-label">Rischio</div><div class="meta-value">${riskBadge(c.risk)}</div></div>
    <div><div class="meta-label">Impatto</div><div class="meta-value">${riskBadge(c.impact)}</div></div>
    <div><div class="meta-label">Aperto il</div><div class="meta-value" style="font-family:var(--mono);font-size:12px">${c.opened}</div></div>
    <div><div class="meta-label">Pipeline</div><div class="meta-value" style="font-size:11px;font-family:var(--mono);color:var(--text2)">${c.pipelineStrategy}</div></div>`;

  document.getElementById('detailDesc').textContent = c.desc;
  document.getElementById('detailRollback').textContent = c.rollback;
  document.getElementById('detailTest').textContent = c.test;

  // Actions
  const actions = getActions(c);
  document.getElementById('detailActions').innerHTML = actions.map(a=>`
    <button class="btn ${a.cls}" onclick="${a.fn}('${c.id}')">${a.label}</button>`).join('');

  // Notifications sent
  document.getElementById('detailNotifs').innerHTML = [
    {icon:'üìß',text:'Email inviata al richiedente'},
    {icon:'üí¨',text:'Notifica Slack #change-management'},
    {icon:'üìã',text:'CAB notificato per approvazione'},
  ].slice(0, wfI+1).map(n=>`<div style="display:flex;gap:7px;align-items:center">${n.icon} <span>${n.text}</span></div>`).join('');

  // Pipeline env detail
  document.getElementById('envDetailRows').innerHTML = ENVS.map((e,i)=>{
    const s = c.pipeline[i];
    const colors = {done:ENV_COLORS[e],active:ENV_COLORS[e],failed:'#ff6b6b',skip:'#c084fc',pending:'var(--text3)'};
    const labels = {done:'‚úì Completato',active:'‚ñ∂ In corso',failed:'‚úï Fallito',skip:'‚§µ Saltato',pending:'‚óã In attesa'};
    return `<div class="env-row">
      <div class="env-row-name" style="color:${colors[s]||'var(--text3)'}">${e}</div>
      <div class="env-row-status"><span class="badge" style="background:${colors[s]}22;color:${colors[s]};border:none">${labels[s]||'‚Äî'}</span></div>
      <div class="env-row-date">${s==='done'||s==='active'?c.opened+' (est)':'‚Äî'}</div>
      <div class="env-row-action">${s==='active'&&canPromote(c)?`<button class="promote-btn" onclick="promoteChange('${c.id}');openDetail('${c.id}')">Promuovi ‚Üí</button>`:''}
      </div>
    </div>`;
  }).join('');

  // Promote area
  document.getElementById('envPromoteArea').innerHTML = canPromote(c)
    ? `<div style="background:rgba(0,212,170,.06);border:1px solid rgba(0,212,170,.2);border-radius:8px;padding:12px 16px;display:flex;align-items:center;gap:12px">
        <span style="font-size:13px;color:var(--text2)">Pronto per promozione a <strong style="color:var(--accent2)">${ENVS[c.currentEnv+1]||'PROD'}</strong></span>
        <button class="btn btn-success btn-sm" onclick="promoteChange('${c.id}');openDetail('${c.id}')">‚ñ∂ Promuovi ora</button>
       </div>`
    : '';

  // Dependencies
  const reqDeps = c.deps||[];
  document.getElementById('depsRequired').innerHTML = reqDeps.length
    ? reqDeps.map(depId=>{
        const dep = changes.find(x=>x.id===depId);
        const blocked = dep && dep.status!=='Chiuso';
        return `<div class="dep-item">
          <span style="font-size:16px">${blocked?'üî¥':'üü¢'}</span>
          <div class="dep-arrow">‚Üê</div>
          <div class="dep-info"><div class="dep-id">${depId}</div><div class="dep-title">${dep?dep.title:'‚Äî'}</div></div>
          <div>${dep?statusBadge(dep.status):''}</div>
          ${blocked?`<span style="font-size:11px;color:var(--accent3)">‚ö† Non completato</span>`:`<span style="font-size:11px;color:var(--accent2)">‚úì OK</span>`}
        </div>`;
      }).join('')
    : '<div style="color:var(--text3);font-size:13px;padding:8px">Nessuna dipendenza</div>';

  const blockingDeps = changes.filter(x=>x.deps&&x.deps.includes(c.id));
  document.getElementById('depsBlocking').innerHTML = blockingDeps.length
    ? blockingDeps.map(dep=>`
        <div class="dep-item">
          <span style="font-size:16px">‚è≥</span>
          <div class="dep-arrow">‚Üí</div>
          <div class="dep-info"><div class="dep-id">${dep.id}</div><div class="dep-title">${dep.title}</div></div>
          <div>${statusBadge(dep.status)}</div>
        </div>`).join('')
    : '<div style="color:var(--text3);font-size:13px;padding:8px">Nessun change in attesa</div>';

  // Incidents
  const linked = incidents.filter(inc=>inc.changeId===c.id);
  document.getElementById('linkedIncidents').innerHTML = linked.length
    ? linked.map(inc=>`
        <div class="incident-item" style="margin-bottom:8px">
          <span style="font-size:16px">‚ö†</span>
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:8px">
              <span class="incident-id">${inc.id}</span>
              <span class="badge ${inc.sev==='P1'?'badge-rejected':inc.sev==='P2'?'badge-scheduled':'badge-review'}">${inc.sev}</span>
              <span style="font-size:11px;color:${inc.status==='Chiuso'||inc.status==='Risolto'?'var(--accent2)':'var(--accent4)'}">${inc.status}</span>
            </div>
            <div style="font-size:13px;color:var(--text2);margin-top:3px">${inc.desc}</div>
            <div style="font-size:11px;color:var(--text3);margin-top:2px">Risoluzione: ${inc.resolution}</div>
          </div>
        </div>`).join('')
    : '<div style="color:var(--text3);font-size:13px;padding:8px 0">Nessun incidente correlato</div>';

  // Timeline
  document.getElementById('detailTimeline').innerHTML = buildTimeline(c).map(t=>`
    <div class="tl-item">
      <div class="tl-icon">${t.icon}</div>
      <div>
        <div class="tl-header">${t.header}</div>
        <div class="tl-time">${t.time}</div>
        ${t.text?`<div class="tl-text">${t.text}</div>`:''}
      </div>
    </div>`).join('');

  // Comments
  document.getElementById('detailComments').innerHTML = (c.comments||[]).map(cm=>`
    <div class="comment">
      <div class="avatar" style="width:28px;height:28px;font-size:10px;flex-shrink:0">${cm.avatar}</div>
      <div class="comment-body">
        <div style="display:flex;justify-content:space-between"><span class="comment-author">${cm.user}</span><span class="comment-time">${cm.time}</span></div>
        <div class="comment-text">${cm.text}</div>
      </div>
    </div>`).join('') || '<div style="color:var(--text3);font-size:13px;margin-bottom:12px">Nessun commento.</div>';

  // Reset tabs
  document.querySelectorAll('#detailModal .tab').forEach((t,i)=>t.classList.toggle('active',i===0));
  ['tab-detail','tab-pipeline','tab-deps','tab-incidents','tab-activity','tab-comments'].forEach((id,i)=>{
    document.getElementById(id).style.display = i===0?'block':'none';
  });

  openModal('detailModal');
}

function buildTimeline(c) {
  const events = [
    {icon:'üìù', header:`Change aperto da ${c.requester}`, time:`${c.opened} 09:00`},
    {icon:'üîç', header:'Inviato per review CAB', time:`${c.opened} 14:00`},
    {icon:'‚úÖ', header:'Approvato dal CAB', time:`${c.opened} +2d`},
    {icon:'üìÖ', header:'Schedulato', time:`${c.opened} +3d`},
    {icon:'‚öôÔ∏è', header:'Implementazione avviata', time:`${c.opened} +4d`},
    {icon:'üèÅ', header:'Change chiuso con successo', time:`${c.opened} +5d`},
  ];
  const wfI = Math.max(0, statusConfig[c.status]?.wf ?? 0);
  return events.slice(0, wfI+1).reverse();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getActions(c) {
  const map = {
    'Aperto':         [{label:'‚Üí Invia per Review', cls:'btn-primary', fn:'advanceStatus'},{label:'‚úè Modifica', cls:'btn-ghost', fn:'noop'}],
    'In Review':      [{label:'‚úì Approva', cls:'btn-success', fn:'approveChange'},{label:'‚úï Rifiuta', cls:'btn-danger', fn:'rejectChange'},{label:'‚Üê Ritorna', cls:'btn-ghost', fn:'revertStatus'}],
    'Approvato':      [{label:'üìÖ Schedula', cls:'btn-primary', fn:'advanceStatus'},{label:'‚úï Rifiuta', cls:'btn-danger', fn:'rejectChange'}],
    'Schedulato':     [{label:'‚ñ∂ Avvia Implementazione', cls:'btn-primary', fn:'advanceStatus'},{label:'‚Üê Rimanda', cls:'btn-ghost', fn:'revertStatus'}],
    'Implementazione':[{label:'‚úì Chiudi con Successo', cls:'btn-success', fn:'advanceStatus'},{label:'‚úï Chiudi Fallito', cls:'btn-danger', fn:'closeFailure'}],
    'Chiuso':         [{label:'üîÑ Riapri', cls:'btn-ghost', fn:'reopen'}],
    'Rifiutato':      [{label:'üîÑ Riapri', cls:'btn-ghost', fn:'reopen'}],
  };
  return map[c.status] || [];
}

function advanceStatus(id) {
  const c = changes.find(x=>x.id===id);
  const wfI = statusConfig[c.status]?.wf ?? 0;
  if(wfI < wfSteps.length-1) {
    c.status = wfSteps[wfI+1];
    addNotification(`${c.id}: stato cambiato in "${c.status}"`);
    openDetail(id); renderDashboard();
  }
}
function revertStatus(id) {
  const c = changes.find(x=>x.id===id);
  const wfI = statusConfig[c.status]?.wf ?? 0;
  if(wfI>0){ c.status=wfSteps[wfI-1]; openDetail(id); renderDashboard(); }
}
function approveChange(id) { advanceStatus(id||currentChangeId); }
function rejectChange(id) {
  const c = changes.find(x=>x.id===(id||currentChangeId));
  c.status='Rifiutato'; openDetail(c.id); renderDashboard();
}
function closeFailure(id) {
  const c = changes.find(x=>x.id===id);
  c.status='Chiuso'; openDetail(id);
}
function reopen(id) {
  const c = changes.find(x=>x.id===id);
  c.status='Aperto'; openDetail(id); renderDashboard();
}
function linkIncident() { alert('In una versione reale: modale per collegare un incidente esistente dal sistema ITSM.'); }
function noop() {}

function addComment() {
  const text = document.getElementById('commentInput').value.trim();
  if(!text) return;
  const c = changes.find(x=>x.id===currentChangeId);
  const now = new Date().toLocaleString('it-IT',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
  c.comments.push({user:'Marco Albini',avatar:'MA',time:now,text});
  document.getElementById('commentInput').value='';
  openDetail(currentChangeId);
  setTimeout(()=>{ document.querySelectorAll('#detailModal .tab')[5].click(); },60);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW CHANGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updatePipelinePreview() {
  const s = document.getElementById('newPipelineStrategy').value;
  const previews = {
    full:'DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD',
    'skip-dev':'INTEG ‚Üí CERT ‚Üí PROD',
    direct:'‚ö° PROD direttamente (richiede approvazione speciale)',
    custom:'Configurazione personalizzata'
  };
  document.getElementById('pipelinePreview').textContent = previews[s]||'‚Äî';
}

function submitNewChange() {
  const title = document.getElementById('newTitle').value.trim();
  if(!title){ alert('Inserisci il titolo'); return; }
  const num = String(changes.length+1).padStart(3,'0');
  const id = `CHG-2025-${num}`;
  const today = new Date().toISOString().split('T')[0];
  const strategy = document.getElementById('newPipelineStrategy').value;
  let pipeline, startEnv;
  if(strategy==='direct') { pipeline=['skip','skip','skip','active'].map((s,i)=>i===3?'active':'skip'); startEnv=3; }
  else if(strategy==='skip-dev') { pipeline=['skip','active','pending','pending']; startEnv=1; }
  else { pipeline=['active','pending','pending','pending']; startEnv=0; }

  const selDeps = Array.from(document.getElementById('newDeps').selectedOptions).map(o=>o.value);

  changes.unshift({
    id, title,
    type: document.getElementById('newType').value,
    priority: document.getElementById('newPriority').value,
    status: 'Aperto',
    requester: 'Marco Albini',
    assignee: document.getElementById('newAssignee').value,
    category: document.getElementById('newCategory').value,
    risk: document.getElementById('newRisk').value,
    impact: document.getElementById('newImpact').value,
    opened: today, window:'TBD',
    pipeline, pipelineStrategy: strategy, currentEnv: startEnv,
    deps: selDeps, blocks:[],
    incidents:[],
    desc: document.getElementById('newDesc').value || 'Nessuna descrizione.',
    rollback: document.getElementById('newRollback').value || 'Da definire.',
    test: document.getElementById('newTest').value || 'Da definire.',
    comments:[]
  });
  addNotification(`Nuovo change ${id} creato: "${title}"`);
  closeModal('newChangeModal');
  renderDashboard(); renderChanges();
  ['newTitle','newDesc','newRollback','newTest'].forEach(fid=>{ const el=document.getElementById(fid); if(el) el.value=''; });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderNotifications() {
  document.getElementById('notifList').innerHTML = notifications.map((n,i)=>`
    <div class="notif-item ${n.read?'':'unread'}" onclick="notifClick(${i})">
      <div class="notif-dot2" style="${n.read?'opacity:0':''}" ></div>
      <div>
        <div class="notif-text">${n.text}</div>
        <div class="notif-time">${n.time}</div>
      </div>
    </div>`).join('');
}

function notifClick(i) {
  notifications[i].read = true;
  if(notifications[i].id) { closeModal('notifPanel'); openDetail(notifications[i].id); }
  renderNotifications();
}

function addNotification(text) {
  notifications.unshift({text,time:'Adesso',read:false,id:null});
  renderNotifications();
}

function markAllRead() {
  notifications.forEach(n=>n.read=true);
  renderNotifications();
}

function toggleNotif() {
  const p = document.getElementById('notifPanel');
  p.classList.toggle('open');
  renderNotifications();
}
document.addEventListener('click',e=>{
  const panel=document.getElementById('notifPanel');
  if(!panel.contains(e.target) && !e.target.closest('.notif-wrap')) panel.classList.remove('open');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function openNewChangeModal(){ openModal('newChangeModal'); }
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); }));

function switchTab(el, targetId) {
  const allTabs = ['tab-detail','tab-pipeline','tab-deps','tab-incidents','tab-activity','tab-comments'];
  document.querySelectorAll('#detailModal .tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  allTabs.forEach(id=>{ document.getElementById(id).style.display = id===targetId?'block':'none'; });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const REPORT_COLS = [
  {key:'id',        label:'ID',          always:true},
  {key:'title',     label:'Titolo',      always:true},
  {key:'type',      label:'Tipo',        def:true},
  {key:'priority',  label:'Priorit√†',    def:true},
  {key:'status',    label:'Stato',       def:true},
  {key:'category',  label:'Categoria',   def:true},
  {key:'risk',      label:'Rischio',     def:false},
  {key:'impact',    label:'Impatto',     def:false},
  {key:'requester', label:'Richiedente', def:true},
  {key:'assignee',  label:'Assegnato',   def:true},
  {key:'opened',    label:'Data Apertura', def:true},
  {key:'window',    label:'Finestra',    def:false},
  {key:'envStatus', label:'Env Corrente', def:true},
  {key:'incidents', label:'Incidenti',   def:false},
  {key:'deps',      label:'Dipendenze',  def:false},
];

let activeReportCols = new Set(REPORT_COLS.filter(c=>c.always||c.def).map(c=>c.key));
let lastReportData = [];

function initReportPage() {
  const wrap = document.getElementById('colToggles');
  if(wrap.innerHTML !== '') return;
  REPORT_COLS.filter(c=>!c.always).forEach(col=>{
    const div = document.createElement('label');
    div.className = 'col-toggle' + (activeReportCols.has(col.key)?' on':'');
    div.innerHTML = `<input type="checkbox" ${activeReportCols.has(col.key)?'checked':''} onchange="toggleCol('${col.key}',this)"> ${col.label}`;
    wrap.appendChild(div);
  });
}

function toggleCol(key, el) {
  if(el.checked) activeReportCols.add(key);
  else activeReportCols.delete(key);
  el.parentElement.classList.toggle('on', el.checked);
}

function resetReportFilters() {
  ['rf-dateFrom','rf-dateTo','rf-status','rf-type','rf-priority','rf-env','rf-category','rf-risk','rf-requester','rf-assignee','rf-incidents','rf-groupby'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(el.tagName==='INPUT') { el.value = id==='rf-dateFrom'?'2025-01-01': id==='rf-dateTo'?'2025-12-31':''; }
    else el.value = '';
  });
  document.getElementById('reportResults').style.display='none';
  document.getElementById('reportEmptyState').style.display='block';
}

function runReport() {
  const from = document.getElementById('rf-dateFrom').value;
  const to   = document.getElementById('rf-dateTo').value;
  const st   = document.getElementById('rf-status').value;
  const tp   = document.getElementById('rf-type').value;
  const pr   = document.getElementById('rf-priority').value;
  const env  = document.getElementById('rf-env').value;
  const cat  = document.getElementById('rf-category').value;
  const risk = document.getElementById('rf-risk').value;
  const req  = document.getElementById('rf-requester').value;
  const asgn = document.getElementById('rf-assignee').value;
  const inc  = document.getElementById('rf-incidents').value;
  const grp  = document.getElementById('rf-groupby').value;

  let data = changes.filter(c => {
    if(from && c.opened < from) return false;
    if(to   && c.opened > to)   return false;
    if(st   && c.status !== st) return false;
    if(tp   && c.type   !== tp) return false;
    if(pr   && c.priority !== pr) return false;
    if(cat  && c.category !== cat) return false;
    if(risk && c.risk !== risk) return false;
    if(req  && c.requester !== req) return false;
    if(asgn && c.assignee !== asgn) return false;
    if(env) {
      const idx = ENVS.indexOf(env);
      if(idx>=0 && !['done','active','failed'].includes(c.pipeline[idx])) return false;
    }
    if(inc === 'yes' && (!c.incidents || c.incidents.length===0)) return false;
    if(inc === 'no'  && c.incidents && c.incidents.length>0) return false;
    return true;
  });

  lastReportData = data;

  document.getElementById('reportEmptyState').style.display='none';
  document.getElementById('reportResults').style.display='block';

  // KPIs
  const closed   = data.filter(c=>c.status==='Chiuso').length;
  const failed   = data.filter(c=>c.status==='Rifiutato').length;
  const withInc  = data.filter(c=>c.incidents&&c.incidents.length>0).length;
  const successR = data.length>0 ? Math.round((closed/(closed+failed||1))*100) : 0;
  document.getElementById('reportKpis').innerHTML = `
    <div class="kpi"><div class="kpi-value">${data.length}</div><div class="kpi-label">Totale Change</div></div>
    <div class="kpi"><div class="kpi-value">${closed}</div><div class="kpi-label">Chiusi</div></div>
    <div class="kpi"><div class="kpi-value">${successR}%</div><div class="kpi-label">Success Rate</div></div>
    <div class="kpi"><div class="kpi-value">${withInc}</div><div class="kpi-label">Con Incidenti</div></div>`;

  // Charts
  const byStatus = groupCount(data,'status');
  const byType   = groupCount(data,'type');
  const statusColors = {'Aperto':'#ff6b6b','In Review':'#4f7cff','Approvato':'#00d4aa','Schedulato':'#ffa94d','Implementazione':'#ffa94d','Chiuso':'#525870','Rifiutato':'#ff6b6b'};
  const typeColors2  = {'Standard':'#4f7cff','Normale':'#ffa94d','Emergenza':'#ff6b6b'};

  document.getElementById('reportCharts').innerHTML = `
    <div class="chart-wrap">
      <div class="chart-title">Distribuzione per Stato</div>
      <div class="bar-chart">${Object.entries(byStatus).map(([k,v])=>{
        const pct = Math.round((v/data.length)*100);
        return `<div class="bar-row"><div class="bar-label" style="width:110px">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${statusColors[k]||'#4f7cff'}"><span class="bar-value">${v}</span></div></div></div>`;
      }).join('')}</div>
    </div>
    <div class="chart-wrap">
      <div class="chart-title">Distribuzione per Tipo</div>
      <div class="bar-chart">${Object.entries(byType).map(([k,v])=>{
        const pct = Math.round((v/data.length)*100);
        return `<div class="bar-row"><div class="bar-label">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,5)}%;background:${typeColors2[k]||'#4f7cff'}"><span class="bar-value">${v}</span></div></div></div>`;
      }).join('')}</div>
    </div>`;

  // Table title
  document.getElementById('reportTableTitle').textContent = `Risultati Report`;
  document.getElementById('reportCount').textContent = `${data.length} record trovati`;

  // Active cols
  const cols = REPORT_COLS.filter(c=>c.always||activeReportCols.has(c.key));

  // Thead
  document.getElementById('reportThead').innerHTML = `<tr>${cols.map(c=>`<th>${c.label}</th>`).join('')}</tr>`;

  // Tbody with optional grouping
  if(grp) {
    const grouped = {};
    data.forEach(c=>{ const k=c[grp]||'‚Äî'; if(!grouped[k]) grouped[k]=[]; grouped[k].push(c); });
    let html='';
    Object.entries(grouped).forEach(([gk,rows])=>{
      html+=`<tr class="report-group-header"><td colspan="${cols.length}">‚ñ∏ ${gk} (${rows.length})</td></tr>`;
      rows.forEach(c=>{ html+=`<tr>${cols.map(col=>`<td>${formatCell(c,col.key)}</td>`).join('')}</tr>`; });
      html+=`<tr class="report-subtotal"><td colspan="${cols.length-1}">Subtotale: ${rows.length} change</td><td></td></tr>`;
    });
    html+=`<tr class="report-total"><td colspan="${cols.length-1}"><strong>TOTALE: ${data.length} change</strong></td><td></td></tr>`;
    document.getElementById('reportTbody').innerHTML = html;
  } else {
    document.getElementById('reportTbody').innerHTML = data.map(c=>
      `<tr style="cursor:pointer" onclick="openDetail('${c.id}')">${cols.map(col=>`<td>${formatCell(c,col.key)}</td>`).join('')}</tr>`
    ).join('') + (data.length>0?`<tr class="report-total"><td colspan="${cols.length-1}"><strong>TOTALE: ${data.length} change</strong></td><td></td></tr>`:'<tr><td colspan="'+cols.length+'" style="text-align:center;padding:32px;color:var(--text3)">Nessun dato con i filtri selezionati</td></tr>');
  }
}

function formatCell(c, key) {
  if(key==='id') return `<span class="change-id">${c.id}</span>`;
  if(key==='status') return statusBadge(c.status);
  if(key==='priority') return prioBadge(c.priority);
  if(key==='risk'||key==='impact') return riskBadge(c[key]);
  if(key==='type') return `<span class="type-badge">${c.type}</span>`;
  if(key==='envStatus') return renderPipelineInline(c);
  if(key==='incidents') return c.incidents&&c.incidents.length ? `<span style="color:var(--accent3);font-size:12px">‚ö† ${c.incidents.length}</span>` : `<span style="color:var(--text3);font-size:12px">‚Äî</span>`;
  if(key==='deps') return c.deps&&c.deps.length ? c.deps.map(d=>`<span class="change-id">${d}</span>`).join(' ') : '‚Äî';
  if(key==='title') return `<span style="font-weight:500;max-width:220px;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c[key]}</span>`;
  if(key==='opened'||key==='window') return `<span style="font-family:var(--mono);font-size:11px;color:var(--text3)">${c[key]||'‚Äî'}</span>`;
  return c[key]||'‚Äî';
}

function formatCellPlain(c, key) {
  if(key==='envStatus') return ENVS.map((e,i)=>{ const s=c.pipeline[i]; return s==='done'?`${e}‚úì`:s==='active'?`${e}‚ñ∂`:s==='skip'?`${e}‚§µ`:`${e}‚óã`; }).join(' ‚Üí ');
  if(key==='incidents') return c.incidents&&c.incidents.length ? `${c.incidents.length} incidente/i` : '‚Äî';
  if(key==='deps') return c.deps&&c.deps.length ? c.deps.join(', ') : '‚Äî';
  return c[key]||'‚Äî';
}

function groupCount(data, key) {
  const m={};
  data.forEach(c=>{ const k=c[key]||'‚Äî'; m[k]=(m[k]||0)+1; });
  return m;
}

// ‚îÄ‚îÄ EXPORT CSV ‚îÄ‚îÄ
function exportCSV() {
  if(!lastReportData.length) return;
  const cols = REPORT_COLS.filter(c=>c.always||activeReportCols.has(c.key));
  const header = cols.map(c=>c.label).join(',');
  const rows = lastReportData.map(c=>cols.map(col=>`"${String(formatCellPlain(c,col.key)).replace(/"/g,'""')}"`).join(','));
  const csv = [header,...rows].join('\n');
  const blob = new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});
  downloadBlob(blob, `report_change_${today()}.csv`);
}

// ‚îÄ‚îÄ EXPORT EXCEL (via SheetJS CDN if available, otherwise CSV fallback) ‚îÄ‚îÄ
function exportExcel() {
  showExportModal('Excel', ()=>{
    const cols = REPORT_COLS.filter(c=>c.always||activeReportCols.has(c.key));
    // Build data array
    const header = cols.map(c=>c.label);
    const rows = lastReportData.map(c=>cols.map(col=>formatCellPlain(c,col.key)));

    if(typeof XLSX !== 'undefined') {
      const wb = XLSX.utils.book_new();
      // Main sheet
      const wsData = [header, ...rows];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      // Column widths
      ws['!cols'] = cols.map(c=>({wch: Math.max(c.label.length, 16)}));
      // Style header row (SheetJS CE doesn't support styles natively, but we set freeze)
      ws['!freeze'] = {xSplit:0, ySplit:1};
      XLSX.utils.book_append_sheet(wb, ws, 'Change Report');

      // Summary sheet
      const byStatus = groupCount(lastReportData,'status');
      const byType   = groupCount(lastReportData,'type');
      const byPrio   = groupCount(lastReportData,'priority');
      const sumRows  = [
        ['Riepilogo Report Change Management'],
        ['Generato il:', new Date().toLocaleString('it-IT')],
        ['Totale change:', lastReportData.length],
        [],
        ['Per Stato','Conteggio'],
        ...Object.entries(byStatus),
        [],
        ['Per Tipo','Conteggio'],
        ...Object.entries(byType),
        [],
        ['Per Priorit√†','Conteggio'],
        ...Object.entries(byPrio),
      ];
      const wsSummary = XLSX.utils.aoa_to_sheet(sumRows);
      XLSX.utils.book_append_sheet(wb, wsSummary, 'Riepilogo');

      XLSX.writeFile(wb, `report_change_${today()}.xlsx`);
    } else {
      // Fallback: download as CSV with .xlsx extension hint
      exportCSV();
    }
    hideExportModal();
  });
}

// ‚îÄ‚îÄ EXPORT PDF ‚îÄ‚îÄ
function exportPDF() {
  showExportModal('PDF', ()=>{
    if(typeof jspdf !== 'undefined' || typeof window.jsPDF !== 'undefined') {
      const { jsPDF } = window.jsPDF;
      const doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
      const cols = REPORT_COLS.filter(c=>c.always||activeReportCols.has(c.key));

      // Header
      doc.setFillColor(13,15,20);
      doc.rect(0,0,297,297,'F');
      doc.setTextColor(79,124,255);
      doc.setFontSize(20);
      doc.setFont('helvetica','bold');
      doc.text('ChangeFlow', 14, 18);
      doc.setTextColor(136,144,176);
      doc.setFontSize(10);
      doc.setFont('helvetica','normal');
      doc.text('Change Management Report', 14, 26);
      doc.setTextColor(82,88,112);
      doc.text(`Generato: ${new Date().toLocaleString('it-IT')} ¬∑ Totale: ${lastReportData.length} change`, 14, 32);

      // Table via autoTable
      if(typeof doc.autoTable !== 'undefined') {
        const head = [cols.map(c=>c.label)];
        const body = lastReportData.map(c=>cols.map(col=>formatCellPlain(c,col.key)));
        doc.autoTable({
          head, body,
          startY: 38,
          styles:{ fontSize:8, cellPadding:3, textColor:[232,234,246], fillColor:[21,24,32], lineColor:[42,47,69], lineWidth:.3 },
          headStyles:{ fillColor:[28,32,48], textColor:[136,144,176], fontStyle:'bold', fontSize:8 },
          alternateRowStyles:{ fillColor:[28,32,48] },
          margin:{left:14,right:14},
        });
        // Summary on new page
        doc.addPage();
        doc.setFillColor(13,15,20);
        doc.rect(0,0,297,297,'F');
        doc.setTextColor(79,124,255);
        doc.setFontSize(14);
        doc.setFont('helvetica','bold');
        doc.text('Riepilogo Statistico', 14, 20);
        const byStatus = groupCount(lastReportData,'status');
        const byType   = groupCount(lastReportData,'type');
        doc.autoTable({
          head:[['Stato','N¬∞ Change','%']],
          body: Object.entries(byStatus).map(([k,v])=>[k,v,Math.round(v/lastReportData.length*100)+'%']),
          startY:28, margin:{left:14}, tableWidth:80,
          styles:{fontSize:9,textColor:[232,234,246],fillColor:[21,24,32],lineColor:[42,47,69],lineWidth:.3},
          headStyles:{fillColor:[28,32,48],textColor:[136,144,176],fontStyle:'bold'},
          alternateRowStyles:{fillColor:[28,32,48]},
        });
        doc.autoTable({
          head:[['Tipo','N¬∞ Change']],
          body: Object.entries(byType).map(([k,v])=>[k,v]),
          startY:28, margin:{left:110}, tableWidth:60,
          styles:{fontSize:9,textColor:[232,234,246],fillColor:[21,24,32],lineColor:[42,47,69],lineWidth:.3},
          headStyles:{fillColor:[28,32,48],textColor:[136,144,176],fontStyle:'bold'},
          alternateRowStyles:{fillColor:[28,32,48]},
        });
      }
      doc.save(`report_change_${today()}.pdf`);
    } else {
      // Pure window.print fallback styled for printing
      printReport();
    }
    hideExportModal();
  });
}

function printReport() {
  const cols = REPORT_COLS.filter(c=>c.always||activeReportCols.has(c.key));
  const rows = lastReportData.map(c=>cols.map(col=>formatCellPlain(c,col.key)));
  const html = `<!DOCTYPE html><html><head><title>Change Report</title>
  <style>
    body{font-family:Arial,sans-serif;font-size:10px;color:#000;margin:20px;}
    h1{font-size:18px;color:#1a1a2e;margin-bottom:4px;}
    .sub{font-size:11px;color:#666;margin-bottom:16px;}
    table{width:100%;border-collapse:collapse;}
    th{background:#1a1a2e;color:#fff;padding:6px 8px;text-align:left;font-size:10px;}
    td{padding:5px 8px;border-bottom:1px solid #e0e0e0;font-size:10px;}
    tr:nth-child(even) td{background:#f5f5f5;}
    .total{background:#e8eaf6;font-weight:bold;}
    @media print{body{margin:0;} button{display:none;}}
  </style></head><body>
  <h1>ChangeFlow ‚Äî Change Management Report</h1>
  <div class="sub">Generato: ${new Date().toLocaleString('it-IT')} ¬∑ ${lastReportData.length} change trovati</div>
  <table>
    <thead><tr>${cols.map(c=>`<th>${c.label}</th>`).join('')}</tr></thead>
    <tbody>
      ${rows.map(r=>`<tr>${r.map(v=>`<td>${v}</td>`).join('')}</tr>`).join('')}
      <tr class="total"><td colspan="${cols.length-1}"><strong>TOTALE: ${lastReportData.length} change</strong></td><td></td></tr>
    </tbody>
  </table>
  <script>window.onload=()=>window.print();<\/script>
  </body></html>`;
  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
}

// ‚îÄ‚îÄ EXPORT HELPERS ‚îÄ‚îÄ
function today() { return new Date().toISOString().split('T')[0]; }
function downloadBlob(blob, filename) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

// Export modal
let exportCallback = null;
function showExportModal(type, cb) {
  exportCallback = cb;
  const overlay = document.createElement('div');
  overlay.className = 'export-overlay';
  overlay.id = 'exportOverlay';
  overlay.innerHTML = `
    <div class="export-modal-box">
      <div style="font-size:16px;font-weight:600;margin-bottom:6px;">Esportazione ${type} in corso...</div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:14px;">Preparazione del file con ${lastReportData.length} record</div>
      <div class="export-progress"><div class="export-progress-bar" id="expBar"></div></div>
      <div style="font-size:11px;color:var(--text3);margin-top:8px;" id="expStatus">Raccolta dati...</div>
    </div>`;
  document.body.appendChild(overlay);
  // Animate progress
  let pct = 0;
  const steps = ['Raccolta dati...','Applicazione filtri...','Formattazione colonne...','Generazione file...','Completato!'];
  const iv = setInterval(()=>{
    pct = Math.min(pct+20, 100);
    document.getElementById('expBar').style.width = pct+'%';
    document.getElementById('expStatus').textContent = steps[Math.floor(pct/20)]||'Completato!';
    if(pct >= 100) { clearInterval(iv); setTimeout(()=>{ cb(); }, 300); }
  }, 180);
}
function hideExportModal() {
  const el = document.getElementById('exportOverlay');
  if(el) el.remove();
}

// Patch showPage to init report page
const _origShowPage = showPage;
// Override reports initialization
const _origInitReport = initReportPage;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
renderDashboard();
renderChanges();
renderNotifications();

// Load external libs for export (SheetJS + jsPDF)
(function loadExportLibs() {
  const sheetjs = document.createElement('script');
  sheetjs.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  document.head.appendChild(sheetjs);
  const jspdf = document.createElement('script');
  jspdf.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
  jspdf.onload = () => {
    const autotable = document.createElement('script');
    autotable.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
    document.head.appendChild(autotable);
  };
  document.head.appendChild(jspdf);
})();
</script>
</body>
</html>
