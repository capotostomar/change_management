<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChangeFlow v3</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0f14;--surface:#151820;--surface2:#1c2030;--surface3:#242840;--border:#2a2f45;
  --accent:#4f7cff;--accent2:#00d4aa;--accent3:#ff6b6b;--accent4:#ffa94d;--accent5:#c084fc;
  --text:#e8eaf6;--text2:#8890b0;--text3:#525870;
  --font:'IBM Plex Sans',sans-serif;--mono:'IBM Plex Mono',monospace;--r:8px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;}

/* ‚ïê‚ïê LOGIN ‚ïê‚ïê */
#loginScreen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000;flex-direction:column;gap:0;}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px 44px;width:420px;box-shadow:0 32px 80px rgba(0,0,0,.6);}
.login-logo{font-family:var(--mono);font-size:26px;font-weight:600;color:var(--accent);margin-bottom:4px;}
.login-sub{font-size:11px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-bottom:32px;}
.login-label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;display:block;}
.login-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:11px 14px;font-family:var(--font);font-size:14px;color:var(--text);outline:none;transition:border-color .15s;margin-bottom:14px;}
.login-input:focus{border-color:var(--accent);}
.login-btn{width:100%;background:var(--accent);color:#fff;border:none;border-radius:var(--r);padding:13px;font-family:var(--font);font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;margin-top:8px;}
.login-btn:hover{background:#6b91ff;transform:translateY(-1px);}
.login-err{color:var(--accent3);font-size:12px;margin-top:8px;min-height:18px;}
.login-hint{margin-top:24px;padding-top:20px;border-top:1px solid var(--border);}
.login-hint-title{font-size:11px;color:var(--text3);margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;}
.login-user-pill{display:inline-block;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:11px;font-family:var(--mono);color:var(--text2);margin:3px;cursor:pointer;transition:all .1s;}
.login-user-pill:hover{border-color:var(--accent);color:var(--accent);}

/* ‚ïê‚ïê LAYOUT ‚ïê‚ïê */
#appScreen{display:none;height:100vh;flex-direction:row;}
#appScreen.visible{display:flex;}
.sidebar{width:248px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{height:58px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 22px;gap:14px;flex-shrink:0;}
.content{flex:1;overflow-y:auto;padding:26px;}

/* ‚ïê‚ïê SIDEBAR ‚ïê‚ïê */
.logo{padding:18px 20px 14px;border-bottom:1px solid var(--border);}
.logo-text{font-family:var(--mono);font-size:17px;font-weight:600;color:var(--accent);}
.logo-sub{font-size:9px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.nav{padding:10px 0;flex:1;overflow-y:auto;}
.nav-sect{padding:10px 16px 4px;font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text3);}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 18px;cursor:pointer;transition:all .12s;font-size:13px;color:var(--text2);border-left:3px solid transparent;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:rgba(79,124,255,.1);color:var(--accent);border-left-color:var(--accent);}
.nav-icon{width:15px;height:15px;opacity:.8;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-family:var(--mono);padding:1px 6px;border-radius:10px;font-weight:600;}
.nav-badge.red{background:var(--accent3);}
.nav-badge.orange{background:var(--accent4);}
.user-area{padding:14px 16px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:#fff;flex-shrink:0;}
.user-name{font-size:13px;font-weight:500;}
.user-role-tag{font-size:10px;color:var(--text3);}
.logout-btn{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--text3);font-size:16px;transition:color .12s;}
.logout-btn:hover{color:var(--accent3);}

/* ‚ïê‚ïê TOPBAR ‚ïê‚ïê */
.page-title{font-size:16px;font-weight:600;}
.topbar-right{margin-left:auto;display:flex;gap:8px;align-items:center;}
.notif-wrap{position:relative;}
.notif-dot{width:7px;height:7px;background:var(--accent3);border-radius:50%;border:2px solid var(--surface);position:absolute;top:-1px;right:-1px;}
.notif-panel{position:absolute;top:42px;right:0;width:300px;background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:300;display:none;}
.notif-panel.open{display:block;}

/* ‚ïê‚ïê BUTTONS ‚ïê‚ïê */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:var(--r);font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .12s;font-family:var(--font);}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:#6b91ff;transform:translateY(-1px);}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--surface2);color:var(--text);}
.btn-danger{background:rgba(255,107,107,.15);color:var(--accent3);border:1px solid rgba(255,107,107,.3);}
.btn-danger:hover{background:rgba(255,107,107,.25);}
.btn-success{background:rgba(0,212,170,.15);color:var(--accent2);border:1px solid rgba(0,212,170,.3);}
.btn-sm{padding:4px 10px;font-size:12px;}
.btn-xs{padding:3px 8px;font-size:11px;}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important;}

/* ‚ïê‚ïê CARDS & TABLES ‚ïê‚ïê */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;}
.card-title{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.table-header{padding:13px 17px;display:flex;align-items:center;gap:9px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.tbl-title{font-size:14px;font-weight:600;}
.search-box{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:6px 11px;}
.search-box input{background:none;border:none;outline:none;font-family:var(--font);font-size:13px;color:var(--text);width:180px;}
.search-box input::placeholder{color:var(--text3);}
.fsel{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:5px 9px;font-family:var(--font);font-size:12px;color:var(--text2);}
table{width:100%;border-collapse:collapse;}
th{padding:8px 13px;text-align:left;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);background:var(--surface2);border-bottom:1px solid var(--border);}
td{padding:11px 13px;font-size:13px;border-bottom:1px solid rgba(42,47,69,.5);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.015);}
.chg-id{font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:600;}

/* ‚ïê‚ïê BADGES ‚ïê‚ïê */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;}
.badge::before{content:'';width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.b-open{background:rgba(255,107,107,.12);color:#ff8585;}.b-open::before{background:var(--accent3);}
.b-review{background:rgba(79,124,255,.12);color:#7b9dff;}.b-review::before{background:var(--accent);}
.b-approved{background:rgba(0,212,170,.12);color:#00d4aa;}.b-approved::before{background:var(--accent2);}
.b-scheduled{background:rgba(255,169,77,.12);color:#ffa94d;}.b-scheduled::before{background:var(--accent4);}
.b-impl{background:rgba(255,169,77,.2);color:#ffbd6e;animation:pulse 2s infinite;}.b-impl::before{background:var(--accent4);}
.b-closed{background:rgba(82,88,112,.2);color:var(--text3);}.b-closed::before{background:var(--text3);}
.b-rejected{background:rgba(255,107,107,.12);color:#ff6b6b;}.b-rejected::before{background:var(--accent3);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes cfSpin{to{transform:rotate(360deg)}}
.prio{display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:500;}
.prio-c{color:var(--accent3);}.prio-h{color:var(--accent4);}.prio-m{color:var(--accent);}.prio-l{color:var(--text3);}
.type-tag{background:var(--surface3);color:var(--text2);padding:2px 7px;border-radius:4px;font-size:10px;font-family:var(--mono);}
.role-tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;font-family:var(--mono);}

/* ‚ïê‚ïê STATS ‚ïê‚ïê */
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.stat-card:hover{border-color:var(--accent);transform:translateY(-2px);}
.stat-n{font-family:var(--mono);font-size:30px;font-weight:600;line-height:1;margin-bottom:4px;}
.stat-l{font-size:12px;color:var(--text2);}
.stat-t{font-size:10px;color:var(--text3);margin-top:5px;font-family:var(--mono);}

/* ‚ïê‚ïê MODAL ‚ïê‚ïê */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(4px);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .18s;}
.modal-ov.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.6);transform:translateY(14px);transition:transform .18s;width:720px;}
.modal-ov.open .modal{transform:translateY(0);}
.modal-wide{width:920px;}
.modal-hdr{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:12px;}
.modal-title{font-size:16px;font-weight:600;}
.modal-sub{font-size:12px;color:var(--text2);margin-top:3px;}
.modal-x{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--text3);font-size:20px;line-height:1;}
.modal-x:hover{color:var(--text);}
.modal-body{padding:20px 24px;}
.modal-foot{padding:13px 24px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}

/* ‚ïê‚ïê FORM ‚ïê‚ïê */
.fg{display:flex;flex-direction:column;gap:5px;margin-bottom:14px;}
.fg label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;}
.fg input,.fg select,.fg textarea{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:9px 11px;font-family:var(--font);font-size:13px;color:var(--text);outline:none;transition:border-color .12s;width:100%;}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--accent);}
.fg textarea{resize:vertical;min-height:68px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-row.tri{grid-template-columns:1fr 1fr 1fr;}
.form-row.full{grid-template-columns:1fr;}
.form-sect{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);}
.form-sect:last-child{border:none;margin:0;padding:0;}
.form-sect-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:12px;text-transform:uppercase;letter-spacing:.8px;display:flex;align-items:center;gap:6px;}

/* ‚ïê‚ïê WORKFLOW STEPPER ‚ïê‚ïê */
.wf{display:flex;align-items:flex-start;margin:12px 0;}
.wf-step{flex:1;text-align:center;position:relative;}
.wf-line{position:absolute;top:14px;left:50%;right:-50%;height:2px;background:var(--border);}
.wf-step.done .wf-line{background:var(--accent2);}
.wf-step:last-child .wf-line{display:none;}
.wf-dot{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;z-index:1;margin:0 auto;}
.wf-step.done .wf-dot{background:var(--accent2);border-color:var(--accent2);color:#fff;}
.wf-step.active .wf-dot{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 12px rgba(79,124,255,.5);}
.wf-step.rejected .wf-dot{background:var(--accent3);border-color:var(--accent3);color:#fff;}
.wf-lbl{font-size:9px;color:var(--text3);margin-top:5px;font-weight:500;line-height:1.2;}
.wf-step.done .wf-lbl,.wf-step.active .wf-lbl{color:var(--text);}
.wf-team{font-size:8px;color:var(--text3);font-family:var(--mono);}

/* ‚ïê‚ïê ENV PIPELINE ‚ïê‚ïê */
.env-inline{display:flex;align-items:center;gap:3px;}
.env-pip{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;flex-shrink:0;}
.env-arrow-sm{color:var(--text3);font-size:9px;}

/* ‚ïê‚ïê TABS ‚ïê‚ïê */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:16px;}
.tab{padding:8px 16px;font-size:13px;font-weight:500;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .12s;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}

/* ‚ïê‚ïê TIMELINE ‚ïê‚ïê */
.tl-item{display:flex;gap:10px;margin-bottom:12px;}
.tl-dot{width:26px;height:26px;border-radius:50%;background:var(--surface2);border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;}
.tl-hdr{font-size:13px;font-weight:500;}
.tl-time{font-size:10px;color:var(--text3);font-family:var(--mono);}
.tl-body{font-size:12px;color:var(--text2);margin-top:3px;}

/* ‚ïê‚ïê COMMENT ‚ïê‚ïê */
.comment{display:flex;gap:8px;margin-bottom:10px;}
.comment-box{background:var(--surface2);border-radius:var(--r);padding:9px 12px;flex:1;}
.comment-auth{font-size:12px;font-weight:600;}
.comment-tm{font-size:10px;color:var(--text3);font-family:var(--mono);}
.comment-txt{font-size:13px;color:var(--text2);line-height:1.5;margin-top:3px;}

/* ‚ïê‚ïê CALENDAR PICKER ‚ïê‚ïê */
.cal-picker-ov{position:fixed;inset:0;z-index:500;display:none;}
.cal-picker-ov.open{display:block;}
.cal-picker{position:absolute;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 16px 48px rgba(0,0,0,.6);width:280px;z-index:501;}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.cal-nav-btn{background:none;border:none;cursor:pointer;color:var(--text2);font-size:18px;padding:4px 8px;border-radius:6px;transition:all .1s;}
.cal-nav-btn:hover{background:var(--surface2);color:var(--text);}
.cal-month-lbl{font-size:13px;font-weight:600;color:var(--text);}
.cal-dow-row{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:6px;}
.cal-dow{font-size:10px;text-align:center;color:var(--text3);font-weight:600;padding:3px 0;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-d{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:12px;border-radius:6px;cursor:pointer;color:var(--text2);transition:all .1s;}
.cal-d:hover{background:var(--surface3);color:var(--text);}
.cal-d.today{background:var(--surface3);color:var(--accent);font-weight:600;}
.cal-d.selected{background:var(--accent);color:#fff;font-weight:600;}
.cal-d.other-month{color:var(--text3);opacity:.4;}
.cal-d.disabled{opacity:.2;cursor:not-allowed;}
.cal-time-row{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}
.cal-time-lbl{font-size:11px;color:var(--text3);font-weight:600;}
.cal-time-row input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 8px;font-family:var(--mono);font-size:12px;color:var(--text);outline:none;}
.cal-foot{display:flex;gap:8px;margin-top:12px;}
.cal-foot .btn{flex:1;justify-content:center;}

/* ‚ïê‚ïê SECTION BOX ‚ïê‚ïê */
.sec-box{background:var(--surface2);border-radius:var(--r);padding:12px;margin-bottom:10px;}
.sec-box-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:6px;}
.sec-box p{font-size:13px;line-height:1.6;color:var(--text2);}

/* ‚ïê‚ïê APPROVAL BAR ‚ïê‚ïê */
.appr-bar{background:rgba(79,124,255,.06);border:1px solid rgba(79,124,255,.2);border-radius:var(--r);padding:10px 14px;display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.appr-txt{flex:1;font-size:13px;color:var(--text2);}

/* ‚ïê‚ïê ACCESS DENIED ‚ïê‚ïê */
.access-denied{text-align:center;padding:60px 20px;}
.access-denied .icon{font-size:48px;margin-bottom:16px;}
.access-denied h3{font-size:16px;font-weight:600;color:var(--text2);margin-bottom:8px;}
.access-denied p{font-size:13px;color:var(--text3);}

/* ‚ïê‚ïê CMDB ‚ïê‚ïê */
.cmdb-form-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}

/* ‚ïê‚ïê PAGE ‚ïê‚ïê */
.page{display:none;}
.page.active{display:block;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* ‚ïê‚ïê FREEZE BANNER ‚ïê‚ïê */
.freeze-banner{background:rgba(192,132,252,.08);border-bottom:1px solid rgba(192,132,252,.2);padding:6px 22px;display:flex;align-items:center;gap:8px;font-size:12px;color:#c084fc;}

/* ‚ïê‚ïê DETAIL GRID ‚ïê‚ïê */
.detail-grid{display:grid;grid-template-columns:1fr 280px;gap:16px;}
.meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.meta-lbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:3px;}
.meta-val{font-size:13px;color:var(--text);}

/* ‚ïê‚ïê TRANSITION ACTION BOX ‚ïê‚ïê */
.transition-box{background:rgba(79,124,255,.05);border:1px solid rgba(79,124,255,.15);border-radius:10px;padding:14px 16px;margin-bottom:14px;}
.transition-title{font-size:12px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;}

/* ‚ïê‚ïê REPORTS ‚ïê‚ïê */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;}
.kpi-v{font-family:var(--mono);font-size:24px;font-weight:600;color:var(--accent2);}
.kpi-l{font-size:10px;color:var(--text3);margin-top:3px;text-transform:uppercase;letter-spacing:1px;}
.bar-chart{display:flex;flex-direction:column;gap:6px;}
.bar-row{display:flex;align-items:center;gap:8px;}
.bar-lbl{width:100px;font-size:11px;color:var(--text2);text-align:right;flex-shrink:0;}
.bar-track{flex:1;height:16px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.bar-fill{height:100%;border-radius:3px;display:flex;align-items:center;padding-left:6px;transition:width .6s ease;}
.bar-val{font-size:9px;font-family:var(--mono);font-weight:600;color:#fff;}
.reports-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
.chart-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;}
.chart-title{font-size:13px;font-weight:600;margin-bottom:12px;}

/* ‚ïê‚ïê CALENDAR PAGE ‚ïê‚ïê */
.cal-pg-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cal-pg-hd{font-size:10px;text-align:center;color:var(--text3);font-weight:600;margin-bottom:6px;}
.cal-pg-hd-row{display:grid;grid-template-columns:repeat(7,1fr);}
.cal-pg-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;border-radius:6px;cursor:pointer;color:var(--text3);transition:all .1s;}
.cal-pg-day:hover{background:var(--surface3);color:var(--text);}
.cal-pg-day.has-chg{background:rgba(79,124,255,.12);color:var(--accent);font-weight:600;}
.cal-pg-day.today{background:var(--accent);color:#fff;font-weight:600;}
.cal-pip{width:4px;height:4px;border-radius:50%;margin-top:2px;}

/* ‚ïê‚ïê ROLE COLORS ‚ïê‚ïê */
.role-admin{background:rgba(255,107,107,.12);color:#ff8585;}
.role-change_manager{background:rgba(79,124,255,.12);color:#7b9dff;}
.role-change_requestor{background:rgba(0,212,170,.12);color:#00d4aa;}
.role-env_owner{background:rgba(255,169,77,.12);color:#ffa94d;}
.role-ta{background:rgba(192,132,252,.12);color:#c084fc;}
.role-tester{background:rgba(82,88,112,.2);color:var(--text3);}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">ChangeFlow</div>
    <div class="login-sub">Change Management v3.0</div>

    <!-- spinner durante fetch -->
    <div id="loginLoadingMsg" style="display:none;text-align:center;padding:20px 0 10px;color:var(--text3);font-size:13px">
      <span style="display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:cfSpin .7s linear infinite;vertical-align:middle;margin-right:7px"></span>
      Caricamento utenti da users.json...
    </div>

    <label class="login-label">Username</label>
    <input class="login-input" id="loginUser" placeholder="es. malbini" onkeydown="if(event.key==='Enter')doLogin()">
    <label class="login-label">Password</label>
    <input class="login-input" type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Accedi</button>
    <div class="login-err" id="loginErr"></div>

    <!-- sorgente utenti -->
    <div style="margin-top:10px;text-align:center">
      <span id="loginSourceTag" style="font-size:10px;font-family:var(--mono);color:var(--text3);background:var(--surface2);border:1px solid var(--border);padding:3px 9px;border-radius:20px"></span>
    </div>

    <div class="login-hint">
      <div class="login-hint-title">Accesso rapido (demo)</div>
      <div id="loginHints"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     APP SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="appScreen">
  <nav class="sidebar">
    <div class="logo">
      <div class="logo-text">ChangeFlow</div>
      <div class="logo-sub">Enterprise v3.0</div>
    </div>
    <div class="nav" id="sideNav"></div>
    <div class="user-area">
      <div class="avatar" id="sideAvatar"></div>
      <div>
        <div class="user-name" id="sideName"></div>
        <div class="user-role-tag" id="sideRoleTag"></div>
      </div>
      <button class="logout-btn" onclick="doLogout()" title="Esci">‚èª</button>
    </div>
  </nav>

  <div class="main">
    <div class="freeze-banner" id="freezeBanner" style="display:none">
      üîí <strong>FREEZE PERIOD ATTIVO:</strong>&nbsp;Fine Anno ‚Äî nessun change su PROD autorizzato
    </div>
    <div class="topbar">
      <div class="page-title" id="pageTitle">Dashboard</div>
      <div class="topbar-right">
        <button class="btn btn-ghost btn-sm" id="btnNewChange" onclick="openNewChangeModal()" style="display:none">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nuovo Change
        </button>
        <div class="notif-wrap">
          <button class="btn btn-ghost btn-sm" onclick="toggleNotifPanel()">üîî</button>
          <div class="notif-dot" id="notifDot"></div>
          <div class="notif-panel" id="notifPanel">
            <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
              <span style="font-size:13px;font-weight:600">Notifiche</span>
              <span style="font-size:10px;color:var(--text3);cursor:pointer" onclick="markAllRead()">Segna lette</span>
            </div>
            <div id="notifList" style="max-height:300px;overflow-y:auto;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- Pages injected by JS -->
      <div class="page active" id="page-dashboard"></div>
      <div class="page" id="page-changes"></div>
      <div class="page" id="page-approvals"></div>
      <div class="page" id="page-calendar"></div>
      <div class="page" id="page-reports"></div>
      <div class="page" id="page-cmdb"></div>
      <div class="page" id="page-config"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê -->
<!-- New Change Modal -->
<div class="modal-ov" id="newChangeModal">
  <div class="modal">
    <div class="modal-hdr">
      <div><div class="modal-title">Nuovo Change Request</div><div class="modal-sub">Compila tutti i campi obbligatori</div></div>
      <button class="modal-x" onclick="closeModal('newChangeModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-sect">
        <div class="form-sect-title">üìã Informazioni Generali</div>
        <div class="form-row full"><div class="fg"><label>Titolo *</label><input id="nTitle" placeholder="Descrizione breve del change..."></div></div>
        <div class="form-row">
          <div class="fg"><label>Tipo *</label><select id="nType"><option>Standard</option><option>Normale</option><option>Emergenza</option></select></div>
          <div class="fg"><label>Priorit√† *</label><select id="nPrio"><option>Bassa</option><option>Media</option><option>Alta</option><option>Critica</option></select></div>
        </div>
        <div class="form-row">
          <div class="fg"><label>Categoria CI</label><select id="nCat"><option>Database</option><option>Network</option><option>Server</option><option>Applicazioni</option><option>Storage</option><option>Security</option></select></div>
          <div class="fg"><label>Assegnato a (Team)</label><select id="nAssignee"></select></div>
        </div>
        <div class="form-row full"><div class="fg"><label>Descrizione *</label><textarea id="nDesc" placeholder="Descrizione dettagliata, motivazione, sistemi impattati..."></textarea></div></div>
      </div>
      <div class="form-sect">
        <div class="form-sect-title">üåç Pipeline Ambienti</div>
        <div class="form-row">
          <div class="fg"><label>Strategia Deployment</label>
            <select id="nPipelineStrat" onchange="updatePipelinePreview()">
              <option value="full">Completo: DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD</option>
              <option value="skip-dev">Skip DEV: INTEG ‚Üí CERT ‚Üí PROD</option>
              <option value="direct">Direct to PROD (solo Emergenza)</option>
            </select>
          </div>
          <div class="fg"><label>Anteprima</label><div id="pipelinePreview" style="background:var(--surface2);border-radius:var(--r);padding:9px 11px;font-family:var(--mono);font-size:12px;color:var(--text2)">DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD</div></div>
        </div>
      </div>
      <div class="form-sect">
        <div class="form-sect-title">üõ° Rischio & Rollback</div>
        <div class="form-row">
          <div class="fg"><label>Rischio</label><select id="nRisk"><option>Basso</option><option>Medio</option><option>Alto</option><option>Critico</option></select></div>
          <div class="fg"><label>Impatto</label><select id="nImpact"><option>Basso</option><option>Medio</option><option>Alto</option></select></div>
        </div>
        <div class="form-row full"><div class="fg"><label>Piano di Rollback</label><textarea id="nRollback" placeholder="Procedure di rollback..."></textarea></div></div>
        <div class="form-row full"><div class="fg"><label>Test Plan</label><textarea id="nTest" placeholder="Come verr√† verificato il completamento..."></textarea></div></div>
      </div>
      <div class="form-sect">
        <div class="form-sect-title">üìÖ Pianificazione</div>
        <div class="form-row">
          <div class="fg"><label>Data / Ora Inizio</label>
            <div style="position:relative">
              <input id="nStart" placeholder="Seleziona data..." readonly style="cursor:pointer" onclick="openCalPicker('nStart',event)">
            </div>
          </div>
          <div class="fg"><label>Data / Ora Fine</label>
            <div style="position:relative">
              <input id="nEnd" placeholder="Seleziona data..." readonly style="cursor:pointer" onclick="openCalPicker('nEnd',event)">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('newChangeModal')">Annulla</button>
      <button class="btn btn-primary" onclick="submitNewChange()">‚úì Invia Change Request</button>
    </div>
  </div>
</div>

<!-- Detail Change Modal -->
<div class="modal-ov" id="detailModal">
  <div class="modal modal-wide">
    <div class="modal-hdr">
      <div style="flex:1">
        <div class="modal-title" id="dTitle"></div>
        <div id="dBadges" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:5px;"></div>
      </div>
      <button class="modal-x" onclick="closeModal('detailModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="wf" id="dWorkflow"></div>
      <div id="dApprBar" style="display:none" class="appr-bar"></div>
      <div class="tabs">
        <div class="tab active" onclick="switchTab(this,'dtab-detail')">Dettagli</div>
        <div class="tab" onclick="switchTab(this,'dtab-transition')">Transizione</div>
        <div class="tab" onclick="switchTab(this,'dtab-activity')">Attivit√†</div>
        <div class="tab" onclick="switchTab(this,'dtab-comments')">Commenti</div>
      </div>
      <div id="dtab-detail"></div>
      <div id="dtab-transition" style="display:none"></div>
      <div id="dtab-activity" style="display:none"></div>
      <div id="dtab-comments" style="display:none"></div>
    </div>
  </div>
</div>

<!-- Add CI Modal -->
<div class="modal-ov" id="ciModal">
  <div class="modal">
    <div class="modal-hdr">
      <div><div class="modal-title">Aggiungi Configuration Item</div><div class="modal-sub">Il CI verr√† salvato nel CMDB</div></div>
      <button class="modal-x" onclick="closeModal('ciModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="cmdb-form-row">
        <div class="fg"><label>Nome CI *</label><input id="ciName" placeholder="es. db-prod-01"></div>
        <div class="fg"><label>Tipo *</label><select id="ciType"><option>Server</option><option>Database</option><option>Network</option><option>Application</option><option>Storage</option><option>Security</option></select></div>
        <div class="fg"><label>Ambiente</label><select id="ciEnv"><option>PROD</option><option>CERT</option><option>INTEG</option><option>DEV</option><option>MULTI</option></select></div>
        <div class="fg"><label>Owner</label><select id="ciOwner"></select></div>
        <div class="fg"><label>Stato</label><select id="ciStatus"><option>Operational</option><option>Maintenance</option><option>Decommissioned</option><option>Planning</option></select></div>
        <div class="fg"><label>Versione</label><input id="ciVersion" placeholder="es. 19.3.0"></div>
      </div>
      <div class="fg" style="margin-top:4px"><label>Note</label><textarea id="ciNotes" placeholder="Note aggiuntive sul CI..."></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('ciModal')">Annulla</button>
      <button class="btn btn-primary" onclick="submitCI()">‚úì Aggiungi CI</button>
    </div>
  </div>
</div>

<!-- Calendar Picker (floating) -->
<div id="calPickerOv" class="cal-picker-ov" onclick="closeCalPickerIfOutside(event)">
  <div class="cal-picker" id="calPicker">
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="calNavMonth(-1)">‚Äπ</button>
      <span class="cal-month-lbl" id="calMonthLbl"></span>
      <button class="cal-nav-btn" onclick="calNavMonth(1)">‚Ä∫</button>
    </div>
    <div class="cal-dow-row">
      <div class="cal-dow">Lu</div><div class="cal-dow">Ma</div><div class="cal-dow">Me</div>
      <div class="cal-dow">Gi</div><div class="cal-dow">Ve</div><div class="cal-dow">Sa</div><div class="cal-dow">Do</div>
    </div>
    <div class="cal-days" id="calDays"></div>
    <div class="cal-time-row">
      <span class="cal-time-lbl">Ora:</span>
      <input type="time" id="calTime" value="09:00">
    </div>
    <div class="cal-foot">
      <button class="btn btn-ghost btn-sm" onclick="closeCalPicker()">Annulla</button>
      <button class="btn btn-primary btn-sm" onclick="confirmCalPicker()">Conferma</button>
    </div>
  </div>
</div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS & ROLE DEFINITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ENVS = ['DEV','INTEG','CERT','PROD'];
const ENV_COLORS = {DEV:'#4f7cff',INTEG:'#ffa94d',CERT:'#c084fc',PROD:'#00d4aa'};
const ROLE_LABELS = {
  admin:'Admin',change_manager:'Change Manager',
  change_requestor:'Change Requestor',env_owner:'Environment Owner',
  ta:'Technical Architect',tester:'Tester'
};

// Workflow steps & team ownership
// Each step: {label, team_role, can_approve:[roles], can_request:[roles]}
const WF_STEPS = [
  {label:'Aperto',       team:'Change Requestor',  badge:'b-open'},
  {label:'In Review',    team:'Change Manager',     badge:'b-review'},
  {label:'Approvato',    team:'Change Manager',     badge:'b-approved'},
  {label:'Schedulato',   team:'Change Requestor',   badge:'b-scheduled'},
  {label:'Autorizzato',  team:'Env Owner / TA',     badge:'b-approved'},
  {label:'In Esecuzione',team:'Tester',             badge:'b-impl'},
  {label:'Chiuso',       team:'Change Manager',     badge:'b-closed'},
];

// Who can trigger each transition
// Key = current status ‚Üí Value = {to_status, allowed_roles, label}
const TRANSITIONS = {
  'Aperto':       [{to:'In Review',       roles:['change_requestor','change_manager','admin'], label:'‚Üí Invia per Review'},
                   {to:'Rifiutato',       roles:['change_manager','admin'],                   label:'‚úï Rifiuta / Chiudi'}],
  'In Review':    [{to:'Approvato',       roles:['change_manager','admin'],                   label:'‚úì Approva'},
                   {to:'Rifiutato',       roles:['change_manager','admin'],                   label:'‚úï Rifiuta'},
                   {to:'Aperto',          roles:['change_manager','admin'],                   label:'‚Üê Ritorna ad Aperto'}],
  'Approvato':    [{to:'Schedulato',      roles:['change_requestor','change_manager','admin'],label:'üìÖ Schedula'},
                   {to:'Rifiutato',       roles:['change_manager','admin'],                   label:'‚úï Rifiuta'}],
  'Schedulato':   [{to:'Autorizzato',     roles:['env_owner','ta','admin'],                   label:'‚úì Autorizza Implementazione'},
                   {to:'Approvato',       roles:['change_requestor','change_manager','admin'],label:'‚Üê Rimanda'}],
  'Autorizzato':  [{to:'In Esecuzione',   roles:['env_owner','ta','admin'],                   label:'‚ñ∂ Avvia Esecuzione'},
                   {to:'Schedulato',      roles:['change_manager','admin'],                   label:'‚Üê Rimanda'}],
  'In Esecuzione':[{to:'Chiuso',          roles:['tester','change_manager','admin'],          label:'‚úì Chiudi con Successo'},
                   {to:'Rifiutato',       roles:['tester','change_manager','admin'],          label:'‚úï Chiudi con Fallimento'}],
  'Chiuso':       [{to:'Aperto',          roles:['change_manager','admin'],                   label:'üîÑ Riapri'}],
  'Rifiutato':    [{to:'Aperto',          roles:['change_manager','admin'],                   label:'üîÑ Riapri'}],
};

const STATUS_BADGE = {
  'Aperto':'b-open','In Review':'b-review','Approvato':'b-approved',
  'Schedulato':'b-scheduled','Autorizzato':'b-approved','In Esecuzione':'b-impl',
  'Chiuso':'b-closed','Rifiutato':'b-rejected'
};
const STATUS_WF_IDX = {
  'Aperto':0,'In Review':1,'Approvato':2,'Schedulato':3,'Autorizzato':4,'In Esecuzione':5,'Chiuso':6,'Rifiutato':-1
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSISTENCE ‚Äî localStorage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LS_CHANGES = 'cf_changes_v3';
const LS_CMDB    = 'cf_cmdb_v3';
const LS_NOTIFS  = 'cf_notifs_v3';

function loadData(key, def) {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; }
  catch(e) { return def; }
}
function saveData(key, data) {
  try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERS ‚Äî caricati da users.json (con fallback embedded)
// Il file users.json deve stare nella stessa cartella dell'HTML.
// Se aperto come file:// locale usa il fallback; se servito via
// http (anche solo python -m http.server) legge il file reale.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const USERS_FALLBACK = [
  {id:'u001',username:'admin',   password:'admin123', name:'Admin Sistema',  initials:'AS',role:'admin',           team:'IT Management',        email:'admin@azienda.it'},
  {id:'u002',username:'malbini', password:'change123',name:'Marco Albini',   initials:'MA',role:'change_manager',  team:'Change Management',    email:'m.albini@azienda.it'},
  {id:'u003',username:'gbianchi',password:'req123',   name:'Gianni Bianchi', initials:'GB',role:'change_requestor',team:'Business Applications', email:'g.bianchi@azienda.it'},
  {id:'u004',username:'arusso',  password:'env123',   name:'Anna Russo',     initials:'AR',role:'env_owner',       team:'Infrastructure',        email:'a.russo@azienda.it'},
  {id:'u005',username:'sconte',  password:'ta123',    name:'Sara Conte',     initials:'SC',role:'ta',              team:'Technical Architecture',email:'s.conte@azienda.it'},
  {id:'u006',username:'lferri',  password:'test123',  name:'Luigi Ferri',    initials:'LF',role:'tester',          team:'QA & Testing',          email:'l.ferri@azienda.it'},
  {id:'u007',username:'cneri',   password:'req456',   name:'Carla Neri',     initials:'CN',role:'change_requestor',team:'Business Applications', email:'c.neri@azienda.it'},
];

// USERS inizia vuoto ‚Äî viene popolato da loadUsers() prima del login
let USERS = [];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEFAULT CHANGES DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CHANGES_DEFAULT = [
  {id:'CHG-2025-001',title:'Aggiornamento firmware switch core DC01',type:'Normale',priority:'Alta',status:'In Review',requesterId:'u003',assigneeId:'u004',category:'Network',risk:'Alto',impact:'Alto',opened:'2025-01-15',window:'2025-02-01 22:00',windowEnd:'2025-02-02 02:00',pipeline:['done','active','pending','pending'],pipelineStrategy:'full',currentEnv:1,deps:[],incidents:[{id:'INC-0042',desc:'Flap interfaccia dopo patch precedente',sev:'P3'}],desc:'Aggiornamento firmware switch core DC01 alla versione 15.2.7. Necessario per CVE-2024-3892 e miglioramenti routing BGP.',rollback:'Downgrade alla versione 15.2.5 tramite USB recovery. Tempo: 15 min.',test:'Ping sweep, test BGP neighbors, verifica connettivit√† tutti segmenti.',comments:[{userId:'u005',name:'Sara Conte',initials:'SC',time:'2025-01-15 14:30',text:'Documentazione tecnica OK. Aggiungere notifica utenti.'},{userId:'u006',name:'Luigi Ferri',initials:'LF',time:'2025-01-16 09:00',text:'Finestra confermata con operations.'}],history:[{action:'Change aperto',userId:'u003',time:'2025-01-15 09:00'},{action:'Inviato per Review',userId:'u003',time:'2025-01-15 11:00'}]},
  {id:'CHG-2025-002',title:'Deploy applicazione CRM v3.4.1',type:'Standard',priority:'Media',status:'Autorizzato',requesterId:'u004',assigneeId:'u004',category:'Applicazioni',risk:'Medio',impact:'Medio',opened:'2025-01-18',window:'2025-02-07 23:00',windowEnd:'2025-02-08 03:00',pipeline:['done','done','done','pending'],pipelineStrategy:'full',currentEnv:3,deps:['CHG-2025-001'],incidents:[],desc:'Deploy CRM v3.4.1: integrazione billing, nuova dashboard analytics, fix 12 bug critici.',rollback:'Revert container Docker v3.3.8 via pipeline CI/CD.',test:'Smoke test suite automatizzata + verifica manuale flussi critici.',comments:[],history:[{action:'Change aperto',userId:'u004',time:'2025-01-18 09:00'},{action:'Inviato per Review',userId:'u004',time:'2025-01-18 14:00'},{action:'Approvato dal Change Manager',userId:'u002',time:'2025-01-19 10:00'},{action:'Schedulato',userId:'u003',time:'2025-01-20 09:00'},{action:'Autorizzato dall\'Env Owner',userId:'u004',time:'2025-01-21 10:00'}]},
  {id:'CHG-2025-003',title:'Migrazione database Oracle ‚Üí PostgreSQL',type:'Normale',priority:'Critica',status:'Aperto',requesterId:'u002',assigneeId:'u006',category:'Database',risk:'Critico',impact:'Alto',opened:'2025-01-20',window:'',windowEnd:'',pipeline:['active','pending','pending','pending'],pipelineStrategy:'full',currentEnv:0,deps:[],incidents:[],desc:'Migrazione DB applicativo Oracle 19c ‚Üí PostgreSQL 16. Include schema, dati storici 5 anni, stored procedure, job notturni.',rollback:'Oracle attivo 30 giorni post-migrazione come fallback. Replica bidirezionale durante transizione.',test:'Test performance query critiche. Verifica integrit√† via checksum. UAT team applicativo.',comments:[],history:[{action:'Change aperto',userId:'u002',time:'2025-01-20 09:00'}]},
  {id:'CHG-2025-004',title:'Sostituzione certificati SSL scaduti',type:'Standard',priority:'Alta',status:'Chiuso',requesterId:'u005',assigneeId:'u005',category:'Security',risk:'Basso',impact:'Basso',opened:'2025-01-10',window:'2025-01-28 02:00',windowEnd:'2025-01-28 04:00',pipeline:['skip','skip','done','done'],pipelineStrategy:'skip-dev',currentEnv:4,deps:[],incidents:[],desc:'Rinnovo e deploy certificati SSL/TLS per domini aziendali. Scadenza 15 febbraio 2025.',rollback:'Restore certificati precedenti da backup.',test:'Verifica catena certificazione con openssl. Test HTTPS su tutti i servizi.',comments:[],history:[{action:'Change aperto',userId:'u005',time:'2025-01-10 09:00'},{action:'Approvato',userId:'u002',time:'2025-01-11 10:00'},{action:'Schedulato',userId:'u003',time:'2025-01-12 09:00'},{action:'Autorizzato',userId:'u004',time:'2025-01-12 14:00'},{action:'Esecuzione avviata',userId:'u006',time:'2025-01-28 02:05'},{action:'Chiuso con successo',userId:'u006',time:'2025-01-28 03:45'}]},
  {id:'CHG-2025-005',title:'Patching emergenza server web prod',type:'Emergenza',priority:'Critica',status:'In Esecuzione',requesterId:'u003',assigneeId:'u004',category:'Server',risk:'Alto',impact:'Alto',opened:'2025-01-24',window:'2025-01-24 09:00',windowEnd:'2025-01-24 12:00',pipeline:['skip','skip','skip','active'],pipelineStrategy:'direct',currentEnv:3,deps:[],incidents:[{id:'INC-0051',desc:'Exploit attivo CVE-2025-0234 rilevato in produzione',sev:'P1'}],desc:'Patch di sicurezza CVE-2025-0234 (CVSS 9.8) su server web PROD. Vulnerabilit√† RCE attivamente sfruttata.',rollback:'Snapshot VM eseguito. Rollback max 10 min via ripristino snapshot.',test:'Scanner vulnerabilit√† post-patch. Test funzionale applicazione.',comments:[{userId:'u002',name:'Marco Albini',initials:'MA',time:'2025-01-24 08:45',text:'URGENTE: Procedura emergenza CAB attivata. Autorizzazione verbale CIO.'}],history:[{action:'Change aperto (EMERGENZA)',userId:'u003',time:'2025-01-24 08:30'},{action:'Autorizzato in emergenza',userId:'u004',time:'2025-01-24 08:50'},{action:'Esecuzione avviata',userId:'u006',time:'2025-01-24 09:05'}]},
  {id:'CHG-2025-006',title:'Espansione storage SAN cluster prod',type:'Normale',priority:'Media',status:'Aperto',requesterId:'u006',assigneeId:'u002',category:'Storage',risk:'Medio',impact:'Medio',opened:'2025-01-25',window:'',windowEnd:'',pipeline:['active','pending','pending','pending'],pipelineStrategy:'full',currentEnv:0,deps:[],incidents:[],desc:'Aggiunta 4 shelf da 48TB al cluster SAN di produzione. Crescita dati prevista Q1 2025.',rollback:'Rimozione shelf aggiuntivi se instabilit√†.',test:'Test I/O performance post-espansione. Verifica ridondanza e failover.',comments:[],history:[{action:'Change aperto',userId:'u006',time:'2025-01-25 09:00'}]},
];

const CMDB_DEFAULT = [
  {id:'ci001',name:'switch-core-dc01',type:'Network',env:'PROD',ownerId:'u004',status:'Operational',version:'15.2.5',notes:'Switch core principale DC01',createdAt:'2024-01-10'},
  {id:'ci002',name:'db-oracle-prod01',type:'Database',env:'PROD',ownerId:'u006',status:'Operational',version:'19c',notes:'Database applicativo principale',createdAt:'2024-01-10'},
  {id:'ci003',name:'web-farm-prod',type:'Server',env:'PROD',ownerId:'u004',status:'Maintenance',version:'Linux 5.15',notes:'Farm server web produzione (3 nodi)',createdAt:'2024-01-10'},
  {id:'ci004',name:'san-cluster-01',type:'Storage',env:'PROD',ownerId:'u002',status:'Operational',version:'‚Äî',notes:'Cluster SAN principale',createdAt:'2024-01-10'},
  {id:'ci005',name:'crm-app',type:'Application',env:'MULTI',ownerId:'u004',status:'Operational',version:'3.3.8',notes:'CRM aziendale',createdAt:'2024-01-10'},
  {id:'ci006',name:'firewall-perimetrale',type:'Security',env:'PROD',ownerId:'u005',status:'Operational',version:'v9.1.4',notes:'Firewall perimetrale principale',createdAt:'2024-01-10'},
];

let changes = loadData(LS_CHANGES, null) || JSON.parse(JSON.stringify(CHANGES_DEFAULT));
if(!changes.length) { changes = JSON.parse(JSON.stringify(CHANGES_DEFAULT)); saveData(LS_CHANGES, changes); }
let cmdbItems = loadData(LS_CMDB, null) || JSON.parse(JSON.stringify(CMDB_DEFAULT));
if(!cmdbItems.length) { cmdbItems = JSON.parse(JSON.stringify(CMDB_DEFAULT)); saveData(LS_CMDB, cmdbItems); }
let notifications = loadData(LS_NOTIFS, []);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;
let currentChangeId = null;

function canDo(roles) { return roles.includes(currentUser?.role); }
function canSee(change) {
  if(!currentUser) return false;
  const r = currentUser.role;
  if(r==='admin'||r==='change_manager') return true;
  if(r==='change_requestor') return change.requesterId===currentUser.id || change.assigneeId===currentUser.id || USERS.find(u=>u.id===change.requesterId)?.team===currentUser.team;
  if(r==='env_owner'||r==='ta'||r==='tester') return change.assigneeId===currentUser.id;
  return false;
}
function visibleChanges() { return changes.filter(canSee); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initLogin() {
  const hints = document.getElementById('loginHints');
  USERS.forEach(u=>{
    const pill = document.createElement('span');
    pill.className='login-user-pill';
    pill.textContent=`${u.username} (${ROLE_LABELS[u.role]||u.role})`;
    pill.onclick=()=>{ document.getElementById('loginUser').value=u.username; document.getElementById('loginPass').value=u.password; };
    hints.appendChild(pill);
  });
}

function doLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass  = document.getElementById('loginPass').value;
  const found = USERS.find(u=>u.username===user && u.password===pass);
  if(!found) { document.getElementById('loginErr').textContent='Credenziali non valide'; return; }
  currentUser = found;
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('appScreen').classList.add('visible');
  setupApp();
}
function doLogout() {
  currentUser=null;
  document.getElementById('appScreen').classList.remove('visible');
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
  document.getElementById('loginErr').textContent='';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP SETUP (post-login)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NAV_ITEMS = [
  {id:'dashboard',label:'Dashboard',icon:'grid',roles:['admin','change_manager','change_requestor','env_owner','ta','tester']},
  {id:'changes',  label:'Change',   icon:'list',roles:['admin','change_manager','change_requestor','env_owner','ta','tester'],badge:'nbAll'},
  {id:'approvals',label:'Approvazioni',icon:'check',roles:['admin','change_manager'],badge:'nbAppr',badgeClass:'red'},
  {id:'calendar', label:'Calendario',icon:'cal',roles:['admin','change_manager','change_requestor','env_owner']},
  {id:'reports',  label:'Report',   icon:'bar',roles:['admin','change_manager']},
  {id:'cmdb',     label:'CMDB',     icon:'srv',roles:['admin','change_manager','env_owner','ta']},
  {id:'config',   label:'Config / Utenti',icon:'cog',roles:['admin']},
];

const ICONS = {
  grid:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>',
  list:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/></svg>',
  check:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
  cal:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
  bar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
  srv:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
  cog:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 010 14.14M4.93 4.93a10 10 0 000 14.14"/></svg>',
};

function setupApp() {
  // Sidebar user info
  document.getElementById('sideAvatar').textContent = currentUser.initials;
  document.getElementById('sideName').textContent = currentUser.name;
  document.getElementById('sideRoleTag').textContent = ROLE_LABELS[currentUser.role]||currentUser.role;

  // Show "Nuovo" button for requestors & managers
  const canCreate = ['admin','change_manager','change_requestor'].includes(currentUser.role);
  document.getElementById('btnNewChange').style.display = canCreate ? 'inline-flex' : 'none';

  // Build nav
  const nav = document.getElementById('sideNav');
  nav.innerHTML='';
  let first = null;
  NAV_ITEMS.forEach(item=>{
    if(!item.roles.includes(currentUser.role)) return;
    const div = document.createElement('div');
    div.className='nav-item'+(first===null?' active':'');
    div.id='nav-'+item.id;
    div.innerHTML=`<svg class="nav-icon">${ICONS[item.icon]||''}</svg> ${item.label} ${item.badge?`<span class="nav-badge ${item.badgeClass||''}" id="${item.badge}">0</span>`:''}`;
    div.onclick=()=>showPage(item.id, div);
    nav.appendChild(div);
    if(first===null) first=item.id;
  });

  // Populate assignee select in new change form
  populateAssigneeSelect();
  populateCIOwnerSelect();

  renderNotifList();
  showPage(first||'dashboard', document.getElementById('nav-'+(first||'dashboard')));
}

function populateAssigneeSelect() {
  const sel = document.getElementById('nAssignee');
  if(!sel) return;
  sel.innerHTML = USERS.map(u=>`<option value="${u.id}">${u.name} (${ROLE_LABELS[u.role]})</option>`).join('');
}
function populateCIOwnerSelect() {
  const sel = document.getElementById('ciOwner');
  if(!sel) return;
  sel.innerHTML = USERS.map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION & PAGE RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(id, el) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const pg = document.getElementById('page-'+id);
  if(pg) { pg.classList.add('active'); pg.innerHTML=''; }
  if(el) el.classList.add('active');
  const titles={dashboard:'Dashboard',changes:'Tutti i Change',approvals:'Approvazioni',calendar:'Calendario',reports:'Report',cmdb:'CMDB',config:'Configurazione'};
  document.getElementById('pageTitle').textContent = titles[id]||id;
  if(id==='dashboard')  renderDashboard();
  if(id==='changes')    renderChanges();
  if(id==='approvals')  renderApprovals();
  if(id==='calendar')   renderCalendar();
  if(id==='reports')    renderReports();
  if(id==='cmdb')       renderCMDB();
  if(id==='config')     renderConfig();
  updateBadges();
}

function updateBadges() {
  const vc = visibleChanges();
  const el = id=>document.getElementById(id);
  if(el('nbAll')) el('nbAll').textContent = vc.filter(c=>c.status!=='Chiuso').length;
  if(el('nbAppr')) el('nbAppr').textContent = vc.filter(c=>c.status==='In Review').length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BADGE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sBadge(s) { return `<span class="badge ${STATUS_BADGE[s]||'b-closed'}">${s}</span>`; }
function pBadge(p) {
  const m={Critica:['üî¥','prio-c'],Alta:['üü†','prio-h'],Media:['üîµ','prio-m'],Bassa:['‚ö™','prio-l']};
  const [icon,cls]=m[p]||['',''];
  return `<span class="prio ${cls}">${icon} ${p}</span>`;
}
function rBadge(r) {
  const m={Critico:'b-rejected',Alto:'b-scheduled',Medio:'b-review',Basso:'b-approved'};
  return `<span class="badge ${m[r]||'b-closed'}">${r}</span>`;
}
function userName(id) { return USERS.find(u=>u.id===id)?.name || '‚Äî'; }
function userInitials(id) { return USERS.find(u=>u.id===id)?.initials || '?'; }
function envInline(c) {
  return `<div class="env-inline">${ENVS.map((e,i)=>{
    const s=c.pipeline[i];
    const bg=s==='done'?ENV_COLORS[e]:s==='active'?ENV_COLORS[e]:s==='skip'?'#c084fc':'var(--surface3)';
    const op=s==='pending'?'.35':'1';
    const ic=s==='done'?'‚úì':s==='active'?'‚ñ∂':s==='skip'?'‚§µ':e[0];
    return `<div class="env-pip" style="background:${bg};opacity:${op};color:${s==='pending'?'var(--text3)':'#fff'}">${ic}</div>${i<3?`<span class="env-arrow-sm">‚Ä∫</span>`:''}`;
  }).join('')}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const vc = visibleChanges();
  const open   = vc.filter(c=>c.status==='Aperto').length;
  const review = vc.filter(c=>c.status==='In Review').length;
  const auth   = vc.filter(c=>['Autorizzato','In Esecuzione'].includes(c.status)).length;
  const closed = vc.filter(c=>c.status==='Chiuso').length;
  const pg = document.getElementById('page-dashboard');
  pg.innerHTML=`
  <div class="stats-grid">
    <div class="stat-card" style="--bc:var(--accent3)" onclick="navFilter('Aperto')"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent3)"></div><div class="stat-n" style="color:var(--accent3)">${open}</div><div class="stat-l">Aperti</div><div class="stat-t">‚Üë cambia filtro</div></div>
    <div class="stat-card" onclick="navFilter('In Review')"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent)"></div><div class="stat-n" style="color:var(--accent)">${review}</div><div class="stat-l">In Approvazione</div><div class="stat-t">CAB Review</div></div>
    <div class="stat-card" onclick="navFilter('Autorizzato')"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent4)"></div><div class="stat-n" style="color:var(--accent4)">${auth}</div><div class="stat-l">Autorizzati/In Esecuzione</div><div class="stat-t">‚Üí Live</div></div>
    <div class="stat-card" onclick="navFilter('Chiuso')"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent2)"></div><div class="stat-n" style="color:var(--accent2)">${closed}</div><div class="stat-l">Chiusi</div><div class="stat-t">‚Üë YTD</div></div>
    <div class="stat-card"><div style="position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent5)"></div><div class="stat-n" style="color:var(--accent5)">${vc.length}</div><div class="stat-l">Totali Visibili</div><div class="stat-t">${ROLE_LABELS[currentUser.role]}</div></div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 320px;gap:16px">
    <div class="table-wrap">
      <div class="table-header"><div class="tbl-title">Change Recenti</div><button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="showPage('changes',document.getElementById('nav-changes'))">Vedi tutti ‚Üí</button></div>
      <table><thead><tr><th>ID</th><th>Titolo</th><th>Stato</th><th>Pipeline</th><th>Priorit√†</th><th>Assegnato</th></tr></thead>
      <tbody>${vc.filter(c=>c.status!=='Chiuso').slice(0,7).map(c=>`
        <tr style="cursor:pointer" onclick="openDetail('${c.id}')">
          <td><span class="chg-id">${c.id}</span></td>
          <td style="font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.title}</td>
          <td>${sBadge(c.status)}</td>
          <td>${envInline(c)}</td>
          <td>${pBadge(c.priority)}</td>
          <td style="color:var(--text2)">${userName(c.assigneeId)}</td>
        </tr>`).join('')}</tbody></table>
    </div>
    <div>
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Mie Azioni Richieste</div>
        ${getMyActions()}
      </div>
      <div class="card">
        <div class="card-title">Prossime Implementazioni</div>
        ${vc.filter(c=>c.window&&['Schedulato','Autorizzato'].includes(c.status)).map(c=>`
          <div style="padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="openDetail('${c.id}')">
            <div style="font-size:11px;font-family:var(--mono);color:var(--accent)">${c.window}</div>
            <div style="font-size:13px;font-weight:500;margin-top:2px">${c.title}</div>
          </div>`).join('') || '<div style="color:var(--text3);font-size:13px">Nessuna implementazione pianificata</div>'}
      </div>
    </div>
  </div>`;
}

function getMyActions() {
  const vc = visibleChanges();
  const actions = [];
  vc.forEach(c=>{
    const trans = (TRANSITIONS[c.status]||[]).filter(t=>t.roles.includes(currentUser.role));
    if(trans.length) actions.push({c, trans:trans[0]});
  });
  if(!actions.length) return '<div style="color:var(--text3);font-size:13px">Nessuna azione richiesta ‚úì</div>';
  return actions.slice(0,4).map(({c,trans})=>`
    <div style="padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="openDetail('${c.id}')">
      <div style="font-size:13px;font-weight:500;margin-bottom:3px">${c.title}</div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="chg-id">${c.id}</span>
        <span style="font-size:11px;color:var(--accent4)">${trans.label}</span>
      </div>
    </div>`).join('');
}

function navFilter(status) {
  showPage('changes', document.getElementById('nav-changes'));
  setTimeout(()=>{ const s=document.getElementById('fStatus'); if(s){ s.value=status; filterChanges(); } },50);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANGES TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderChanges(data) {
  const d = data || visibleChanges();
  document.getElementById('page-changes').innerHTML=`
  <div class="table-wrap">
    <div class="table-header">
      <div class="tbl-title">Change (${d.length})</div>
      <div class="search-box"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input id="fSearch" placeholder="Cerca..." oninput="filterChanges()"></div>
      <select class="fsel" id="fStatus" onchange="filterChanges()"><option value="">Tutti gli stati</option>${Object.keys(STATUS_BADGE).map(s=>`<option>${s}</option>`).join('')}</select>
      <select class="fsel" id="fType" onchange="filterChanges()"><option value="">Tutti i tipi</option><option>Standard</option><option>Normale</option><option>Emergenza</option></select>
      ${canDo(['admin','change_manager','change_requestor'])?`<button class="btn btn-primary btn-sm" onclick="openNewChangeModal()">+ Nuovo</button>`:''}
    </div>
    <table><thead><tr><th>ID</th><th>Titolo</th><th>Tipo</th><th>Priorit√†</th><th>Stato</th><th>Pipeline</th><th>Richiedente</th><th>Assegnato</th><th>Apertura</th><th></th></tr></thead>
    <tbody>${d.map(c=>`
      <tr style="cursor:pointer" onclick="openDetail('${c.id}')">
        <td><span class="chg-id">${c.id}</span></td>
        <td style="font-weight:500;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.type==='Emergenza'?'üö® ':''}${c.title}</td>
        <td><span class="type-tag">${c.type}</span></td>
        <td>${pBadge(c.priority)}</td>
        <td>${sBadge(c.status)}</td>
        <td>${envInline(c)}</td>
        <td style="color:var(--text2)">${userName(c.requesterId)}</td>
        <td style="color:var(--text2)">${userName(c.assigneeId)}</td>
        <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${c.opened}</td>
        <td><button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openDetail('${c.id}')">‚Üí</button></td>
      </tr>`).join('')}</tbody></table>
  </div>`;
}

function filterChanges() {
  const s   = (document.getElementById('fSearch')?.value||'').toLowerCase();
  const st  = document.getElementById('fStatus')?.value||'';
  const tp  = document.getElementById('fType')?.value||'';
  const d = visibleChanges().filter(c=>
    (!s  || c.title.toLowerCase().includes(s)||c.id.toLowerCase().includes(s)) &&
    (!st || c.status===st) &&
    (!tp || c.type===tp)
  );
  renderChanges(d);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPROVALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderApprovals() {
  const pend = visibleChanges().filter(c=>c.status==='In Review');
  document.getElementById('page-approvals').innerHTML=`
  <div class="table-wrap">
    <div class="table-header"><div class="tbl-title">Approvazioni Pendenti</div></div>
    <table><thead><tr><th>ID</th><th>Titolo</th><th>Tipo</th><th>Rischio</th><th>Richiedente</th><th>In attesa da</th><th>Azione</th></tr></thead>
    <tbody>${pend.map(c=>`
      <tr>
        <td><span class="chg-id">${c.id}</span></td>
        <td style="font-weight:500;cursor:pointer" onclick="openDetail('${c.id}')">${c.title}</td>
        <td><span class="type-tag">${c.type}</span></td>
        <td>${rBadge(c.risk)}</td>
        <td>${userName(c.requesterId)}</td>
        <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${c.opened}</td>
        <td>
          ${canDo(['change_manager','admin'])?`
            <button class="btn btn-success btn-sm" onclick="quickTransition('${c.id}','Approvato')">‚úì Approva</button>
            <button class="btn btn-danger btn-sm" onclick="quickTransition('${c.id}','Rifiutato')" style="margin-left:5px">‚úï Rifiuta</button>
          `:'<span style="color:var(--text3);font-size:12px">Solo Change Manager</span>'}
        </td>
      </tr>`).join('')||`<tr><td colspan="7" style="text-align:center;padding:32px;color:var(--text3)">Nessuna approvazione pendente ‚úì</td></tr>`}
    </tbody></table>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCalendar() {
  const vc = visibleChanges();
  const sched = vc.filter(c=>c.window);
  const scheduledDays = sched.map(c=>{ try{ return new Date(c.window).getDate(); }catch(e){return null;} }).filter(Boolean);
  let cells='';
  for(let i=0;i<3;i++) cells+=`<div class="cal-pg-day"></div>`;
  for(let d=1;d<=28;d++){
    const isToday=(d===24);
    const has=scheduledDays.includes(d);
    cells+=`<div class="cal-pg-day ${isToday?'today':''} ${!isToday&&has?'has-chg':''}">${d}${has&&!isToday?`<div class="cal-pip" style="background:var(--accent)"></div>`:''}</div>`;
  }
  document.getElementById('page-calendar').innerHTML=`
  <div style="display:grid;grid-template-columns:1fr 280px;gap:16px">
    <div class="card">
      <div class="card-title">Calendario ‚Äî Febbraio 2025</div>
      <div class="cal-pg-hd-row">${['LUN','MAR','MER','GIO','VEN','SAB','DOM'].map(d=>`<div class="cal-pg-hd">${d}</div>`).join('')}</div>
      <div class="cal-pg-grid">${cells}</div>
    </div>
    <div class="card">
      <div class="card-title">Change Schedulati</div>
      ${sched.map(c=>`
        <div style="padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="openDetail('${c.id}')">
          <div style="font-size:11px;font-family:var(--mono);color:var(--accent)">${c.window}</div>
          <div style="font-size:13px;font-weight:500;margin-top:2px">${c.title}</div>
          <div style="margin-top:3px">${sBadge(c.status)} ${envInline(c)}</div>
        </div>`).join('')||'<div style="color:var(--text3);font-size:13px">Nessuna schedulazione</div>'}
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReports() {
  if(!canDo(['admin','change_manager'])){ document.getElementById('page-reports').innerHTML=accessDenied('Report'); return; }
  const vc = visibleChanges();
  const byStatus = {};
  vc.forEach(c=>{ byStatus[c.status]=(byStatus[c.status]||0)+1; });
  const byType={};
  vc.forEach(c=>{ byType[c.type]=(byType[c.type]||0)+1; });
  const closed=vc.filter(c=>c.status==='Chiuso').length;
  const total=vc.length;
  document.getElementById('page-reports').innerHTML=`
  <div class="kpi-row">
    <div class="kpi"><div class="kpi-v">${total}</div><div class="kpi-l">Totale Change</div></div>
    <div class="kpi"><div class="kpi-v">${closed}</div><div class="kpi-l">Chiusi</div></div>
    <div class="kpi"><div class="kpi-v">${total?Math.round(closed/total*100):0}%</div><div class="kpi-l">Success Rate</div></div>
    <div class="kpi"><div class="kpi-v">${vc.filter(c=>c.incidents&&c.incidents.length).length}</div><div class="kpi-l">Con Incidenti</div></div>
  </div>
  <div class="reports-grid">
    <div class="chart-wrap"><div class="chart-title">Per Stato</div><div class="bar-chart">${Object.entries(byStatus).map(([k,v])=>{
      const pct=Math.round(v/(total||1)*100);
      const col={Aperto:'#ff6b6b','In Review':'#4f7cff',Approvato:'#00d4aa',Schedulato:'#ffa94d',Autorizzato:'#00d4aa','In Esecuzione':'#ffa94d',Chiuso:'#525870',Rifiutato:'#ff6b6b'}[k]||'#4f7cff';
      return `<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,4)}%;background:${col}"><span class="bar-val">${v}</span></div></div></div>`;
    }).join('')}</div></div>
    <div class="chart-wrap"><div class="chart-title">Per Tipo</div><div class="bar-chart">${Object.entries(byType).map(([k,v])=>{
      const pct=Math.round(v/(total||1)*100);
      const col={Standard:'#4f7cff',Normale:'#ffa94d',Emergenza:'#ff6b6b'}[k]||'#4f7cff';
      return `<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,4)}%;background:${col}"><span class="bar-val">${v}</span></div></div></div>`;
    }).join('')}</div></div>
  </div>
  <div class="table-wrap">
    <div class="table-header"><div class="tbl-title">Dettaglio per Richiedente</div></div>
    <table><thead><tr><th>Utente</th><th>Ruolo</th><th>Change Aperti</th><th>In Review</th><th>Chiusi</th></tr></thead>
    <tbody>${USERS.map(u=>{
      const uc=changes.filter(c=>c.requesterId===u.id);
      return `<tr><td>${u.name}</td><td><span class="role-tag role-${u.role}">${ROLE_LABELS[u.role]}</span></td><td>${uc.filter(c=>c.status==='Aperto').length}</td><td>${uc.filter(c=>c.status==='In Review').length}</td><td>${uc.filter(c=>c.status==='Chiuso').length}</td></tr>`;
    }).join('')}</tbody></table>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CMDB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CI_ICONS={Network:'üåê',Database:'üóÑ',Server:'üñ•',Application:'üì¶',Storage:'üíæ',Security:'üîí'};
function renderCMDB() {
  document.getElementById('page-cmdb').innerHTML=`
  <div style="display:grid;grid-template-columns:1fr 280px;gap:16px">
    <div class="table-wrap">
      <div class="table-header">
        <div class="tbl-title">Configuration Items (${cmdbItems.length})</div>
        ${canDo(['admin','change_manager','env_owner'])?`<button class="btn btn-primary btn-sm" style="margin-left:auto" onclick="openModal('ciModal')">+ Aggiungi CI</button>`:''}
      </div>
      <table><thead><tr><th>CI</th><th>Tipo</th><th>Ambiente</th><th>Owner</th><th>Stato</th><th>Versione</th><th>Change</th></tr></thead>
      <tbody>${cmdbItems.map(ci=>`
        <tr>
          <td><div style="display:flex;align-items:center;gap:8px"><span style="font-size:16px">${CI_ICONS[ci.type]||'üìÅ'}</span><span style="font-family:var(--mono);font-size:12px">${ci.name}</span></div></td>
          <td><span class="type-tag">${ci.type}</span></td>
          <td style="font-family:var(--mono);font-size:11px">${ci.env}</td>
          <td style="color:var(--text2)">${userName(ci.ownerId)}</td>
          <td><span style="font-size:12px;color:${ci.status==='Operational'?'var(--accent2)':'var(--accent4)'}">‚óè ${ci.status}</span></td>
          <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${ci.version||'‚Äî'}</td>
          <td><span style="font-family:var(--mono);font-size:12px;color:var(--accent)">${changes.filter(c=>c.category===ci.type&&c.status!=='Chiuso').length}</span></td>
        </tr>`).join('')}</tbody></table>
    </div>
    <div class="card">
      <div class="card-title">Riepilogo per Tipo</div>
      ${Object.entries(CI_ICONS).map(([t,ic])=>{
        const cnt=cmdbItems.filter(c=>c.type===t).length;
        return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><span style="font-size:18px">${ic}</span><span style="font-size:13px;flex:1">${t}</span><span style="font-family:var(--mono);font-size:13px;font-weight:600;color:var(--accent)">${cnt}</span></div>`;
      }).join('')}
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderConfig() {
  if(!canDo(['admin'])){ document.getElementById('page-config').innerHTML=accessDenied('Configurazione'); return; }
  document.getElementById('page-config').innerHTML=`
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div class="table-wrap">
      <div class="table-header"><div class="tbl-title">Utenti & Ruoli</div></div>
      <table><thead><tr><th>Nome</th><th>Username</th><th>Ruolo</th><th>Team</th><th>Email</th></tr></thead>
      <tbody>${USERS.map(u=>`
        <tr><td>${u.name}</td><td style="font-family:var(--mono);font-size:12px;color:var(--accent)">${u.username}</td>
        <td><span class="role-tag role-${u.role}">${ROLE_LABELS[u.role]}</span></td>
        <td style="color:var(--text2)">${u.team}</td>
        <td style="font-size:12px;color:var(--text3)">${u.email}</td></tr>`).join('')}</tbody></table>
    </div>
    <div>
      <div class="card" style="margin-bottom:14px">
        <div class="card-title">Matrice Permessi Workflow</div>
        <table style="font-size:12px">
          <thead><tr><th style="background:none">Transizione</th><th style="background:none">Ruoli Autorizzati</th></tr></thead>
          <tbody>${Object.entries(TRANSITIONS).flatMap(([from,trans])=>trans.map(t=>`
            <tr><td style="color:var(--text2)">${from} ‚Üí ${t.to}</td>
            <td>${t.roles.map(r=>`<span class="role-tag role-${r}" style="margin-right:4px;font-size:9px">${ROLE_LABELS[r]||r}</span>`).join('')}</td>
            </tr>`)).join('')}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div class="card-title">Dati Sistema</div>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:13px">
          <div style="display:flex;justify-content:space-between"><span style="color:var(--text2)">Change totali</span><span style="font-family:var(--mono)">${changes.length}</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--text2)">CI nel CMDB</span><span style="font-family:var(--mono)">${cmdbItems.length}</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--text2)">Utenti attivi</span><span style="font-family:var(--mono)">${USERS.length}</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--text2)">Storage (localStorage)</span><span style="font-family:var(--mono)">${Math.round(JSON.stringify({changes,cmdbItems}).length/1024)}KB</span></div>
        </div>
        <button class="btn btn-danger btn-sm" style="margin-top:14px;width:100%;justify-content:center" onclick="resetData()">‚ö† Reset dati demo</button>
      </div>
    </div>
  </div>`;
}

function resetData() {
  if(!confirm('Sei sicuro? Tutti i dati verranno ripristinati al default demo.')) return;
  changes = JSON.parse(JSON.stringify(CHANGES_DEFAULT));
  cmdbItems = JSON.parse(JSON.stringify(CMDB_DEFAULT));
  notifications = [];
  saveData(LS_CHANGES, changes);
  saveData(LS_CMDB, cmdbItems);
  saveData(LS_NOTIFS, notifications);
  showPage('dashboard', document.getElementById('nav-dashboard'));
}

function accessDenied(name) {
  return `<div class="access-denied"><div class="icon">üîí</div><h3>Accesso non autorizzato</h3><p>Non hai i permessi per accedere a <strong>${name}</strong>.<br>Contatta un amministratore.</p></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetail(id) {
  currentChangeId = id;
  const c = changes.find(x=>x.id===id);
  if(!c) return;

  document.getElementById('dTitle').textContent = `${c.id} ‚Äî ${c.title}`;
  const dtpBadge = c.pipelineStrategy==='direct'?'<span style="background:rgba(255,107,107,.1);border:1px solid rgba(255,107,107,.25);border-radius:4px;padding:2px 7px;font-size:10px;color:#ff8585;font-family:var(--mono)">DIRECT</span>':'';
  document.getElementById('dBadges').innerHTML = `${sBadge(c.status)} ${pBadge(c.priority)} <span class="type-tag">${c.type}</span> ${dtpBadge}`;

  // Workflow stepper
  const wfIdx = STATUS_WF_IDX[c.status]??0;
  document.getElementById('dWorkflow').innerHTML = WF_STEPS.map((step,i)=>{
    const cls = i<wfIdx?'done':i===wfIdx&&c.status!=='Rifiutato'?'active':c.status==='Rifiutato'&&i===1?'rejected':'';
    return `<div class="wf-step ${cls}" style="flex:1;text-align:center;position:relative">
      <div class="wf-line" style="position:absolute;top:13px;left:50%;right:-50%;height:2px;background:${i<wfIdx?'var(--accent2)':'var(--border)'};${i===WF_STEPS.length-1?'display:none':''}"></div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
        <div class="wf-dot">${i<wfIdx?'‚úì':c.status==='Rifiutato'&&i===1?'‚úï':(i+1)}</div>
        <div class="wf-lbl">${step.label}</div>
        <div class="wf-team">${step.team}</div>
      </div>
    </div>`;
  }).join('');

  // Approval bar
  const myTrans = (TRANSITIONS[c.status]||[]).filter(t=>t.roles.includes(currentUser.role));
  const apprBar = document.getElementById('dApprBar');
  if(myTrans.length) {
    apprBar.style.display='flex';
    apprBar.innerHTML=`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/></svg>
      <div class="appr-txt">Puoi eseguire: <strong>${myTrans.map(t=>t.label).join(' / ')}</strong> come <em>${ROLE_LABELS[currentUser.role]}</em></div>`;
  } else {
    apprBar.style.display='none';
  }

  // Tabs reset
  document.querySelectorAll('#detailModal .tab').forEach((t,i)=>t.classList.toggle('active',i===0));
  renderDetailTab(c, 'dtab-detail');
  ['dtab-transition','dtab-activity','dtab-comments'].forEach(id=>{ document.getElementById(id).style.display='none'; });
  document.getElementById('dtab-detail').style.display='block';

  openModal('detailModal');
}

function renderDetailTab(c, tabId) {
  if(tabId==='dtab-detail') {
    document.getElementById('dtab-detail').innerHTML=`
    <div class="detail-grid">
      <div>
        <div class="meta-grid">
          <div><div class="meta-lbl">Richiedente</div><div class="meta-val">${userName(c.requesterId)}</div></div>
          <div><div class="meta-lbl">Assegnato a</div><div class="meta-val">${userName(c.assigneeId)}</div></div>
          <div><div class="meta-lbl">Categoria CI</div><div class="meta-val">${c.category}</div></div>
          <div><div class="meta-lbl">Finestra</div><div class="meta-val" style="font-family:var(--mono);font-size:12px">${c.window||'TBD'}</div></div>
          <div><div class="meta-lbl">Rischio</div><div class="meta-val">${rBadge(c.risk)}</div></div>
          <div><div class="meta-lbl">Impatto</div><div class="meta-val">${rBadge(c.impact)}</div></div>
          <div><div class="meta-lbl">Aperto il</div><div class="meta-val" style="font-family:var(--mono);font-size:12px">${c.opened}</div></div>
          <div><div class="meta-lbl">Pipeline</div><div class="meta-val">${envInline(c)}</div></div>
        </div>
        <div class="sec-box"><div class="sec-box-title">Descrizione</div><p>${c.desc}</p></div>
        <div class="sec-box"><div class="sec-box-title">Piano di Rollback</div><p>${c.rollback}</p></div>
        <div class="sec-box"><div class="sec-box-title">Test Plan</div><p>${c.test}</p></div>
      </div>
      <div>
        <div class="card" style="margin-bottom:10px">
          <div class="card-title">Azioni Disponibili</div>
          ${getActionButtons(c)}
        </div>
        ${c.incidents&&c.incidents.length?`
        <div class="card">
          <div class="card-title">Incidenti Correlati</div>
          ${c.incidents.map(inc=>`<div style="padding:6px 0;font-size:12px"><span style="color:var(--accent3);font-family:var(--mono)">${inc.id}</span> ‚Äî ${inc.desc} <span style="color:var(--accent4)">[${inc.sev}]</span></div>`).join('')}
        </div>`:''}
      </div>
    </div>`;
  }
  if(tabId==='dtab-transition') {
    const myTrans = (TRANSITIONS[c.status]||[]).filter(t=>t.roles.includes(currentUser.role));
    const allTrans = TRANSITIONS[c.status]||[];
    document.getElementById('dtab-transition').innerHTML=`
    <div class="transition-box">
      <div class="transition-title">Transizioni possibili da "${c.status}"</div>
      ${allTrans.map(t=>{
        const allowed = t.roles.includes(currentUser.role);
        return `<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">
          <div style="flex:1">
            <div style="font-size:13px;font-weight:500">${t.label} ‚Üí <strong>${t.to}</strong></div>
            <div style="font-size:11px;color:var(--text3);margin-top:3px">Autorizzato per: ${t.roles.map(r=>`<span class="role-tag role-${r}" style="font-size:9px;margin-right:3px">${ROLE_LABELS[r]||r}</span>`).join('')}</div>
          </div>
          ${allowed
            ? `<button class="btn btn-primary btn-sm" onclick="doTransition('${c.id}','${t.to}')">${t.label}</button>`
            : `<span style="font-size:11px;color:var(--text3)">üîí Non autorizzato</span>`}
        </div>`;
      }).join('')||'<div style="color:var(--text3);font-size:13px">Nessuna transizione disponibile</div>'}
    </div>
    ${myTrans.length&&['Schedulato','Autorizzato'].includes(c.status)?`
    <div class="transition-box" style="margin-top:12px">
      <div class="transition-title">üìÖ Pianifica Finestra di Manutenzione</div>
      <div class="form-row">
        <div class="fg"><label>Data / Ora Inizio</label><input id="trStart" value="${c.window||''}" placeholder="Seleziona data..." readonly style="cursor:pointer" onclick="openCalPicker('trStart',event)"></div>
        <div class="fg"><label>Data / Ora Fine</label><input id="trEnd" value="${c.windowEnd||''}" placeholder="Seleziona data..." readonly style="cursor:pointer" onclick="openCalPicker('trEnd',event)"></div>
      </div>
      <button class="btn btn-success btn-sm" onclick="saveWindow('${c.id}')">üíæ Salva Finestra</button>
    </div>`:''}
    ${c.status==='In Review'||c.status==='Aperto'?`
    <div class="transition-box" style="margin-top:12px">
      <div class="transition-title">üë§ Riassegna</div>
      <div class="form-row">
        <div class="fg"><label>Nuovo Assegnatario</label>
          <select id="trAssignee">${USERS.map(u=>`<option value="${u.id}" ${u.id===c.assigneeId?'selected':''}>${u.name} (${ROLE_LABELS[u.role]})</option>`).join('')}</select>
        </div>
      </div>
      ${canDo(['admin','change_manager'])?`<button class="btn btn-ghost btn-sm" onclick="reassign('${c.id}')">‚Üª Riassegna</button>`:''}
    </div>`:''}`;
  }
  if(tabId==='dtab-activity') {
    document.getElementById('dtab-activity').innerHTML=`
    <div>${(c.history||[]).slice().reverse().map(h=>`
      <div class="tl-item">
        <div class="tl-dot">üìã</div>
        <div>
          <div class="tl-hdr">${h.action}</div>
          <div class="tl-time">${h.time} ¬∑ ${h.userId?userName(h.userId):''}</div>
        </div>
      </div>`).join('')}</div>`;
  }
  if(tabId==='dtab-comments') {
    document.getElementById('dtab-comments').innerHTML=`
    <div id="commentsList">${(c.comments||[]).map(cm=>`
      <div class="comment">
        <div class="avatar" style="width:28px;height:28px;font-size:10px;flex-shrink:0">${cm.initials||userInitials(cm.userId)}</div>
        <div class="comment-box">
          <div style="display:flex;justify-content:space-between"><span class="comment-auth">${cm.name||userName(cm.userId)}</span><span class="comment-tm">${cm.time}</span></div>
          <div class="comment-txt">${cm.text}</div>
        </div>
      </div>`).join('')||'<div style="color:var(--text3);font-size:13px;margin-bottom:12px">Nessun commento.</div>'}</div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <div class="avatar" style="width:28px;height:28px;font-size:10px;flex-shrink:0">${currentUser.initials}</div>
      <textarea id="commentInput" placeholder="Aggiungi commento..." style="flex:1;min-height:52px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:8px 10px;font-family:var(--font);font-size:13px;color:var(--text);outline:none;resize:vertical"></textarea>
      <button class="btn btn-primary btn-sm" onclick="addComment('${c.id}')">Invia</button>
    </div>`;
  }
}

function switchTab(el, tabId) {
  document.querySelectorAll('#detailModal .tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  const all = ['dtab-detail','dtab-transition','dtab-activity','dtab-comments'];
  all.forEach(id=>{ document.getElementById(id).style.display='none'; });
  document.getElementById(tabId).style.display='block';
  const c = changes.find(x=>x.id===currentChangeId);
  if(c) renderDetailTab(c, tabId);
}

function getActionButtons(c) {
  const myTrans = (TRANSITIONS[c.status]||[]).filter(t=>t.roles.includes(currentUser.role));
  if(!myTrans.length) return `<div style="color:var(--text3);font-size:12px">Nessuna azione disponibile per il tuo ruolo (${ROLE_LABELS[currentUser.role]}) su questo change.</div>`;
  return myTrans.map(t=>`<button class="btn ${t.to==='Rifiutato'?'btn-danger':t.to==='Chiuso'&&t.label.includes('Successo')?'btn-success':'btn-primary'} btn-sm" style="width:100%;justify-content:center;margin-bottom:6px" onclick="doTransition('${c.id}','${t.to}')">${t.label}</button>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSITIONS & ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doTransition(id, toStatus) {
  const c = changes.find(x=>x.id===id);
  if(!c) return;
  const trans = (TRANSITIONS[c.status]||[]).find(t=>t.to===toStatus);
  if(!trans || !trans.roles.includes(currentUser.role)) {
    alert('Non sei autorizzato a eseguire questa transizione.');
    return;
  }
  const prevStatus = c.status;
  c.status = toStatus;
  // Add history
  if(!c.history) c.history=[];
  c.history.push({action:`${prevStatus} ‚Üí ${toStatus}`, userId:currentUser.id, time:new Date().toLocaleString('it-IT')});
  // Update pipeline if advancing
  if(toStatus==='In Esecuzione' && c.currentEnv<4) {
    c.pipeline[c.currentEnv]='active';
  }
  if(toStatus==='Chiuso') {
    if(c.currentEnv<4) c.pipeline[c.currentEnv]='done';
  }
  // Persist
  saveData(LS_CHANGES, changes);
  addNotification(`${c.id}: transizione ${prevStatus} ‚Üí ${toStatus} da ${currentUser.name}`);
  updateBadges();
  openDetail(id);
}

function quickTransition(id, toStatus) {
  doTransition(id, toStatus);
  renderApprovals();
}

function reassign(id) {
  const c = changes.find(x=>x.id===id);
  const newId = document.getElementById('trAssignee')?.value;
  if(!c||!newId) return;
  const prev = userName(c.assigneeId);
  c.assigneeId = newId;
  if(!c.history) c.history=[];
  c.history.push({action:`Riassegnato da ${prev} a ${userName(newId)}`, userId:currentUser.id, time:new Date().toLocaleString('it-IT')});
  saveData(LS_CHANGES, changes);
  addNotification(`${c.id} riassegnato a ${userName(newId)}`);
  openDetail(id);
}

function saveWindow(id) {
  const c = changes.find(x=>x.id===id);
  if(!c) return;
  c.window    = document.getElementById('trStart')?.value||c.window;
  c.windowEnd = document.getElementById('trEnd')?.value||c.windowEnd;
  if(!c.history) c.history=[];
  c.history.push({action:`Finestra impostata: ${c.window} ‚Üí ${c.windowEnd}`, userId:currentUser.id, time:new Date().toLocaleString('it-IT')});
  saveData(LS_CHANGES, changes);
  addNotification(`${c.id}: finestra aggiornata ‚Üí ${c.window}`);
  openDetail(id);
}

function addComment(id) {
  const text = document.getElementById('commentInput')?.value?.trim();
  if(!text) return;
  const c = changes.find(x=>x.id===id);
  if(!c.comments) c.comments=[];
  const now = new Date().toLocaleString('it-IT');
  c.comments.push({userId:currentUser.id, name:currentUser.name, initials:currentUser.initials, time:now, text});
  saveData(LS_CHANGES, changes);
  openDetail(id);
  setTimeout(()=>{ document.querySelectorAll('#detailModal .tab')[3]?.click(); },60);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW CHANGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updatePipelinePreview() {
  const s = document.getElementById('nPipelineStrat')?.value;
  const m = {full:'DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD','skip-dev':'INTEG ‚Üí CERT ‚Üí PROD',direct:'‚ö° Direct to PROD'};
  const el = document.getElementById('pipelinePreview');
  if(el) el.textContent = m[s]||'‚Äî';
}

function submitNewChange() {
  const title = document.getElementById('nTitle')?.value?.trim();
  if(!title) { alert('Inserisci il titolo'); return; }
  const strategy = document.getElementById('nPipelineStrat')?.value||'full';
  const pipeline = strategy==='direct'?['skip','skip','skip','active']:strategy==='skip-dev'?['skip','active','pending','pending']:['active','pending','pending','pending'];
  const startEnv = strategy==='direct'?3:strategy==='skip-dev'?1:0;
  const today = new Date().toISOString().split('T')[0];
  const num = String(changes.length+1).padStart(3,'0');
  const id = `CHG-${new Date().getFullYear()}-${num}`;
  const newChange = {
    id, title,
    type:      document.getElementById('nType')?.value||'Standard',
    priority:  document.getElementById('nPrio')?.value||'Media',
    status:    'Aperto',
    requesterId: currentUser.id,
    assigneeId:  document.getElementById('nAssignee')?.value||currentUser.id,
    category:  document.getElementById('nCat')?.value||'Server',
    risk:      document.getElementById('nRisk')?.value||'Basso',
    impact:    document.getElementById('nImpact')?.value||'Basso',
    opened:    today,
    window:    document.getElementById('nStart')?.value||'',
    windowEnd: document.getElementById('nEnd')?.value||'',
    pipeline, pipelineStrategy:strategy, currentEnv:startEnv,
    deps:[], incidents:[],
    desc:     document.getElementById('nDesc')?.value||'',
    rollback: document.getElementById('nRollback')?.value||'Da definire.',
    test:     document.getElementById('nTest')?.value||'Da definire.',
    comments:[],
    history:[{action:'Change aperto', userId:currentUser.id, time:new Date().toLocaleString('it-IT')}]
  };
  changes.unshift(newChange);
  saveData(LS_CHANGES, changes);
  addNotification(`Nuovo change ${id} creato da ${currentUser.name}: "${title}"`);
  closeModal('newChangeModal');
  // Reset form
  ['nTitle','nDesc','nRollback','nTest','nStart','nEnd'].forEach(fid=>{ const el=document.getElementById(fid); if(el)el.value=''; });
  renderDashboard();
  renderChanges();
  updateBadges();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CMDB ‚Äî Add CI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function submitCI() {
  const name = document.getElementById('ciName')?.value?.trim();
  if(!name) { alert('Inserisci il nome del CI'); return; }
  const ci = {
    id: 'ci'+Date.now(),
    name, 
    type:      document.getElementById('ciType')?.value||'Server',
    env:       document.getElementById('ciEnv')?.value||'PROD',
    ownerId:   document.getElementById('ciOwner')?.value||currentUser.id,
    status:    document.getElementById('ciStatus')?.value||'Operational',
    version:   document.getElementById('ciVersion')?.value||'‚Äî',
    notes:     document.getElementById('ciNotes')?.value||'',
    createdAt: new Date().toISOString().split('T')[0],
  };
  cmdbItems.push(ci);
  saveData(LS_CMDB, cmdbItems);
  addNotification(`Nuovo CI aggiunto al CMDB: ${name} (${ci.type})`);
  closeModal('ciModal');
  ['ciName','ciVersion','ciNotes'].forEach(fid=>{ const el=document.getElementById(fid); if(el)el.value=''; });
  renderCMDB();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addNotification(text) {
  notifications.unshift({text, time:new Date().toLocaleString('it-IT'), read:false});
  if(notifications.length>50) notifications=notifications.slice(0,50);
  saveData(LS_NOTIFS, notifications);
  renderNotifList();
}
function renderNotifList() {
  const unread = notifications.filter(n=>!n.read).length;
  const dot = document.getElementById('notifDot');
  if(dot) dot.style.display = unread>0?'block':'none';
  const list = document.getElementById('notifList');
  if(!list) return;
  list.innerHTML = notifications.slice(0,20).map((n,i)=>`
    <div style="padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;background:${n.read?'transparent':'rgba(79,124,255,.04)'}" onclick="markRead(${i})">
      <div style="display:flex;gap:8px;align-items:flex-start">
        <div style="width:6px;height:6px;border-radius:50%;background:${n.read?'transparent':'var(--accent)'};flex-shrink:0;margin-top:4px"></div>
        <div>
          <div style="font-size:12px;line-height:1.4">${n.text}</div>
          <div style="font-size:10px;color:var(--text3);font-family:var(--mono);margin-top:2px">${n.time}</div>
        </div>
      </div>
    </div>`).join('') || '<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px">Nessuna notifica</div>';
}
function markRead(i) { notifications[i].read=true; saveData(LS_NOTIFS,notifications); renderNotifList(); }
function markAllRead() { notifications.forEach(n=>n.read=true); saveData(LS_NOTIFS,notifications); renderNotifList(); }
function toggleNotifPanel() { document.getElementById('notifPanel').classList.toggle('open'); }
document.addEventListener('click',e=>{ if(!e.target.closest('.notif-wrap')) document.getElementById('notifPanel')?.classList.remove('open'); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-ov').forEach(o=>o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); }));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR PICKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let calTargetInput = null;
let calDate = new Date();
let calSelected = null;

function openCalPicker(inputId, event) {
  calTargetInput = inputId;
  const input = document.getElementById(inputId);
  if(input?.value) {
    const d = new Date(input.value);
    if(!isNaN(d)) { calDate=new Date(d); calSelected=new Date(d); }
  } else {
    calDate = new Date(); calSelected = null;
  }
  const ov = document.getElementById('calPickerOv');
  const picker = document.getElementById('calPicker');
  ov.style.display='block';
  // Position near the input
  const rect = event.target.getBoundingClientRect();
  picker.style.top = (rect.bottom+6)+'px';
  picker.style.left = Math.min(rect.left, window.innerWidth-290)+'px';
  renderCalPicker();
}

function closeCalPickerIfOutside(e) {
  if(e.target===document.getElementById('calPickerOv')) closeCalPicker();
}
function closeCalPicker() { document.getElementById('calPickerOv').style.display='none'; }

function renderCalPicker() {
  const months=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  document.getElementById('calMonthLbl').textContent = `${months[calDate.getMonth()]} ${calDate.getFullYear()}`;
  const firstDay = new Date(calDate.getFullYear(), calDate.getMonth(), 1);
  const lastDay  = new Date(calDate.getFullYear(), calDate.getMonth()+1, 0);
  const today    = new Date();
  // Monday-first offset
  let offset = firstDay.getDay()-1; if(offset<0) offset=6;
  let html='';
  for(let i=0;i<offset;i++){
    const d=new Date(calDate.getFullYear(),calDate.getMonth(),-(offset-1-i));
    html+=`<div class="cal-d other-month" onclick="calSetDate(${d.getFullYear()},${d.getMonth()},${d.getDate()})">${d.getDate()}</div>`;
  }
  for(let d=1;d<=lastDay.getDate();d++){
    const isToday=(d===today.getDate()&&calDate.getMonth()===today.getMonth()&&calDate.getFullYear()===today.getFullYear());
    const isSel=(calSelected&&d===calSelected.getDate()&&calDate.getMonth()===calSelected.getMonth()&&calDate.getFullYear()===calSelected.getFullYear());
    html+=`<div class="cal-d ${isToday?'today':''} ${isSel?'selected':''}" onclick="calSetDate(${calDate.getFullYear()},${calDate.getMonth()},${d})">${d}</div>`;
  }
  document.getElementById('calDays').innerHTML=html;
  // Set time if selected
  if(calSelected) {
    const h=String(calSelected.getHours()).padStart(2,'0');
    const m=String(calSelected.getMinutes()).padStart(2,'0');
    document.getElementById('calTime').value=`${h}:${m}`;
  }
}

function calNavMonth(dir) {
  calDate.setMonth(calDate.getMonth()+dir);
  renderCalPicker();
}

function calSetDate(y,m,d) {
  calSelected = new Date(y,m,d);
  renderCalPicker();
}

function confirmCalPicker() {
  if(!calSelected) { closeCalPicker(); return; }
  const time = document.getElementById('calTime').value||'09:00';
  const [hh,mm] = time.split(':');
  calSelected.setHours(parseInt(hh)||0, parseInt(mm)||0);
  const pad=n=>String(n).padStart(2,'0');
  const str=`${calSelected.getFullYear()}-${pad(calSelected.getMonth()+1)}-${pad(calSelected.getDate())} ${pad(calSelected.getHours())}:${pad(calSelected.getMinutes())}`;
  const el = document.getElementById(calTargetInput);
  if(el) el.value=str;
  closeCalPicker();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT ‚Äî carica users.json poi avvia il login
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadUsers() {
  // Mostra spinner durante il caricamento
  document.getElementById('loginLoadingMsg').style.display = 'block';
  try {
    const resp = await fetch('./users.json', { cache: 'no-cache' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const json = await resp.json();
    const list = json.users || json; // supporta sia {users:[...]} che [...]
    if (Array.isArray(list) && list.length > 0) {
      USERS = list;
      console.info(`[ChangeFlow] users.json caricato: ${USERS.length} utenti`);
      document.getElementById('loginSourceTag').textContent = 'üìÑ utenti da users.json';
    } else {
      throw new Error('Array vuoto');
    }
  } catch (e) {
    console.warn('[ChangeFlow] users.json non raggiungibile, uso fallback embedded:', e.message);
    USERS = USERS_FALLBACK;
    document.getElementById('loginSourceTag').textContent = '‚ö† utenti da fallback embedded';
    document.getElementById('loginSourceTag').style.color = 'var(--accent4)';
  }
  document.getElementById('loginLoadingMsg').style.display = 'none';
  initLogin();
}

loadUsers();
</script>
</body>
</html>
