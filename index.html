<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChangeFlow v3 - Enterprise Change Management</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0f14;--surface:#151820;--surface2:#1c2030;--surface3:#242840;--border:#2a2f45;
  --accent:#4f7cff;--accent2:#00d4aa;--accent3:#ff6b6b;--accent4:#ffa94d;--accent5:#c084fc;
  --text:#e8eaf6;--text2:#8890b0;--text3:#525870;
  --font:'IBM Plex Sans',sans-serif;--mono:'IBM Plex Mono',monospace;--r:8px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;}

/* ‚ïê‚ïê LOGIN  */
#loginScreen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000;flex-direction:column;gap:0;}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px 44px;width:420px;box-shadow:0 32px 80px rgba(0,0,0,.6);}
.login-logo{font-family:var(--mono);font-size:26px;font-weight:600;color:var(--accent);margin-bottom:4px;}
.login-sub{font-size:11px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-bottom:32px;}
.login-label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;display:block;}
.login-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:11px 14px;font-family:var(--font);font-size:14px;color:var(--text);outline:none;transition:border-color .15s;margin-bottom:14px;}
.login-input:focus{border-color:var(--accent);}
.login-btn{width:100%;background:var(--accent);color:#fff;border:none;border-radius:var(--r);padding:13px;font-family:var(--font);font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;margin-top:8px;}
.login-btn:hover{background:#6b91ff;transform:translateY(-1px);}
.login-err{color:var(--accent3);font-size:12px;margin-top:8px;min-height:18px;}
.login-hint{margin-top:24px;padding-top:20px;border-top:1px solid var(--border);}
.login-hint-title{font-size:11px;color:var(--text3);margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;}
.login-user-pill{display:inline-block;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:11px;font-family:var(--mono);color:var(--text2);margin:3px;cursor:pointer;transition:all .1s;}
.login-user-pill:hover{border-color:var(--accent);color:var(--accent);}

/* ‚ïê‚ïê LAYOUT ‚ïê‚ïê */
#appScreen{display:none;height:100vh;flex-direction:row;}
#appScreen.visible{display:flex;}
.sidebar{width:260px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{height:58px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 22px;gap:14px;flex-shrink:0;}
.content{flex:1;overflow-y:auto;padding:26px;}

/* ‚ïê‚ïê SIDEBAR ‚ïê‚ïê */
.logo{padding:18px 20px 14px;border-bottom:1px solid var(--border);}
.logo-text{font-family:var(--mono);font-size:18px;font-weight:600;color:var(--accent);}
.logo-sub{font-size:9px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.nav{padding:10px 0;flex:1;overflow-y:auto;}
.nav-sect{padding:10px 16px 4px;font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text3);}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 18px;cursor:pointer;transition:all .12s;font-size:13px;color:var(--text2);border-left:3px solid transparent;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:rgba(79,124,255,.1);color:var(--accent);border-left-color:var(--accent);}
.nav-icon{width:16px;height:16px;opacity:.8;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-family:var(--mono);padding:1px 7px;border-radius:10px;font-weight:600;}
.nav-badge.red{background:var(--accent3);}
.nav-badge.orange{background:var(--accent4);}
.nav-badge.green{background:var(--accent2);}
.user-area{padding:14px 16px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:#fff;flex-shrink:0;}
.user-name{font-size:13px;font-weight:500;}
.user-role-tag{font-size:10px;color:var(--text3);}
.logout-btn{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--text3);font-size:18px;transition:color .12s;}
.logout-btn:hover{color:var(--accent3);}

/* ‚ïê‚ïê TOPBAR ‚ïê‚ïê */
.page-title{font-size:16px;font-weight:600;}
.topbar-right{margin-left:auto;display:flex;gap:8px;align-items:center;}
.notif-wrap{position:relative;}
.notif-dot{width:7px;height:7px;background:var(--accent3);border-radius:50%;border:2px solid var(--surface);position:absolute;top:-1px;right:-1px;}
.notif-panel{position:absolute;top:42px;right:0;width:320px;background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:300;display:none;}
.notif-panel.open{display:block;}

/* ‚ïê‚ïê BUTTONS ‚ïê‚ïê */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:var(--r);font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .12s;font-family:var(--font);}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:#6b91ff;transform:translateY(-1px);}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--surface2);color:var(--text);}
.btn-danger{background:rgba(255,107,107,.15);color:var(--accent3);border:1px solid rgba(255,107,107,.3);}
.btn-danger:hover{background:rgba(255,107,107,.25);}
.btn-success{background:rgba(0,212,170,.15);color:var(--accent2);border:1px solid rgba(0,212,170,.3);}
.btn-success:hover{background:rgba(0,212,170,.25);}
.btn-warning{background:rgba(255,169,77,.15);color:var(--accent4);border:1px solid rgba(255,169,77,.3);}
.btn-sm{padding:5px 11px;font-size:12px;}
.btn-xs{padding:3px 8px;font-size:11px;}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important;}

/* ‚ïê‚ïê CARDS & TABLES ‚ïê‚ïê */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;}
.card-title{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.table-header{padding:13px 17px;display:flex;align-items:center;gap:9px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.tbl-title{font-size:14px;font-weight:600;}
.search-box{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:6px 11px;}
.search-box input{background:none;border:none;outline:none;font-family:var(--font);font-size:13px;color:var(--text);width:200px;}
.search-box input::placeholder{color:var(--text3);}
.fsel{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:5px 9px;font-family:var(--font);font-size:12px;color:var(--text2);}
table{width:100%;border-collapse:collapse;}
th{padding:9px 13px;text-align:left;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);background:var(--surface2);border-bottom:1px solid var(--border);}
td{padding:11px 13px;font-size:13px;border-bottom:1px solid rgba(42,47,69,.5);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.015);}
.chg-id{font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:600;}

/* ‚ïê‚ïê BADGES ‚ïê‚ïê */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;}
.badge::before{content:'';width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.b-open{background:rgba(255,107,107,.12);color:#ff8585;}.b-open::before{background:var(--accent3);}
.b-review{background:rgba(79,124,255,.12);color:#7b9dff;}.b-review::before{background:var(--accent);}
.b-approved{background:rgba(0,212,170,.12);color:#00d4aa;}.b-approved::before{background:var(--accent2);}
.b-scheduled{background:rgba(255,169,77,.12);color:#ffa94d;}.b-scheduled::before{background:var(--accent4);}
.b-impl{background:rgba(255,169,77,.2);color:#ffbd6e;animation:pulse 2s infinite;}.b-impl::before{background:var(--accent4);}
.b-closed{background:rgba(82,88,112,.2);color:var(--text3);}.b-closed::before{background:var(--text3);}
.b-rejected{background:rgba(255,107,107,.12);color:#ff6b6b;}.b-rejected::before{background:var(--accent3);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
@keyframes cfSpin{to{transform:rotate(360deg)}}
.prio{display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:500;}
.prio-c{color:var(--accent3);}.prio-h{color:var(--accent4);}.prio-m{color:var(--accent);}.prio-l{color:var(--text3);}
.type-tag{background:var(--surface3);color:var(--text2);padding:2px 7px;border-radius:4px;font-size:10px;font-family:var(--mono);}
.role-tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;font-family:var(--mono);}
.sev-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:600;}
.sev-p1{background:rgba(255,107,107,.15);color:#ff6b6b;}
.sev-p2{background:rgba(255,169,77,.15);color:#ffa94d;}
.sev-p3{background:rgba(79,124,255,.15);color:#4f7cff;}
.sev-p4{background:rgba(82,88,112,.2);color:var(--text3);}

/* ‚ïê‚ïê STATS ‚ïê‚ïê */
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.stat-card:hover{border-color:var(--accent);transform:translateY(-2px);}
.stat-n{font-family:var(--mono);font-size:28px;font-weight:600;line-height:1;margin-bottom:4px;}
.stat-l{font-size:12px;color:var(--text2);}
.stat-t{font-size:10px;color:var(--text3);margin-top:5px;font-family:var(--mono);}

/* ‚ïê‚ïê MODAL ‚ïê‚ïê */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .18s;}
.modal-ov.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.6);transform:translateY(14px);transition:transform .18s;width:750px;}
.modal-ov.open .modal{transform:translateY(0);}
.modal-wide{width:950px;}
.modal-xl{width:1100px;}
.modal-hdr{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:12px;}
.modal-title{font-size:16px;font-weight:600;}
.modal-sub{font-size:12px;color:var(--text2);margin-top:3px;}
.modal-x{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--text3);font-size:20px;line-height:1;}
.modal-x:hover{color:var(--text);}
.modal-body{padding:20px 24px;}
.modal-foot{padding:14px 24px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}

/* ‚ïê‚ïê FORM ‚ïê‚ïê */
.fg{display:flex;flex-direction:column;gap:5px;margin-bottom:14px;}
.fg label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;}
.fg input,.fg select,.fg textarea{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:9px 11px;font-family:var(--font);font-size:13px;color:var(--text);outline:none;transition:border-color .12s;width:100%;}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--accent);}
.fg textarea{resize:vertical;min-height:68px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-row.tri{grid-template-columns:1fr 1fr 1fr;}
.form-row.full{grid-template-columns:1fr;}
.form-sect{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border);}
.form-sect:last-child{border:none;margin:0;padding:0;}
.form-sect-title{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:12px;text-transform:uppercase;letter-spacing:.8px;display:flex;align-items:center;gap:6px;}

/* ‚ïê‚ïê WORKFLOW STEPPER ‚ïê‚ïê */
.wf{display:flex;align-items:flex-start;margin:12px 0;overflow-x:auto;padding-bottom:8px;}
.wf-step{flex:1;min-width:100px;text-align:center;position:relative;}
.wf-line{position:absolute;top:14px;left:50%;right:-50%;height:2px;background:var(--border);}
.wf-step.done .wf-line{background:var(--accent2);}
.wf-step:last-child .wf-line{display:none;}
.wf-dot{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;z-index:1;margin:0 auto;}
.wf-step.done .wf-dot{background:var(--accent2);border-color:var(--accent2);color:#fff;}
.wf-step.active .wf-dot{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 12px rgba(79,124,255,.5);}
.wf-step.rejected .wf-dot{background:var(--accent3);border-color:var(--accent3);color:#fff;}
.wf-lbl{font-size:9px;color:var(--text3);margin-top:5px;font-weight:500;line-height:1.2;}
.wf-step.done .wf-lbl,.wf-step.active .wf-lbl{color:var(--text);}
.wf-team{font-size:8px;color:var(--text3);font-family:var(--mono);}

/* ‚ïê‚ïê ENV PIPELINE ‚ïê‚ïê */
.env-inline{display:flex;align-items:center;gap:3px;}
.env-pip{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;flex-shrink:0;}
.env-arrow-sm{color:var(--text3);font-size:10px;}

/* ‚ïê‚ïê TABS ‚ïê‚ïê */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:16px;}
.tab{padding:9px 16px;font-size:13px;font-weight:500;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .12s;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}

/* ‚ïê‚ïê TIMELINE ‚ïê‚ïê */
.tl-item{display:flex;gap:10px;margin-bottom:12px;}
.tl-dot{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;}
.tl-hdr{font-size:13px;font-weight:500;}
.tl-time{font-size:10px;color:var(--text3);font-family:var(--mono);}
.tl-body{font-size:12px;color:var(--text2);margin-top:3px;}

/* ‚ïê‚ïê COMMENT ‚ïê‚ïê */
.comment{display:flex;gap:8px;margin-bottom:10px;}
.comment-box{background:var(--surface2);border-radius:var(--r);padding:9px 12px;flex:1;}
.comment-auth{font-size:12px;font-weight:600;}
.comment-tm{font-size:10px;color:var(--text3);font-family:var(--mono);}
.comment-txt{font-size:13px;color:var(--text2);line-height:1.5;margin-top:3px;}

/* ‚ïê‚ïê CALENDAR PICKER ‚ïê‚ïê */
.cal-picker-ov{position:fixed;inset:0;z-index:9999;display:none;}
.cal-picker-ov.open{display:block;}
.cal-picker{position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 24px 64px rgba(0,0,0,.8);width:280px;z-index:10000;max-height:85vh;overflow-y:auto;}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.cal-nav-btn{background:none;border:none;cursor:pointer;color:var(--text2);font-size:18px;padding:4px 8px;border-radius:6px;transition:all .1s;}
.cal-nav-btn:hover{background:var(--surface2);color:var(--text);}
.cal-month-lbl{font-size:13px;font-weight:600;color:var(--text);}
.cal-dow-row{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:6px;}
.cal-dow{font-size:10px;text-align:center;color:var(--text3);font-weight:600;padding:3px 0;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-d{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:12px;border-radius:6px;cursor:pointer;color:var(--text2);transition:all .1s;}
.cal-d:hover{background:var(--surface3);color:var(--text);}
.cal-d.today{background:var(--surface3);color:var(--accent);font-weight:600;}
.cal-d.selected{background:var(--accent);color:#fff;font-weight:600;}
.cal-d.other-month{color:var(--text3);opacity:.4;}
.cal-d.disabled{opacity:.2;cursor:not-allowed;}
.cal-time-row{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}
.cal-time-lbl{font-size:11px;color:var(--text3);font-weight:600;}
.cal-time-row input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 8px;font-family:var(--mono);font-size:12px;color:var(--text);outline:none;}
.cal-foot{display:flex;gap:8px;margin-top:12px;}
.cal-foot .btn{flex:1;justify-content:center;}

/* ‚ïê‚ïê SECTION BOX ‚ïê‚ïê */
.sec-box{background:var(--surface2);border-radius:var(--r);padding:12px;margin-bottom:10px;}
.sec-box-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:6px;}
.sec-box p{font-size:13px;line-height:1.6;color:var(--text2);}

/* ‚ïê‚ïê APPROVAL BAR ‚ïê‚ïê */
.appr-bar{background:rgba(79,124,255,.06);border:1px solid rgba(79,124,255,.2);border-radius:var(--r);padding:10px 14px;display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.appr-txt{flex:1;font-size:13px;color:var(--text2);}

/* ‚ïê‚ïê ACCESS DENIED ‚ïê‚ïê */
.access-denied{text-align:center;padding:60px 20px;}
.access-denied .icon{font-size:48px;margin-bottom:16px;}
.access-denied h3{font-size:16px;font-weight:600;color:var(--text2);margin-bottom:8px;}
.access-denied p{font-size:13px;color:var(--text3);}

/* ‚ïê‚ïê CMDB ‚ïê‚ïê */
.cmdb-form-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}

/* ‚ïê‚ïê PAGE ‚ïê‚ïê */
.page{display:none;}
.page.active{display:block;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* ‚ïê‚ïê FREEZE BANNER ‚ïê‚ïê */
.freeze-banner{background:rgba(192,132,252,.08);border-bottom:1px solid rgba(192,132,252,.2);padding:7px 22px;display:flex;align-items:center;gap:8px;font-size:12px;color:#c084fc;}

/* ‚ïê‚ïê DETAIL GRID ‚ïê‚ïê */
.detail-grid{display:grid;grid-template-columns:1fr 300px;gap:16px;}
.meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.meta-lbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:3px;}
.meta-val{font-size:13px;color:var(--text);}

/* ‚ïê‚ïê TRANSITION ACTION BOX ‚ïê‚ïê */
.transition-box{background:rgba(79,124,255,.05);border:1px solid rgba(79,124,255,.15);border-radius:10px;padding:14px 16px;margin-bottom:14px;}
.transition-title{font-size:12px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;}

/* ‚ïê‚ïê REPORTS ‚ïê‚ïê */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:16px;}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;}
.kpi-v{font-family:var(--mono);font-size:24px;font-weight:600;color:var(--accent2);}
.kpi-l{font-size:10px;color:var(--text3);margin-top:3px;text-transform:uppercase;letter-spacing:1px;}
.bar-chart{display:flex;flex-direction:column;gap:6px;}
.bar-row{display:flex;align-items:center;gap:8px;}
.bar-lbl{width:110px;font-size:11px;color:var(--text2);text-align:right;flex-shrink:0;}
.bar-track{flex:1;height:18px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.bar-fill{height:100%;border-radius:3px;display:flex;align-items:center;padding-left:6px;transition:width .6s ease;}
.bar-val{font-size:9px;font-family:var(--mono);font-weight:600;color:#fff;}
.reports-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
.chart-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;}
.chart-title{font-size:13px;font-weight:600;margin-bottom:12px;}

/* ‚ïê‚ïê CALENDAR PAGE ‚ïê‚ïê */
.cal-pg-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cal-pg-hd{font-size:10px;text-align:center;color:var(--text3);font-weight:600;margin-bottom:6px;}
.cal-pg-hd-row{display:grid;grid-template-columns:repeat(7,1fr);}
.cal-pg-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;border-radius:6px;cursor:pointer;color:var(--text3);transition:all .1s;min-height:60px;}
.cal-pg-day:hover{background:var(--surface3);color:var(--text);}
.cal-pg-day.has-chg{background:rgba(79,124,255,.12);color:var(--accent);font-weight:600;}
.cal-pg-day.freeze{background:rgba(192,132,252,.15);color:#c084fc;border:1px solid rgba(192,132,252,.3);}
.cal-pg-day.today{background:var(--accent);color:#fff;font-weight:600;}
.cal-pip{width:5px;height:5px;border-radius:50%;margin-top:2px;}

/* ‚ïê‚ïê PIPELINE VIEW ‚ïê‚ïê */
.pipeline-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
.pipeline-col{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;}
.pipeline-col-title{font-size:12px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.pipeline-col-count{background:var(--surface2);padding:2px 8px;border-radius:10px;font-size:10px;font-family:var(--mono);}
.pipeline-item{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;cursor:pointer;transition:all .12s;}
.pipeline-item:hover{border-color:var(--accent);transform:translateX(2px);}
.pipeline-item-id{font-family:var(--mono);font-size:10px;color:var(--accent);font-weight:600;margin-bottom:4px;}
.pipeline-item-title{font-size:12px;font-weight:500;margin-bottom:6px;}
.pipeline-item-meta{display:flex;gap:6px;font-size:10px;color:var(--text3);}

/* ‚ïê‚ïê CAB BOARD ‚ïê‚ïê */
.cab-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.cab-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:12px;}
.cab-card-hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;}
.cab-card-title{font-size:14px;font-weight:600;}
.cab-card-meta{display:flex;gap:12px;font-size:11px;color:var(--text3);margin-bottom:10px;}
.cab-actions{display:flex;gap:8px;margin-top:12px;}

/* ‚ïê‚ïê INCIDENTS ‚ïê‚ïê */
.incident-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;}
.incident-hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
.incident-id{font-family:var(--mono);font-size:11px;color:var(--accent3);font-weight:600;}
.incident-title{font-size:13px;font-weight:500;margin-bottom:6px;}
.incident-meta{display:flex;gap:10px;font-size:11px;color:var(--text3);}

/* ‚ïê‚ïê SETTINGS ‚ïê‚ïê */
.settings-grid{display:grid;grid-template-columns:250px 1fr;gap:20px;}
.settings-nav{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px;}
.settings-nav-item{padding:9px 12px;border-radius:6px;cursor:pointer;font-size:13px;color:var(--text2);transition:all .12s;margin-bottom:4px;}
.settings-nav-item:hover{background:var(--surface2);color:var(--text);}
.settings-nav-item.active{background:rgba(79,124,255,.1);color:var(--accent);}
.settings-panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;}
.settings-section{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--border);}
.settings-section:last-child{border:none;margin:0;padding:0;}
.settings-section-title{font-size:13px;font-weight:600;margin-bottom:14px;color:var(--text);}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;}
.setting-label{font-size:13px;color:var(--text2);}
.setting-desc{font-size:11px;color:var(--text3);margin-top:2px;}

/* ‚ïê‚ïê ROLE COLORS ‚ïê‚ïê */
.role-admin{background:rgba(255,107,107,.12);color:#ff8585;}
.role-change_manager{background:rgba(79,124,255,.12);color:#7b9dff;}
.role-change_requestor{background:rgba(0,212,170,.12);color:#00d4aa;}
.role-env_owner{background:rgba(255,169,77,.12);color:#ffa94d;}
.role-ta{background:rgba(192,132,252,.12);color:#c084fc;}
.role-tester{background:rgba(82,88,112,.2);color:var(--text3);}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">ChangeFlow</div>
    <div class="login-sub">Change Management v3.0</div>
    <div id="loginLoadingMsg" style="display:none;text-align:center;padding:20px 0 10px;color:var(--text3);font-size:13px">
      <span style="display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:cfSpin .7s linear infinite;vertical-align:middle;margin-right:7px"></span>
      Caricamento utenti...
    </div>
    <label class="login-label">Username</label>
    <input class="login-input" id="loginUser" placeholder="es. malbini" onkeydown="if(event.key==='Enter')doLogin()">
    <label class="login-label">Password</label>
    <input class="login-input" type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Accedi</button>
    <div class="login-err" id="loginErr"></div>
    <div style="margin-top:10px;text-align:center">
      <span id="loginSourceTag" style="font-size:10px;font-family:var(--mono);color:var(--text3);background:var(--surface2);border:1px solid var(--border);padding:3px 9px;border-radius:20px"></span>
    </div>
    <div class="login-hint">
      <div class="login-hint-title">Accesso rapido (demo)</div>
      <div id="loginHints"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     APP SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="appScreen">
  <nav class="sidebar">
    <div class="logo">
      <div class="logo-text">ChangeFlow</div>
      <div class="logo-sub">Enterprise v3.0</div>
    </div>
    <div class="nav" id="sideNav"></div>
    <div class="user-area">
      <div class="avatar" id="sideAvatar"></div>
      <div>
        <div class="user-name" id="sideName"></div>
        <div class="user-role-tag" id="sideRoleTag"></div>
      </div>
      <button class="logout-btn" onclick="doLogout()" title="Esci">‚èª</button>
    </div>
  </nav>

  <div class="main">
    <div class="freeze-banner" id="freezeBanner" style="display:none">
      üîí <strong>FREEZE PERIOD ATTIVO:</strong>&nbsp;Fine Anno ‚Äî nessun change su PROD autorizzato
    </div>
    <div class="topbar">
      <div class="page-title" id="pageTitle">Dashboard</div>
      <div class="topbar-right">
        <button class="btn btn-ghost btn-sm" id="btnNewChange" onclick="openNewChangeModal()" style="display:none">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nuovo Change
        </button>
        <div class="notif-wrap">
          <button class="btn btn-ghost btn-sm" onclick="toggleNotifPanel()">üîî</button>
          <div class="notif-dot" id="notifDot"></div>
          <div class="notif-panel" id="notifPanel">
            <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
              <span style="font-size:13px;font-weight:600">Notifiche</span>
              <span style="font-size:10px;color:var(--text3);cursor:pointer" onclick="markAllRead()">Segna lette</span>
            </div>
            <div id="notifList" style="max-height:300px;overflow-y:auto;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="page active" id="page-dashboard"></div>
      <div class="page" id="page-changes"></div>
      <div class="page" id="page-pipeline"></div>
      <div class="page" id="page-approvals"></div>
      <div class="page" id="page-cab"></div>
      <div class="page" id="page-calendar"></div>
      <div class="page" id="page-reports"></div>
      <div class="page" id="page-incidents"></div>
      <div class="page" id="page-cmdb"></div>
      <div class="page" id="page-settings"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê -->
<!-- New Change Modal -->
<div class="modal-ov modal-wide" id="newChangeModal">
  <div class="modal">
    <div class="modal-hdr">
      <div><div class="modal-title">Nuovo Change Request</div><div class="modal-sub">Compila tutti i campi obbligatori</div></div>
      <button class="modal-x" onclick="closeModal('newChangeModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-sect">
        <div class="form-sect-title">üìã Informazioni Generali</div>
        <div class="form-row full"><div class="fg"><label>Titolo *</label><input id="nTitle" placeholder="Descrizione breve del change..."></div></div>
        <div class="form-row">
          <div class="fg"><label>Tipo *</label><select id="nType"><option>Standard</option><option>Normale</option><option>Emergenza</option></select></div>
          <div class="fg"><label>Priorit√† *</label><select id="nPrio"><option>Bassa</option><option>Media</option><option>Alta</option><option>Critica</option></select></div>
        </div>
        <div class="form-row">
          <div class="fg"><label>Categoria CI</label><select id="nCat"><option>Database</option><option>Network</option><option>Server</option><option>Applicazioni</option><option>Storage</option><option>Security</option></select></div>
          <div class="fg"><label>Assegnato a (Team)</label><select id="nAssignee"></select></div>
        </div>
        <div class="form-row full"><div class="fg"><label>Descrizione *</label><textarea id="nDesc" placeholder="Descrizione dettagliata, motivazione, sistemi impattati..."></textarea></div></div>
      </div>
      <div class="form-sect">
        <div class="form-sect-title">üîó Incidenti Correlati</div>
        <div class="fg">
          <label>Collega Incidenti (opzionale)</label>
          <select id="nIncidents" multiple style="min-height:80px"></select>
          <div style="font-size:11px;color:var(--text3);margin-top:4px">Tieni premuto Ctrl/Cmd per selezionare pi√π incidenti</div>
        </div>
      </div>
      <div class="form-sect">
        <div class="form-sect-title">üåç Pipeline Ambienti</div>
        <div class="form-row">
          <div class="fg"><label>Strategia Deployment</label>
            <select id="nPipelineStrat" onchange="updatePipelinePreview()">
              <option value="full">Completo: DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD</option>
              <option value="skip-dev">Skip DEV: INTEG ‚Üí CERT ‚Üí PROD</option>
              <option value="direct">Direct to PROD (solo Emergenza)</option>
            </select>
          </div>
          <div class="fg"><label>Anteprima</label><div id="pipelinePreview" style="background:var(--surface2);border-radius:var(--r);padding:9px 11px;font-family:var(--mono);font-size:12px;color:var(--text2)">DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD</div></div>
        </div>
      </div>
      <div class="form-sect">
        <div class="form-sect-title">üõ° Rischio & Rollback</div>
        <div class="form-row">
          <div class="fg"><label>Rischio</label><select id="nRisk"><option>Basso</option><option>Medio</option><option>Alto</option><option>Critico</option></select></div>
          <div class="fg"><label>Impatto</label><select id="nImpact"><option>Basso</option><option>Medio</option><option>Alto</option></select></div>
        </div>
        <div class="form-row full"><div class="fg"><label>Piano di Rollback</label><textarea id="nRollback" placeholder="Procedure di rollback..."></textarea></div></div>
        <div class="form-row full"><div class="fg"><label>Test Plan</label><textarea id="nTest" placeholder="Come verr√† verificato il completamento..."></textarea></div></div>
      </div>
      <div class="form-sect">
        <div class="form-sect-title">üìÖ Pianificazione</div>
        <div class="form-row">
          <div class="fg"><label>Data / Ora Inizio</label>
            <div style="position:relative">
              <input id="nStart" placeholder="Clicca per selezionare data..." readonly style="cursor:pointer" onclick="openCalPicker('nStart',event)">
            </div>
          </div>
          <div class="fg"><label>Data / Ora Fine</label>
            <div style="position:relative">
              <input id="nEnd" placeholder="Clicca per selezionare data..." readonly style="cursor:pointer" onclick="openCalPicker('nEnd',event)">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('newChangeModal')">Annulla</button>
      <button class="btn btn-primary" onclick="submitNewChange()">‚úÖ Crea Change</button>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal-ov modal-xl" id="detailModal">
  <div class="modal">
    <div class="modal-hdr">
      <div><div class="modal-title" id="dTitle">CHG-2025-001</div><div class="modal-sub" id="dBadges"></div></div>
      <button class="modal-x" onclick="closeModal('detailModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="tabs">
        <div class="tab active" onclick="switchTab(this,'dtab-detail')">üìã Dettaglio</div>
        <div class="tab" onclick="switchTab(this,'dtab-transition')">‚öôÔ∏è Transizioni</div>
        <div class="tab" onclick="switchTab(this,'dtab-activity')">üìú Attivit√†</div>
        <div class="tab" onclick="switchTab(this,'dtab-comments')">üí¨ Commenti</div>
      </div>
      <div id="dApprBar" class="appr-bar" style="display:none"></div>
      <div id="dWorkflow" class="wf" style="margin-bottom:16px"></div>
      <div id="dtab-detail"></div>
      <div id="dtab-transition" style="display:none"></div>
      <div id="dtab-activity" style="display:none"></div>
      <div id="dtab-comments" style="display:none"></div>
    </div>
  </div>
</div>

<!-- CI Modal -->
<div class="modal-ov" id="ciModal">
  <div class="modal">
    <div class="modal-hdr">
      <div><div class="modal-title">Aggiungi Configuration Item</div><div class="modal-sub">CMDB ‚Äî Configuration Management Database</div></div>
      <button class="modal-x" onclick="closeModal('ciModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="cmdb-form-row">
        <div class="fg"><label>Nome CI *</label><input id="ciName" placeholder="es. db-prod-01"></div>
        <div class="fg"><label>Tipo</label><select id="ciType"><option>Server</option><option>Database</option><option>Network</option><option>Application</option><option>Storage</option><option>Security</option></select></div>
        <div class="fg"><label>Ambiente</label><select id="ciEnv"><option>DEV</option><option>INTEG</option><option>CERT</option><option>PROD</option></select></div>
      </div>
      <div class="cmdb-form-row">
        <div class="fg"><label>Owner</label><select id="ciOwner"></select></div>
        <div class="fg"><label>Stato</label><select id="ciStatus"><option>Operational</option><option>Maintenance</option><option>Decommissioned</option></select></div>
        <div class="fg"><label>Versione</label><input id="ciVersion" placeholder="es. 2.4.1"></div>
      </div>
      <div class="fg"><label>Note</label><textarea id="ciNotes" placeholder="Informazioni aggiuntive..."></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('ciModal')">Annulla</button>
      <button class="btn btn-primary" onclick="submitCI()">üíæ Salva CI</button>
    </div>
  </div>
</div>

<!-- Incident Modal -->
<div class="modal-ov" id="incidentModal">
  <div class="modal">
    <div class="modal-hdr">
      <div><div class="modal-title">Nuovo Incidente</div><div class="modal-sub">Registra un nuovo incidente</div></div>
      <button class="modal-x" onclick="closeModal('incidentModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row full"><div class="fg"><label>Titolo *</label><input id="incTitle" placeholder="Descrizione breve incidente..."></div></div>
      <div class="form-row">
        <div class="fg"><label>Severit√†</label><select id="incSev"><option value="P1">P1 - Critica</option><option value="P2">P2 - Alta</option><option value="P3">P3 - Media</option><option value="P4">P4 - Bassa</option></select></div>
        <div class="fg"><label>Stato</label><select id="incStatus"><option>Aperto</option><option>In Lavorazione</option><option>In Attesa</option><option>Risolto</option><option>Chiuso</option></select></div>
      </div>
      <div class="form-row">
        <div class="fg"><label>Categoria</label><select id="incCat"><option>Database</option><option>Network</option><option>Server</option><option>Applicazioni</option><option>Security</option></select></div>
        <div class="fg"><label>Assegnato a</label><select id="incAssignee"></select></div>
      </div>
      <div class="form-row full"><div class="fg"><label>Descrizione</label><textarea id="incDesc" placeholder="Descrizione dettagliata..."></textarea></div></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('incidentModal')">Annulla</button>
      <button class="btn btn-primary" onclick="submitIncident()">üíæ Crea Incidente</button>
    </div>
  </div>
</div>

<!-- Calendar Picker Overlay -->
<div class="cal-picker-ov" id="calPickerOv" onclick="closeCalPickerIfOutside(event)">
  <div class="cal-picker" id="calPicker">
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="calNavMonth(-1)">‚ùÆ</button>
      <div class="cal-month-lbl" id="calMonthLbl"></div>
      <button class="cal-nav-btn" onclick="calNavMonth(1)">‚ùØ</button>
    </div>
    <div class="cal-dow-row">
      <div class="cal-dow">Lun</div><div class="cal-dow">Mar</div><div class="cal-dow">Mer</div>
      <div class="cal-dow">Gio</div><div class="cal-dow">Ven</div><div class="cal-dow">Sab</div><div class="cal-dow">Dom</div>
    </div>
    <div class="cal-days" id="calDays"></div>
    <div class="cal-time-row">
      <span class="cal-time-lbl">Ora:</span>
      <input type="time" id="calTime" value="09:00">
    </div>
    <div class="cal-foot">
      <button class="btn btn-ghost btn-sm" onclick="closeCalPicker()">Annulla</button>
      <button class="btn btn-primary btn-sm" onclick="confirmCalPicker()">Conferma</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG & CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LS_CHANGES = 'cf_changes_v3';
const LS_INCIDENTS = 'cf_incidents_v3';
const LS_CMDB = 'cf_cmdb_v3';
const LS_NOTIFS = 'cf_notifs_v3';
const LS_FREEZES = 'cf_freezes_v3';
const LS_SETTINGS = 'cf_settings_v3';
const LS_USER = 'cf_current_user';

const ROLE_LABELS = {
  admin:'Admin', change_manager:'Change Manager', change_requestor:'Requestor',
  env_owner:'Env Owner', ta:'Technical Analyst', tester:'Tester'
};

const STATUS_ORDER = ['Aperto','In Review','Approvato','Schedulato','Autorizzato','In Esecuzione','Chiuso','Rifiutato'];
const STATUS_WF_IDX = Object.fromEntries(STATUS_ORDER.map((s,i)=>[s,i]));
const WF_STEPS = [
  {label:'Aperto', team:'Requestor'},
  {label:'Review', team:'Change Mgr'},
  {label:'Approvato', team:'CAB'},
  {label:'Schedulato', team:'Planning'},
  {label:'Autorizzato', team:'Env Owner'},
  {label:'In Esecuzione', team:'Tech Team'},
  {label:'Chiuso', team:'QA'}
];

const TRANSITIONS = {
  'Aperto': [
    {to:'In Review', label:'Invia in Review', roles:['change_requestor','change_manager','admin']},
    {to:'Rifiutato', label:'Rifiuta', roles:['change_manager','admin']}
  ],
  'In Review': [
    {to:'Approvato', label:'Approva', roles:['change_manager','admin']},
    {to:'Rifiutato', label:'Rifiuta', roles:['change_manager','admin']},
    {to:'Aperto', label:'Torna a Aperto', roles:['change_manager','admin']}
  ],
  'Approvato': [
    {to:'Schedulato', label:'Pianifica', roles:['change_manager','admin']},
    {to:'In Review', label:'Torna in Review', roles:['change_manager','admin']}
  ],
  'Schedulato': [
    {to:'Autorizzato', label:'Autorizza Esecuzione', roles:['env_owner','admin']},
    {to:'Approvato', label:'Torna ad Approvato', roles:['change_manager','admin']}
  ],
  'Autorizzato': [
    {to:'In Esecuzione', label:'Avvia Esecuzione', roles:['ta','admin']},
    {to:'Schedulato', label:'Torna a Schedulato', roles:['env_owner','admin']}
  ],
  'In Esecuzione': [
    {to:'Chiuso', label:'Chiudi (Successo)', roles:['ta','tester','admin']},
    {to:'Rifiutato', label:'Segnala Fallimento', roles:['ta','tester','admin']}
  ],
  'Chiuso': [],
  'Rifiutato': [
    {to:'Aperto', label:'Riapri', roles:['change_requestor','change_manager','admin']}
  ]
};

const ENVIRONMENTS = ['DEV','INTEG','CERT','PROD'];
const SEVERITY_LABELS = {P1:'Critica',P2:'Alta',P3:'Media',P4:'Bassa'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const USERS_FALLBACK = [
  {id:'u1', name:'Mario Albini', username:'malbini', password:'demo', role:'admin', team:'Infra', email:'m.albini@company.local', initials:'MA'},
  {id:'u2', name:'Laura Bianchi', username:'lbianchi', password:'demo', role:'change_manager', team:'Change', email:'l.bianchi@company.local', initials:'LB'},
  {id:'u3', name:'Giuseppe Rossi', username:'grossi', password:'demo', role:'change_requestor', team:'Dev', email:'g.rossi@company.local', initials:'GR'},
  {id:'u4', name:'Anna Verdi', username:'averdi', password:'demo', role:'env_owner', team:'ProdOps', email:'a.verdi@company.local', initials:'AV'},
  {id:'u5', name:'Marco Neri', username:'mneri', password:'demo', role:'ta', team:'Infra', email:'m.neri@company.local', initials:'MN'},
  {id:'u6', name:'Sofia Colombo', username:'scolombo', password:'demo', role:'tester', team:'QA', email:'s.colombo@company.local', initials:'SC'}
];
let USERS = [...USERS_FALLBACK];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEFAULT DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CHANGES_DEFAULT = [
  {
    id:'CHG-2025-001', title:'Aggiornamento firewall regole DMZ',
    type:'Normale', priority:'Alta', status:'In Review',
    requesterId:'u3', assigneeId:'u5', category:'Security',
    risk:'Medio', impact:'Alto', opened:'2025-02-10',
    window:'2025-02-20 22:00', windowEnd:'2025-02-20 23:30',
    pipeline:['done','active','pending','pending'],
    pipelineStrategy:'full', currentEnv:1,
    incidentIds:[],
    desc:'Aggiornamento regole firewall per nuova applicazione in DMZ.',
    rollback:'Ripristino configurazione precedente da backup.',
    test:'Verifica connettivit√† applicazione.',
    comments:[],
    history:[
      {action:'Change aperto', userId:'u3', time:'2025-02-10 14:30'},
      {action:'Aperto ‚Üí In Review', userId:'u3', time:'2025-02-10 14:35'}
    ]
  }
];

const INCIDENTS_DEFAULT = [
  {
    id:'INC-2025-001',
    title:'Performance degradation database Oracle',
    severity:'P1',
    status:'In Lavorazione',
    category:'Database',
    assigneeId:'u5',
    reporterId:'u3',
    opened:'2025-02-09',
    description:'Lentezza query critiche su db-prod-01',
    relatedChanges:[]
  },
  {
    id:'INC-2025-002',
    title:'Errore connessione applicazione',
    severity:'P2',
    status:'Aperto',
    category:'Applicazioni',
    assigneeId:'u5',
    reporterId:'u4',
    opened:'2025-02-11',
    description:'Timeout connessione microservizio fatturazione',
    relatedChanges:[]
  }
];

const CMDB_DEFAULT = [
  {id:'ci1', name:'db-prod-oracle-01', type:'Database', env:'PROD', ownerId:'u4', status:'Operational', version:'19c'},
  {id:'ci2', name:'fw-dmz-primary', type:'Security', env:'PROD', ownerId:'u5', status:'Operational', version:'7.2.1'},
  {id:'ci3', name:'app-invoice-svc', type:'Application', env:'PROD', ownerId:'u3', status:'Operational', version:'3.4.2'}
];

const FREEZES_DEFAULT = [
  {id:'f1', name:'Fine Anno 2025', start:'2025-12-20', end:'2026-01-05', envs:['PROD'], active:false},
  {id:'f2', name:'Black Friday 2025', start:'2025-11-25', end:'2025-11-29', envs:['PROD','CERT'], active:false}
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;
let changes = [];
let incidents = [];
let cmdbItems = [];
let freezes = [];
let notifications = [];
let currentChangeId = null;
let settings = {
  emailNotifications: true,
  requireCABApproval: true,
  defaultPipeline: 'full',
  workingHours: {start:'09:00', end:'18:00'}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
function loadData(key, fallback) {
  try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : fallback; }
  catch { return fallback; }
}
function userInitials(uid) { const u = USERS.find(x=>x.id===uid); return u?.initials || '?'; }
function userName(uid) { const u = USERS.find(x=>x.id===uid); return u?.name || 'Sconosciuto'; }
function canDo(roles) { return currentUser && roles.includes(currentUser.role); }

function sBadge(s) {
  const cls = {Aperto:'b-open','In Review':'b-review',Approvato:'b-approved',Schedulato:'b-scheduled',Autorizzato:'b-approved','In Esecuzione':'b-impl',Chiuso:'b-closed',Rifiutato:'b-rejected'}[s]||'b-open';
  return `<span class="badge ${cls}">${s}</span>`;
}
function pBadge(p) {
  const cls = {Bassa:'prio-l',Media:'prio-m',Alta:'prio-h',Critica:'prio-c'}[p]||'prio-m';
  return `<span class="prio ${cls}">‚öë ${p}</span>`;
}
function sevBadge(s) {
  const cls = {P1:'sev-p1',P2:'sev-p2',P3:'sev-p3',P4:'sev-p4'}[s]||'sev-p4';
  return `<span class="sev-badge ${cls}">${s}</span>`;
}
function rBadge(r) {
  const col = {Basso:'var(--accent2)',Medio:'var(--accent4)',Alto:'var(--accent3)',Critico:'#ff4757'}[r]||'var(--text3)';
  return `<span style="font-size:12px;color:${col}">‚óè ${r}</span>`;
}
function envInline(c) {
  const idx = c.currentEnv ?? 0;
  return `<div class="env-inline">${ENVIRONMENTS.map((e,i)=>`<span class="env-pip" style="background:${i<idx?'var(--accent2)':i===idx?'var(--accent)':'var(--surface3)'};color:${i<=idx?'#fff':'var(--text3)'}">${e.charAt(0)}</span>${i<3?'<span class="env-arrow-sm">‚Üí</span>':''}`).join('')}</div>`;
}
function incBadge(status) {
  const colors = {Aperto:'#ff6b6b','In Lavorazione':'#4f7cff','In Attesa':'#ffa94d',Risolto:'#00d4aa',Chiuso:'#525870'};
  return `<span style="font-size:11px;padding:2px 7px;border-radius:4px;background:${colors[status]||'#525870'}20;color:${colors[status]||'#525870'}">${status}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN / LOGOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initLogin() {
  const hints = document.getElementById('loginHints');
  if(hints) {
    hints.innerHTML = USERS.slice(0,4).map(u=>`<span class="login-user-pill" onclick="document.getElementById('loginUser').value='${u.username}';document.getElementById('loginPass').value='demo'">${u.username} <span style="color:var(--text3)">(${ROLE_LABELS[u.role]})</span></span>`).join('');
  }
  const saved = localStorage.getItem(LS_USER);
  if(saved) {
    try {
      const u = JSON.parse(saved);
      const valid = USERS.find(x=>x.username===u.username && x.password===u.password);
      if(valid) { currentUser = valid; showApp(); return; }
    } catch {}
  }
}

function doLogin() {
  const userIn = document.getElementById('loginUser').value.trim();
  const passIn = document.getElementById('loginPass').value;
  const err = document.getElementById('loginErr');
  err.textContent = '';
  const u = USERS.find(x => x.username===userIn && x.password===passIn);
  if(!u) { err.textContent = 'Credenziali non valide'; return; }
  currentUser = u;
  localStorage.setItem(LS_USER, JSON.stringify({username:u.username, password:u.password}));
  showApp();
}

function showApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').classList.add('visible');
  
  const btnNewChange = document.getElementById('btnNewChange');
  if(btnNewChange) {
    const allowedRoles = ['change_requestor', 'change_manager', 'admin'];
    btnNewChange.style.display = allowedRoles.includes(currentUser.role) ? 'inline-flex' : 'none';
  }
  
  document.getElementById('sideName').textContent = currentUser.name;
  document.getElementById('sideRoleTag').textContent = ROLE_LABELS[currentUser.role];
  document.getElementById('sideAvatar').textContent = currentUser.initials;
  
  changes = loadData(LS_CHANGES, [...CHANGES_DEFAULT]);
  incidents = loadData(LS_INCIDENTS, [...INCIDENTS_DEFAULT]);
  cmdbItems = loadData(LS_CMDB, [...CMDB_DEFAULT]);
  freezes = loadData(LS_FREEZES, [...FREEZES_DEFAULT]);
  notifications = loadData(LS_NOTIFS, []);
  settings = loadData(LS_SETTINGS, settings);
  
  checkFreezeBanner();
  renderNav();
  renderNotifList();
  updateBadges();
  showPage('dashboard', document.getElementById('nav-dashboard'));
}

function doLogout() {
  currentUser = null;
  localStorage.removeItem(LS_USER);
  document.getElementById('appScreen').classList.remove('visible');
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginErr').textContent = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderNav() {
  const nav = document.getElementById('sideNav');
  const items = [
    {sect:'PRINCIPALE'},
    {id:'dashboard', icon:'üìä', label:'Dashboard'},
    {id:'changes', icon:'üîÑ', label:'Tutti i Change', badge:'open'},
    {id:'pipeline', icon:'üåê', label:'Pipeline Ambienti'},
    {id:'approvals', icon:'‚è±', label:'Approvazioni', roles:['change_manager','admin'], badge:'approvals'},
    {id:'cab', icon:'üë•', label:'CAB Board', roles:['change_manager','admin','env_owner'], badge:'cab'},
    {id:'calendar', icon:'üìÖ', label:'Calendario & Freeze'},
    {sect:'ANALISI'},
    {id:'reports', icon:'üìà', label:'Report & Analytics', roles:['change_manager','admin']},
    {id:'incidents', icon:'‚ö†Ô∏è', label:'Incidenti Correlati', badge:'incidents'},
    {sect:'CONFIGURAZIONE'},
    {id:'cmdb', icon:'üóÑ', label:'CMDB'},
    {id:'settings', icon:'‚öôÔ∏è', label:'Impostazioni', roles:['admin']}
  ];
  
  nav.innerHTML = items.map(it=>{
    if(it.sect) return `<div class="nav-sect">${it.sect}</div>`;
    if(it.roles && !it.roles.includes(currentUser.role)) return '';
    const badge = it.badge ? `<span class="nav-badge ${it.badge==='incidents'?'red':it.badge==='cab'?'green':'orange'}" id="badge-${it.badge}" style="display:none">0</span>` : '';
    return `<div class="nav-item" id="nav-${it.id}" onclick="showPage('${it.id}',this)">
      <span class="nav-icon">${it.icon}</span> ${it.label}${badge}
    </div>`;
  }).join('');
}

function showPage(pageId, navEl) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(`page-${pageId}`).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(navEl) navEl.classList.add('active');
  
  const titles = {
    dashboard:'Dashboard', changes:'Tutti i Change', pipeline:'Pipeline Ambienti',
    approvals:'Approvazioni', cab:'CAB Board', calendar:'Calendario & Freeze',
    reports:'Report & Analytics', incidents:'Incidenti Correlati', cmdb:'CMDB', settings:'Impostazioni'
  };
  document.getElementById('pageTitle').textContent = titles[pageId] || 'ChangeFlow';
  
  if(pageId==='dashboard') renderDashboard();
  if(pageId==='changes') renderChanges();
  if(pageId==='pipeline') renderPipeline();
  if(pageId==='approvals') renderApprovals();
  if(pageId==='cab') renderCAB();
  if(pageId==='calendar') renderCalendar();
  if(pageId==='reports') renderReports();
  if(pageId==='incidents') renderIncidents();
  if(pageId==='cmdb') renderCMDB();
  if(pageId==='settings') renderSettings();
}

function updateBadges() {
  const open = changes.filter(c=>c.status==='Aperto').length;
  const appr = changes.filter(c=>c.status==='In Review').length;
  const cab = changes.filter(c=>c.status==='Approvato' || c.status==='Schedulato').length;
  const inc = incidents.filter(i=>i.status!=='Chiuso').length;
  
  const badges = {open, approvals:appr, cab, incidents:inc};
  Object.entries(badges).forEach(([key,val])=>{
    const el = document.getElementById(`badge-${key}`);
    if(el) { el.textContent = val; el.style.display = val>0?'inline-block':'none'; }
  });
}

function checkFreezeBanner() {
  const now = new Date().toISOString().split('T')[0];
  const activeFreeze = freezes.find(f=>f.start<=now && f.end>=now && f.envs.includes('PROD'));
  const banner = document.getElementById('freezeBanner');
  if(banner) banner.style.display = activeFreeze ? 'flex' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const vc = changes;
  const byStatus = Object.fromEntries(STATUS_ORDER.map(s=>[s, vc.filter(c=>c.status===s).length]));
  const stats = [
    {n:byStatus['Aperto']||0, l:'Aperti', t:'Da prendere in carico', c:'#ff6b6b'},
    {n:byStatus['In Review']||0, l:'In Review', t:'In attesa di approvazione', c:'#4f7cff'},
    {n:byStatus['Schedulato']||0, l:'Schedulati', t:'In pianificazione', c:'#ffa94d'},
    {n:byStatus['In Esecuzione']||0, l:'In Esecuzione', t:'Change attivi', c:'#ffa94d'},
    {n:byStatus['Chiuso']||0, l:'Chiusi', t:'Completati con successo', c:'#00d4aa'}
  ];
  
  document.getElementById('page-dashboard').innerHTML = `
  <div class="stats-grid">
    ${stats.map(st=>`<div class="stat-card" style="--accent:${st.c}" onclick="filterByStatus('${st.l.replace(' ','')}')">
      <div class="stat-n">${st.n}</div><div class="stat-l">${st.l}</div><div class="stat-t">${st.t}</div>
    </div>`).join('')}
  </div>
  <div class="table-wrap">
    <div class="table-header">
      <div class="tbl-title">Change Recenti</div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="search-box">üîç <input placeholder="Cerca..." oninput="filterTable(this.value)"></div>
        <select class="fsel" onchange="filterByStatus(this.value)"><option value="">Tutti gli stati</option>${STATUS_ORDER.map(s=>`<option>${s}</option>`).join('')}</select>
      </div>
    </div>
    <table><thead><tr><th>ID</th><th>Titolo</th><th>Tipo</th><th>Priorit√†</th><th>Stato</th><th>Richiedente</th><th>Ambiente</th></tr></thead>
    <tbody id="changesTbody">
      ${vc.slice(0,10).map(c=>`
        <tr onclick="openDetail('${c.id}')" style="cursor:pointer">
          <td class="chg-id">${c.id}</td>
          <td style="font-weight:500">${c.title}</td>
          <td><span class="type-tag">${c.type}</span></td>
          <td>${pBadge(c.priority)}</td>
          <td>${sBadge(c.status)}</td>
          <td style="color:var(--text2)">${userName(c.requesterId)}</td>
          <td>${envInline(c)}</td>
        </tr>`).join('')}
    </tbody></table>
  </div>`;
}

function filterByStatus(status) {
  const rows = document.getElementById('changesTbody')?.querySelectorAll('tr') || [];
  rows.forEach(r=>{
    const txt = r.textContent.toLowerCase();
    r.style.display = !status || txt.includes(status.toLowerCase()) ? '' : 'none';
  });
}

function filterTable(q) {
  const rows = document.getElementById('changesTbody')?.querySelectorAll('tr') || [];
  const qq = q.toLowerCase();
  rows.forEach(r=>{ r.style.display = r.textContent.toLowerCase().includes(qq) ? '' : 'none'; });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANGES LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderChanges() {
  const vc = changes.filter(c=> canDo(['admin','change_manager']) || c.requesterId===currentUser.id || c.assigneeId===currentUser.id);
  document.getElementById('page-changes').innerHTML = `
  <div class="table-wrap">
    <div class="table-header">
      <div class="tbl-title">Tutti i Change (${vc.length})</div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="search-box">üîç <input placeholder="Cerca ID, titolo, richiedente..." oninput="filterTable(this.value)"></div>
        <select class="fsel" onchange="renderChangesByStatus(this.value)"><option value="">Tutti</option>${STATUS_ORDER.map(s=>`<option>${s}</option>`).join('')}</select>
      </div>
    </div>
    <table><thead><tr><th>ID</th><th>Titolo</th><th>Tipo</th><th>Priorit√†</th><th>Stato</th><th>Richiedente</th><th>Assegnato</th><th>Incidenti</th><th>Azioni</th></tr></thead>
    <tbody id="changesTbody">
      ${vc.map(c=>`
        <tr>
          <td class="chg-id">${c.id}</td>
          <td style="font-weight:500">${c.title}</td>
          <td><span class="type-tag">${c.type}</span></td>
          <td>${pBadge(c.priority)}</td>
          <td>${sBadge(c.status)}</td>
          <td style="color:var(--text2)">${userName(c.requesterId)}</td>
          <td style="color:var(--text2)">${userName(c.assigneeId)}</td>
          <td>${c.incidentIds?.length?`<span style="font-family:var(--mono);font-size:11px;color:var(--accent3)">${c.incidentIds.length}</span>`:'-'}</td>
          <td><button class="btn btn-ghost btn-xs" onclick="openDetail('${c.id}')">Dettaglio</button></td>
        </tr>`).join('')}
    </tbody></table>
  </div>`;
}

function renderChangesByStatus(status) {
  const rows = document.getElementById('changesTbody')?.querySelectorAll('tr') || [];
  rows.forEach(r=>{
    const txt = r.textContent;
    r.style.display = !status || txt.includes(status) ? '' : 'none';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIPELINE AMBIENTI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPipeline() {
  const byEnv = {
    DEV: changes.filter(c=>c.currentEnv===0 && c.status!=='Chiuso'),
    INTEG: changes.filter(c=>c.currentEnv===1 && c.status!=='Chiuso'),
    CERT: changes.filter(c=>c.currentEnv===2 && c.status!=='Chiuso'),
    PROD: changes.filter(c=>c.currentEnv===3 && c.status!=='Chiuso')
  };
  
  document.getElementById('page-pipeline').innerHTML = `
  <div class="pipeline-grid">
    ${['DEV','INTEG','CERT','PROD'].map(env=>`
      <div class="pipeline-col">
        <div class="pipeline-col-title">
          <span style="width:8px;height:8px;border-radius:50%;background:${env==='PROD'?'var(--accent3)':'var(--accent2)'}"></span>
          ${env}
          <span class="pipeline-col-count">${byEnv[env].length}</span>
        </div>
        ${byEnv[env].map(c=>`
          <div class="pipeline-item" onclick="openDetail('${c.id}')">
            <div class="pipeline-item-id">${c.id}</div>
            <div class="pipeline-item-title">${c.title}</div>
            <div class="pipeline-item-meta">
              <span>${pBadge(c.priority)}</span>
              <span>‚Ä¢</span>
              <span>${userName(c.assigneeId)}</span>
            </div>
          </div>
        `).join('')||'<div style="color:var(--text3);font-size:12px;text-align:center;padding:20px">Nessun change</div>'}
      </div>
    `).join('')}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPROVALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderApprovals() {
  const vc = changes.filter(c=> c.status==='In Review' && canDo(['change_manager','admin']));
  document.getElementById('page-approvals').innerHTML = `
  <div class="table-wrap">
    <div class="table-header"><div class="tbl-title">In attesa di approvazione (${vc.length})</div></div>
    <table><thead><tr><th>ID</th><th>Titolo</th><th>Richiedente</th><th>Rischio</th><th>Impatto</th><th>Aperto il</th><th>Azioni</th></tr></thead>
    <tbody>
      ${vc.length? vc.map(c=>`
        <tr>
          <td class="chg-id">${c.id}</td>
          <td>${c.title}</td>
          <td>${userName(c.requesterId)}</td>
          <td>${rBadge(c.risk)}</td>
          <td>${rBadge(c.impact)}</td>
          <td style="font-family:var(--mono);font-size:12px">${c.opened}</td>
          <td>
            <button class="btn btn-success btn-xs" onclick="quickTransition('${c.id}','Approvato')">‚úÖ Approva</button>
            <button class="btn btn-danger btn-xs" onclick="quickTransition('${c.id}','Rifiutato')">‚ùå Rifiuta</button>
          </td>
        </tr>`).join('')
      : `<tr><td colspan="7" style="text-align:center;color:var(--text3);padding:20px">Nessun change in attesa di approvazione</td></tr>`}
    </tbody></table>
  </div>`;
}

function quickTransition(id, toStatus) {
  doTransition(id, toStatus);
  renderApprovals();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAB BOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCAB() {
  const vc = changes.filter(c=> ['Approvato','Schedulato'].includes(c.status));
  document.getElementById('page-cab').innerHTML = `
  <div class="cab-header">
    <div style="font-size:16px;font-weight:600">CAB Board ‚Äî Change Advisory Board</div>
    <div style="color:var(--text3);font-size:13px">${vc.length} change in revisione</div>
  </div>
  ${vc.map(c=>`
    <div class="cab-card">
      <div class="cab-card-hdr">
        <div>
          <div class="cab-card-title">${c.id} ‚Äî ${c.title}</div>
          <div class="cab-card-meta">
            <span>üìÖ ${c.window||'Da pianificare'}</span>
            <span>üë§ ${userName(c.requesterId)}</span>
            <span>${sBadge(c.status)}</span>
            <span>${pBadge(c.priority)}</span>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px;color:var(--text3)">Rischio: ${c.risk}</div>
          <div style="font-size:12px;color:var(--text3)">Impatto: ${c.impact}</div>
        </div>
      </div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:10px">${c.desc}</div>
      ${c.incidentIds?.length?`<div style="font-size:11px;color:var(--accent3);margin-bottom:8px">üîó ${c.incidentIds.length} incidenti correlati</div>`:''}
      <div class="cab-actions">
        ${c.status==='Approvato'?`
          <button class="btn btn-primary btn-sm" onclick="doTransition('${c.id}','Schedulato')">üìÖ Pianifica</button>
        `:''}
        ${c.status==='Schedulato'?`
          <button class="btn btn-success btn-sm" onclick="doTransition('${c.id}','Autorizzato')">‚úÖ Autorizza</button>
          <button class="btn btn-warning btn-sm" onclick="doTransition('${c.id}','Approvato')">‚Ü©Ô∏è Torna ad Approvato</button>
        `:''}
        <button class="btn btn-ghost btn-sm" onclick="openDetail('${c.id}')">üìã Dettaglio</button>
      </div>
    </div>
  `).join('')||'<div class="card" style="text-align:center;color:var(--text3);padding:40px">Nessun change in CAB</div>'}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR & FREEZE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCalendar() {
  const today = new Date();
  const month = today.toLocaleString('it-IT',{month:'long', year:'numeric'}).replace(/^\w/,c=>c.toUpperCase());
  const days = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];
  
  let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <div style="font-size:16px;font-weight:600">${month}</div>
    <div style="display:flex;gap:8px;align-items:center">
      <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer">
        <input type="checkbox" id="showFreezes" checked onchange="renderCalendar()" style="width:14px;height:14px"> Mostra Freeze
      </label>
      ${canDo(['admin'])?`<button class="btn btn-primary btn-sm" onclick="openFreezeModal()">+ Aggiungi Freeze</button>`:''}
    </div>
  </div>
  <div class="cal-pg-hd-row">${days.map(d=>`<div class="cal-pg-hd">${d}</div>`).join('')}</div>
  <div class="cal-pg-grid">`;
  
  const showFreezes = document.getElementById('showFreezes')?.checked ?? true;
  for(let i=1;i<=42;i++) {
    const dayNum = i - (today.getDay()===0?6:today.getDay()-1);
    const dateStr = dayNum>0 ? `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}` : '';
    const hasChg = changes.some(c=> c.window && c.window.startsWith(dateStr));
    const isFreeze = showFreezes && freezes.some(f=>f.start<=dateStr && f.end>=dateStr);
    const isToday = dayNum===today.getDate() && i>=(today.getDay()===0?7:today.getDay()) && i<=(today.getDay()===0?7:today.getDay())+31;
    html += `<div class="cal-pg-day ${hasChg?'has-chg':''} ${isFreeze?'freeze':''} ${isToday?'today':''}" onclick="${dateStr?`filterByDate('${dateStr}')`:''}">
      ${dayNum>0&&dayNum<=31?dayNum:''}
      ${hasChg?'<div class="cal-pip"></div>':''}
      ${isFreeze?'<div style="font-size:8px;margin-top:2px">‚ùÑÔ∏è</div>':''}
    </div>`;
  }
  html += `</div>`;
  
  document.getElementById('page-calendar').innerHTML = `
  <div class="card" style="margin-bottom:16px">
    <div class="card-title">Change Pianificati</div>
    ${changes.filter(c=>c.window).slice(0,5).map(c=>`
      <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:13px;font-weight:500">${c.title}</div>
          <div style="font-size:11px;color:var(--text3);font-family:var(--mono)">${c.window} ‚Üí ${c.windowEnd||'TBD'}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${sBadge(c.status)}
          <button class="btn btn-ghost btn-xs" onclick="openDetail('${c.id}')">‚Üí</button>
        </div>
      </div>`).join('')||'<div style="color:var(--text3);font-size:13px">Nessun change pianificato</div>'}
  </div>
  <div class="card" style="margin-bottom:16px">
    <div class="card-title">Periodi di Freeze</div>
    ${freezes.map(f=>`
      <div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:13px;font-weight:500;color:#c084fc">‚ùÑÔ∏è ${f.name}</div>
          <div style="font-size:11px;color:var(--text3)">${f.start} ‚Üí ${f.end}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:11px;color:var(--text3)">${f.envs.join(', ')}</span>
          ${canDo(['admin'])?`<button class="btn btn-ghost btn-xs" onclick="deleteFreeze('${f.id}')">üóëÔ∏è</button>`:''}
        </div>
      </div>`).join('')||'<div style="color:var(--text3);font-size:13px">Nessun periodo di freeze configurato</div>'}
  </div>
  ${html}`;
}

function filterByDate(dateStr) {
  const filtered = changes.filter(c=>c.window?.startsWith(dateStr));
  if(filtered.length) {
    showPage('changes', document.getElementById('nav-changes'));
    setTimeout(()=>{
      const tbody = document.getElementById('changesTbody');
      if(tbody) tbody.innerHTML = filtered.map(c=>`
        <tr>
          <td class="chg-id">${c.id}</td>
          <td style="font-weight:500">${c.title}</td>
          <td><span class="type-tag">${c.type}</span></td>
          <td>${pBadge(c.priority)}</td>
          <td>${sBadge(c.status)}</td>
          <td style="color:var(--text2)">${userName(c.requesterId)}</td>
          <td style="color:var(--text2)">${userName(c.assigneeId)}</td>
          <td>${c.incidentIds?.length||'-'}</td>
          <td><button class="btn btn-ghost btn-xs" onclick="openDetail('${c.id}')">Dettaglio</button></td>
        </tr>`).join('');
    },100);
  }
}

function openFreezeModal() {
  const name = prompt('Nome periodo di freeze (es. "Black Friday 2025"):');
  if(!name) return;
  const start = prompt('Data inizio (YYYY-MM-DD):');
  if(!start) return;
  const end = prompt('Data fine (YYYY-MM-DD):');
  if(!end) return;
  const envs = prompt('Ambienti (separati da virgola, es. PROD,CERT):','PROD');
  freezes.push({id:'f'+Date.now(), name, start, end, envs:envs.split(',').map(e=>e.trim().toUpperCase()), active:true});
  saveData(LS_FREEZES, freezes);
  renderCalendar();
  checkFreezeBanner();
}

function deleteFreeze(id) {
  if(!confirm('Eliminare questo periodo di freeze?')) return;
  freezes = freezes.filter(f=>f.id!==id);
  saveData(LS_FREEZES, freezes);
  renderCalendar();
  checkFreezeBanner();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INCIDENTI CORRELATI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderIncidents() {
  document.getElementById('page-incidents').innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <div style="font-size:16px;font-weight:600">Incidenti Correlati</div>
    <button class="btn btn-primary btn-sm" onclick="openModal('incidentModal')">+ Nuovo Incidente</button>
  </div>
  <div class="table-wrap">
    <div class="table-header">
      <div class="tbl-title">Tutti gli Incidenti (${incidents.length})</div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <div class="search-box">üîç <input placeholder="Cerca..." oninput="filterIncidents(this.value)"></div>
        <select class="fsel" id="filterIncSev" onchange="renderIncidents()">
          <option value="">Tutte le severit√†</option>
          <option value="P1">P1 - Critica</option>
          <option value="P2">P2 - Alta</option>
          <option value="P3">P3 - Media</option>
          <option value="P4">P4 - Bassa</option>
        </select>
      </div>
    </div>
    <table><thead><tr><th>ID</th><th>Titolo</th><th>Severit√†</th><th>Stato</th><th>Categoria</th><th>Assegnato</th><th>Change Correlati</th></tr></thead>
    <tbody id="incidentsTbody">
      ${incidents.map(inc=>`
        <tr>
          <td class="chg-id" style="color:var(--accent3)">${inc.id}</td>
          <td style="font-weight:500">${inc.title}</td>
          <td>${sevBadge(inc.severity)}</td>
          <td>${incBadge(inc.status)}</td>
          <td><span class="type-tag">${inc.category}</span></td>
          <td style="color:var(--text2)">${userName(inc.assigneeId)}</td>
          <td>${inc.relatedChanges?.length?`<span style="font-family:var(--mono);font-size:11px;color:var(--accent)">${inc.relatedChanges.length}</span>`:'-'}</td>
        </tr>`).join('')}
    </tbody></table>
  </div>`;
}

function filterIncidents(q) {
  const rows = document.getElementById('incidentsTbody')?.querySelectorAll('tr') || [];
  const qq = q.toLowerCase();
  rows.forEach(r=>{ r.style.display = r.textContent.toLowerCase().includes(qq) ? '' : 'none'; });
}

function submitIncident() {
  const title = document.getElementById('incTitle')?.value?.trim();
  if(!title) { alert('Inserisci il titolo'); return; }
  const num = String(incidents.length+1).padStart(3,'0');
  const inc = {
    id: `INC-${new Date().getFullYear()}-${num}`,
    title,
    severity: document.getElementById('incSev')?.value||'P3',
    status: document.getElementById('incStatus')?.value||'Aperto',
    category: document.getElementById('incCat')?.value||'Applicazioni',
    assigneeId: document.getElementById('incAssignee')?.value||currentUser.id,
    reporterId: currentUser.id,
    opened: new Date().toISOString().split('T')[0],
    description: document.getElementById('incDesc')?.value||'',
    relatedChanges: []
  };
  incidents.unshift(inc);
  saveData(LS_INCIDENTS, incidents);
  addNotification(`Nuovo incidente ${inc.id} creato: "${title}"`);
  closeModal('incidentModal');
  ['incTitle','incDesc'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  renderIncidents();
  updateBadges();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReports() {
  if(!canDo(['admin','change_manager'])){ document.getElementById('page-reports').innerHTML=accessDenied('Reports'); return; }
  const vc = changes;
  const total = vc.length;
  const closed = vc.filter(c=>c.status==='Chiuso').length;
  const byStatus = Object.fromEntries(STATUS_ORDER.map(s=>[s, vc.filter(c=>c.status===s).length]));
  const byType = {'Standard':0,'Normale':0,'Emergenza':0};
  vc.forEach(c=>{ if(byType[c.type]!==undefined) byType[c.type]++; });
  
  document.getElementById('page-reports').innerHTML = `
  <div class="kpi-row">
    <div class="kpi"><div class="kpi-v">${total}</div><div class="kpi-l">Totali</div></div>
    <div class="kpi"><div class="kpi-v">${vc.filter(c=>c.status==='Aperto').length}</div><div class="kpi-l">Aperti</div></div>
    <div class="kpi"><div class="kpi-v">${closed}</div><div class="kpi-l">Chiusi</div></div>
    <div class="kpi"><div class="kpi-v">${total?Math.round(closed/total*100):0}%</div><div class="kpi-l">Success Rate</div></div>
    <div class="kpi"><div class="kpi-v">${incidents.filter(i=>i.status!=='Chiuso').length}</div><div class="kpi-l">Incidenti Aperti</div></div>
  </div>
  <div class="reports-grid">
    <div class="chart-wrap"><div class="chart-title">Per Stato</div><div class="bar-chart">${Object.entries(byStatus).map(([k,v])=>{
      const pct=Math.round(v/(total||1)*100);
      const col={Aperto:'#ff6b6b','In Review':'#4f7cff',Approvato:'#00d4aa',Schedulato:'#ffa94d',Autorizzato:'#00d4aa','In Esecuzione':'#ffa94d',Chiuso:'#525870',Rifiutato:'#ff6b6b'}[k]||'#4f7cff';
      return `<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,4)}%;background:${col}"><span class="bar-val">${v}</span></div></div></div>`;
    }).join('')}</div></div>
    <div class="chart-wrap"><div class="chart-title">Per Tipo</div><div class="bar-chart">${Object.entries(byType).map(([k,v])=>{
      const pct=Math.round(v/(total||1)*100);
      const col={Standard:'#4f7cff',Normale:'#ffa94d',Emergenza:'#ff6b6b'}[k]||'#4f7cff';
      return `<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.max(pct,4)}%;background:${col}"><span class="bar-val">${v}</span></div></div></div>`;
    }).join('')}</div></div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CMDB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CI_ICONS={Network:'üåê',Database:'üóÑ',Server:'üñ•',Application:'üì¶',Storage:'üíæ',Security:'üîí'};
function renderCMDB() {
  document.getElementById('page-cmdb').innerHTML=`
  <div style="display:grid;grid-template-columns:1fr 280px;gap:16px">
    <div class="table-wrap">
      <div class="table-header">
        <div class="tbl-title">Configuration Items (${cmdbItems.length})</div>
        ${canDo(['admin','change_manager','env_owner'])?`<button class="btn btn-primary btn-sm" style="margin-left:auto" onclick="openModal('ciModal')">+ Aggiungi CI</button>`:''}
      </div>
      <table><thead><tr><th>CI</th><th>Tipo</th><th>Ambiente</th><th>Owner</th><th>Stato</th><th>Versione</th></tr></thead>
      <tbody>${cmdbItems.map(ci=>`
        <tr>
          <td><div style="display:flex;align-items:center;gap:8px"><span style="font-size:16px">${CI_ICONS[ci.type]||'üìÅ'}</span><span style="font-family:var(--mono);font-size:12px">${ci.name}</span></div></td>
          <td><span class="type-tag">${ci.type}</span></td>
          <td style="font-family:var(--mono);font-size:11px">${ci.env}</td>
          <td style="color:var(--text2)">${userName(ci.ownerId)}</td>
          <td><span style="font-size:12px;color:${ci.status==='Operational'?'var(--accent2)':'var(--accent4)'}">‚óè ${ci.status}</span></td>
          <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${ci.version||'‚Äî'}</td>
        </tr>`).join('')}</tbody></table>
    </div>
    <div class="card">
      <div class="card-title">Riepilogo per Tipo</div>
      ${Object.entries(CI_ICONS).map(([t,ic])=>{
        const cnt=cmdbItems.filter(c=>c.type===t).length;
        return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><span style="font-size:18px">${ic}</span><span style="font-size:13px;flex:1">${t}</span><span style="font-family:var(--mono);font-size:13px;font-weight:600;color:var(--accent)">${cnt}</span></div>`;
      }).join('')}
    </div>
  </div>`;
}

function submitCI() {
  const name = document.getElementById('ciName')?.value?.trim();
  if(!name) { alert('Inserisci il nome del CI'); return; }
  const ci = {
    id: 'ci'+Date.now(),
    name, 
    type: document.getElementById('ciType')?.value||'Server',
    env: document.getElementById('ciEnv')?.value||'PROD',
    ownerId: document.getElementById('ciOwner')?.value||currentUser.id,
    status: document.getElementById('ciStatus')?.value||'Operational',
    version: document.getElementById('ciVersion')?.value||'‚Äî',
    notes: document.getElementById('ciNotes')?.value||'',
    createdAt: new Date().toISOString().split('T')[0],
  };
  cmdbItems.push(ci);
  saveData(LS_CMDB, cmdbItems);
  addNotification(`Nuovo CI aggiunto: ${name} (${ci.type})`);
  closeModal('ciModal');
  ['ciName','ciVersion','ciNotes'].forEach(fid=>{ const el=document.getElementById(fid); if(el)el.value=''; });
  renderCMDB();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPOSTAZIONI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSettings() {
  if(!canDo(['admin'])){ document.getElementById('page-settings').innerHTML=accessDenied('Impostazioni'); return; }
  
  document.getElementById('page-settings').innerHTML = `
  <div class="settings-grid">
    <div class="settings-nav">
      <div class="settings-nav-item active" onclick="showSettingsPanel('general',this)">‚öôÔ∏è Generale</div>
      <div class="settings-nav-item" onclick="showSettingsPanel('workflow',this)">üîÑ Workflow</div>
      <div class="settings-nav-item" onclick="showSettingsPanel('notifications',this)">üîî Notifiche</div>
      <div class="settings-nav-item" onclick="showSettingsPanel('users',this)">üë• Utenti</div>
    </div>
    <div>
      <div id="settings-general" class="settings-panel">
        <div class="settings-section">
          <div class="settings-section-title">Configurazione Generale</div>
          <div class="setting-row">
            <div>
              <div class="setting-label">Nome Sistema</div>
              <div class="setting-desc">Nome visualizzato nell'applicazione</div>
            </div>
            <input type="text" value="ChangeFlow" style="width:200px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:6px 10px;font-size:13px;color:var(--text)">
          </div>
          <div class="setting-row">
            <div>
              <div class="setting-label">Fuso Orario</div>
              <div class="setting-desc">Fuso orario predefinito</div>
            </div>
            <select style="width:200px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:6px 10px;font-size:13px;color:var(--text)">
              <option>Europe/Rome (UTC+1)</option>
              <option>UTC</option>
              <option>America/New_York (UTC-5)</option>
            </select>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-section-title">Orario Lavorativo</div>
          <div class="setting-row">
            <div>
              <div class="setting-label">Ora Inizio</div>
              <div class="setting-desc">Inizio giornata lavorativa</div>
            </div>
            <input type="time" value="${settings.workingHours.start}" style="width:150px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:6px 10px;font-size:13px;color:var(--text)">
          </div>
          <div class="setting-row">
            <div>
              <div class="setting-label">Ora Fine</div>
              <div class="setting-desc">Fine giornata lavorativa</div>
            </div>
            <input type="time" value="${settings.workingHours.end}" style="width:150px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:6px 10px;font-size:13px;color:var(--text)">
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveSettings()">üíæ Salva Impostazioni</button>
      </div>
      
      <div id="settings-workflow" class="settings-panel" style="display:none">
        <div class="settings-section">
          <div class="settings-section-title">Configurazione Workflow</div>
          <div class="setting-row">
            <div>
              <div class="setting-label">Richiedi Approvazione CAB</div>
              <div class="setting-desc">Tutti i change richiedono approvazione CAB</div>
            </div>
            <label style="display:flex;align-items:center;cursor:pointer">
              <input type="checkbox" ${settings.requireCABApproval?'checked':''} style="width:18px;height:18px;margin-right:8px">
              <span style="font-size:13px">Attivo</span>
            </label>
          </div>
          <div class="setting-row">
            <div>
              <div class="setting-label">Pipeline Predefinita</div>
              <div class="setting-desc">Strategia di deployment default</div>
            </div>
            <select style="width:200px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:6px 10px;font-size:13px;color:var(--text)">
              <option ${settings.defaultPipeline==='full'?'selected':''}>Completo (DEV‚ÜíINT‚ÜíCERT‚ÜíPROD)</option>
              <option ${settings.defaultPipeline==='skip-dev'?'selected':''}>Skip DEV (INT‚ÜíCERT‚ÜíPROD)</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveSettings()">üíæ Salva Impostazioni</button>
      </div>
      
      <div id="settings-notifications" class="settings-panel" style="display:none">
        <div class="settings-section">
          <div class="settings-section-title">Notifiche Email</div>
          <div class="setting-row">
            <div>
              <div class="setting-label">Attiva Notifiche Email</div>
              <div class="setting-desc">Invia email per nuovi change e approvazioni</div>
            </div>
            <label style="display:flex;align-items:center;cursor:pointer">
              <input type="checkbox" ${settings.emailNotifications?'checked':''} style="width:18px;height:18px;margin-right:8px">
              <span style="font-size:13px">Attivo</span>
            </label>
          </div>
          <div class="setting-row">
            <div>
              <div class="setting-label">SMTP Server</div>
              <div class="setting-desc">Server SMTP per invio email</div>
            </div>
            <input type="text" placeholder="smtp.company.local" style="width:250px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:6px 10px;font-size:13px;color:var(--text)">
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveSettings()">üíæ Salva Impostazioni</button>
      </div>
      
      <div id="settings-users" class="settings-panel" style="display:none">
        <div class="settings-section">
          <div class="settings-section-title">Gestione Utenti</div>
          <div style="margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="alert('Funzionalit√† in sviluppo')">+ Aggiungi Utente</button>
          </div>
          <table><thead><tr><th>Nome</th><th>Username</th><th>Ruolo</th><th>Team</th><th>Email</th></tr></thead>
          <tbody>${USERS.map(u=>`
            <tr><td>${u.name}</td><td style="font-family:var(--mono);font-size:12px;color:var(--accent)">${u.username}</td>
            <td><span class="role-tag role-${u.role}">${ROLE_LABELS[u.role]}</span></td>
            <td style="color:var(--text2)">${u.team}</td>
            <td style="font-size:12px;color:var(--text3)">${u.email}</td></tr>`).join('')}</tbody></table>
        </div>
      </div>
    </div>
  </div>`;
}

function showSettingsPanel(panelId, el) {
  document.querySelectorAll('.settings-nav-item').forEach(i=>i.classList.remove('active'));
  el.classList.add('active');
  ['general','workflow','notifications','users'].forEach(p=>{
    document.getElementById(`settings-${p}`).style.display = p===panelId?'block':'none';
  });
}

function saveSettings() {
  settings.emailNotifications = document.querySelector('#settings-notifications input[type="checkbox"]')?.checked ?? true;
  settings.requireCABApproval = document.querySelector('#settings-workflow input[type="checkbox"]')?.checked ?? true;
  saveData(LS_SETTINGS, settings);
  alert('Impostazioni salvate con successo!');
  addNotification('Impostazioni sistema aggiornate');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetail(id) {
  currentChangeId = id;
  const c = changes.find(x=>x.id===id);
  if(!c) return;

  document.getElementById('dTitle').textContent = `${c.id} ‚Äî ${c.title}`;
  const dtpBadge = c.pipelineStrategy==='direct'?'<span style="background:rgba(255,107,107,.1);border:1px solid rgba(255,107,107,.25);border-radius:4px;padding:2px 7px;font-size:10px;color:#ff8585;font-family:var(--mono)">DIRECT</span>':'';
  document.getElementById('dBadges').innerHTML = `${sBadge(c.status)} ${pBadge(c.priority)} <span class="type-tag">${c.type}</span> ${dtpBadge}`;

  const wfIdx = STATUS_WF_IDX[c.status]??0;
  document.getElementById('dWorkflow').innerHTML = WF_STEPS.map((step,i)=>{
    const cls = i<wfIdx?'done':i===wfIdx&&c.status!=='Rifiutato'?'active':c.status==='Rifiutato'&&i===1?'rejected':'';
    return `<div class="wf-step ${cls}" style="flex:1;min-width:100px;text-align:center;position:relative">
      <div class="wf-line" style="position:absolute;top:13px;left:50%;right:-50%;height:2px;background:${i<wfIdx?'var(--accent2)':'var(--border)'};${i===WF_STEPS.length-1?'display:none':''}"></div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
        <div class="wf-dot">${i<wfIdx?'‚úì':c.status==='Rifiutato'&&i===1?'‚úï':(i+1)}</div>
        <div class="wf-lbl">${step.label}</div>
        <div class="wf-team">${step.team}</div>
      </div>
    </div>`;
  }).join('');

  const myTrans = (TRANSITIONS[c.status]||[]).filter(t=>t.roles.includes(currentUser.role));
  const apprBar = document.getElementById('dApprBar');
  if(myTrans.length) {
    apprBar.style.display='flex';
    apprBar.innerHTML=`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/></svg>
      <div class="appr-txt">Puoi eseguire: <strong>${myTrans.map(t=>t.label).join(' / ')}</strong> come <em>${ROLE_LABELS[currentUser.role]}</em></div>`;
  } else {
    apprBar.style.display='none';
  }

  document.querySelectorAll('#detailModal .tab').forEach((t,i)=>t.classList.toggle('active',i===0));
  renderDetailTab(c, 'dtab-detail');
  ['dtab-transition','dtab-activity','dtab-comments'].forEach(id=>{ document.getElementById(id).style.display='none'; });
  document.getElementById('dtab-detail').style.display='block';

  openModal('detailModal');
}

function renderDetailTab(c, tabId) {
  if(tabId==='dtab-detail') {
    const relatedIncs = c.incidentIds?.map(incId=>incidents.find(i=>i.id===incId)).filter(Boolean)||[];
    document.getElementById('dtab-detail').innerHTML=`
    <div class="detail-grid">
      <div>
        <div class="meta-grid">
          <div><div class="meta-lbl">Richiedente</div><div class="meta-val">${userName(c.requesterId)}</div></div>
          <div><div class="meta-lbl">Assegnato a</div><div class="meta-val">${userName(c.assigneeId)}</div></div>
          <div><div class="meta-lbl">Categoria CI</div><div class="meta-val">${c.category}</div></div>
          <div><div class="meta-lbl">Finestra</div><div class="meta-val" style="font-family:var(--mono);font-size:12px">${c.window||'TBD'}</div></div>
          <div><div class="meta-lbl">Rischio</div><div class="meta-val">${rBadge(c.risk)}</div></div>
          <div><div class="meta-lbl">Impatto</div><div class="meta-val">${rBadge(c.impact)}</div></div>
          <div><div class="meta-lbl">Aperto il</div><div class="meta-val" style="font-family:var(--mono);font-size:12px">${c.opened}</div></div>
          <div><div class="meta-lbl">Pipeline</div><div class="meta-val">${envInline(c)}</div></div>
        </div>
        <div class="sec-box"><div class="sec-box-title">Descrizione</div><p>${c.desc}</p></div>
        <div class="sec-box"><div class="sec-box-title">Piano di Rollback</div><p>${c.rollback}</p></div>
        <div class="sec-box"><div class="sec-box-title">Test Plan</div><p>${c.test}</p></div>
        ${relatedIncs.length?`<div class="sec-box"><div class="sec-box-title">üîó Incidenti Correlati</div>${relatedIncs.map(inc=>`<div style="padding:6px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><div><span style="font-family:var(--mono);font-size:11px;color:var(--accent3)">${inc.id}</span> ‚Äî ${inc.title}</div><span class="sev-badge sev-${inc.severity.toLowerCase()}">${inc.severity}</span></div>`).join('')}</div>`:''}
      </div>
      <div>
        <div class="card" style="margin-bottom:10px">
          <div class="card-title">Azioni Disponibili</div>
          ${getActionButtons(c)}
        </div>
      </div>
    </div>`;
  }
  if(tabId==='dtab-transition') {
    const myTrans = (TRANSITIONS[c.status]||[]).filter(t=>t.roles.includes(currentUser.role));
    const allTrans = TRANSITIONS[c.status]||[];
    document.getElementById('dtab-transition').innerHTML=`
    <div class="transition-box">
      <div class="transition-title">Transizioni possibili da "${c.status}"</div>
      ${allTrans.map(t=>{
        const allowed = t.roles.includes(currentUser.role);
        return `<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">
          <div style="flex:1">
            <div style="font-size:13px;font-weight:500">${t.label} ‚Üí <strong>${t.to}</strong></div>
            <div style="font-size:11px;color:var(--text3);margin-top:3px">Autorizzato per: ${t.roles.map(r=>`<span class="role-tag role-${r}" style="font-size:9px;margin-right:3px">${ROLE_LABELS[r]||r}</span>`).join('')}</div>
          </div>
          ${allowed
            ? `<button class="btn btn-primary btn-sm" onclick="doTransition('${c.id}','${t.to}')">${t.label}</button>`
            : `<span style="font-size:11px;color:var(--text3)">üîí Non autorizzato</span>`}
        </div>`;
      }).join('')||'<div style="color:var(--text3);font-size:13px">Nessuna transizione disponibile</div>'}
    </div>`;
  }
  if(tabId==='dtab-activity') {
    document.getElementById('dtab-activity').innerHTML=`
    <div>${(c.history||[]).slice().reverse().map(h=>`
      <div class="tl-item">
        <div class="tl-dot">üìã</div>
        <div>
          <div class="tl-hdr">${h.action}</div>
          <div class="tl-time">${h.time} ¬∑ ${h.userId?userName(h.userId):''}</div>
        </div>
      </div>`).join('')}</div>`;
  }
  if(tabId==='dtab-comments') {
    document.getElementById('dtab-comments').innerHTML=`
    <div id="commentsList">${(c.comments||[]).map(cm=>`
      <div class="comment">
        <div class="avatar" style="width:28px;height:28px;font-size:10px;flex-shrink:0">${cm.initials||userInitials(cm.userId)}</div>
        <div class="comment-box">
          <div style="display:flex;justify-content:space-between"><span class="comment-auth">${cm.name||userName(cm.userId)}</span><span class="comment-tm">${cm.time}</span></div>
          <div class="comment-txt">${cm.text}</div>
        </div>
      </div>`).join('')||'<div style="color:var(--text3);font-size:13px;margin-bottom:12px">Nessun commento.</div>'}</div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <div class="avatar" style="width:28px;height:28px;font-size:10px;flex-shrink:0">${currentUser.initials}</div>
      <textarea id="commentInput" placeholder="Aggiungi commento..." style="flex:1;min-height:52px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:8px 10px;font-family:var(--font);font-size:13px;color:var(--text);outline:none;resize:vertical"></textarea>
      <button class="btn btn-primary btn-sm" onclick="addComment('${c.id}')">Invia</button>
    </div>`;
  }
}

function switchTab(el, tabId) {
  document.querySelectorAll('#detailModal .tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  const all = ['dtab-detail','dtab-transition','dtab-activity','dtab-comments'];
  all.forEach(id=>{ document.getElementById(id).style.display='none'; });
  document.getElementById(tabId).style.display='block';
  const c = changes.find(x=>x.id===currentChangeId);
  if(c) renderDetailTab(c, tabId);
}

function getActionButtons(c) {
  const myTrans = (TRANSITIONS[c.status]||[]).filter(t=>t.roles.includes(currentUser.role));
  if(!myTrans.length) return `<div style="color:var(--text3);font-size:12px">Nessuna azione disponibile per il tuo ruolo (${ROLE_LABELS[currentUser.role]}) su questo change.</div>`;
  return myTrans.map(t=>`<button class="btn ${t.to==='Rifiutato'?'btn-danger':t.to==='Chiuso'&&t.label.includes('Successo')?'btn-success':'btn-primary'} btn-sm" style="width:100%;justify-content:center;margin-bottom:6px" onclick="doTransition('${c.id}','${t.to}')">${t.label}</button>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSITIONS & ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doTransition(id, toStatus) {
  const c = changes.find(x=>x.id===id);
  if(!c) return;
  const trans = (TRANSITIONS[c.status]||[]).find(t=>t.to===toStatus);
  if(!trans || !trans.roles.includes(currentUser.role)) {
    alert('Non sei autorizzato a eseguire questa transizione.');
    return;
  }
  const prevStatus = c.status;
  c.status = toStatus;
  if(!c.history) c.history=[];
  c.history.push({action:`${prevStatus} ‚Üí ${toStatus}`, userId:currentUser.id, time:new Date().toLocaleString('it-IT')});
  if(toStatus==='In Esecuzione' && c.currentEnv<4) {
    c.pipeline[c.currentEnv]='active';
  }
  if(toStatus==='Chiuso') {
    if(c.currentEnv<4) c.pipeline[c.currentEnv]='done';
  }
  saveData(LS_CHANGES, changes);
  addNotification(`${c.id}: transizione ${prevStatus} ‚Üí ${toStatus} da ${currentUser.name}`);
  updateBadges();
  openDetail(id);
}

function addComment(id) {
  const text = document.getElementById('commentInput')?.value?.trim();
  if(!text) return;
  const c = changes.find(x=>x.id===id);
  if(!c.comments) c.comments=[];
  const now = new Date().toLocaleString('it-IT');
  c.comments.push({userId:currentUser.id, name:currentUser.name, initials:currentUser.initials, time:now, text});
  saveData(LS_CHANGES, changes);
  openDetail(id);
  setTimeout(()=>{ document.querySelectorAll('#detailModal .tab')[3]?.click(); },60);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW CHANGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openNewChangeModal() {
  ['nTitle','nDesc','nRollback','nTest','nStart','nEnd'].forEach(fid=>{ 
    const el=document.getElementById(fid); 
    if(el) el.value=''; 
  });
  
  const defaults = {nType:'Standard', nPrio:'Media', nCat:'Server', nRisk:'Basso', nImpact:'Basso', nPipelineStrat:'full'};
  Object.entries(defaults).forEach(([id,val])=>{
    const el=document.getElementById(id);
    if(el) el.value=val;
  });
  
  updatePipelinePreview();
  
  const assigneeSel = document.getElementById('nAssignee');
  if(assigneeSel) {
    assigneeSel.innerHTML = USERS.filter(u => 
      ['change_manager','admin','ta'].includes(u.role) || u.team === currentUser.team
    ).map(u => `<option value="${u.id}">${u.name} (${ROLE_LABELS[u.role]||u.role})</option>`).join('');
  }
  
  // Popola incidenti correlati
  const incSel = document.getElementById('nIncidents');
  if(incSel) {
    const openIncs = incidents.filter(i=>i.status!=='Chiuso');
    incSel.innerHTML = openIncs.map(inc=>`<option value="${inc.id}">${inc.id} ‚Äî ${inc.title} [${inc.severity}]</option>`).join('');
  }
  
  openModal('newChangeModal');
  setTimeout(()=>document.getElementById('nTitle')?.focus(), 100);
}

function updatePipelinePreview() {
  const s = document.getElementById('nPipelineStrat')?.value;
  const m = {full:'DEV ‚Üí INTEG ‚Üí CERT ‚Üí PROD','skip-dev':'INTEG ‚Üí CERT ‚Üí PROD',direct:'‚ö° Direct to PROD'};
  const el = document.getElementById('pipelinePreview');
  if(el) el.textContent = m[s]||'‚Äî';
}

function submitNewChange() {
  const title = document.getElementById('nTitle')?.value?.trim();
  if(!title) { alert('Inserisci il titolo'); return; }
  const strategy = document.getElementById('nPipelineStrat')?.value||'full';
  const pipeline = strategy==='direct'?['skip','skip','skip','active']:strategy==='skip-dev'?['skip','active','pending','pending']:['active','pending','pending','pending'];
  const startEnv = strategy==='direct'?3:strategy==='skip-dev'?1:0;
  const today = new Date().toISOString().split('T')[0];
  const num = String(changes.length+1).padStart(3,'0');
  const id = `CHG-${new Date().getFullYear()}-${num}`;
  
  // Ottieni incidenti selezionati
  const incSel = document.getElementById('nIncidents');
  const incidentIds = incSel?Array.from(incSel.selectedOptions).map(o=>o.value):[];
  
  const newChange = {
    id, title,
    type: document.getElementById('nType')?.value||'Standard',
    priority: document.getElementById('nPrio')?.value||'Media',
    status: 'Aperto',
    requesterId: currentUser.id,
    assigneeId: document.getElementById('nAssignee')?.value||currentUser.id,
    category: document.getElementById('nCat')?.value||'Server',
    risk: document.getElementById('nRisk')?.value||'Basso',
    impact: document.getElementById('nImpact')?.value||'Basso',
    opened: today,
    window: document.getElementById('nStart')?.value||'',
    windowEnd: document.getElementById('nEnd')?.value||'',
    pipeline, pipelineStrategy:strategy, currentEnv:startEnv,
    incidentIds,
    deps:[], incidents:[],
    desc: document.getElementById('nDesc')?.value||'',
    rollback: document.getElementById('nRollback')?.value||'Da definire.',
    test: document.getElementById('nTest')?.value||'Da definire.',
    comments:[],
    history:[{action:'Change aperto', userId:currentUser.id, time:new Date().toLocaleString('it-IT')}]
  };
  
  // Aggiorna incidenti correlati
  incidentIds.forEach(incId=>{
    const inc = incidents.find(i=>i.id===incId);
    if(inc) {
      if(!inc.relatedChanges) inc.relatedChanges=[];
      inc.relatedChanges.push(id);
    }
  });
  saveData(LS_INCIDENTS, incidents);
  
  changes.unshift(newChange);
  saveData(LS_CHANGES, changes);
  addNotification(`Nuovo change ${id} creato da ${currentUser.name}: "${title}"`);
  closeModal('newChangeModal');
  ['nTitle','nDesc','nRollback','nTest','nStart','nEnd'].forEach(fid=>{ const el=document.getElementById(fid); if(el)el.value=''; });
  renderDashboard();
  renderChanges();
  updateBadges();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addNotification(text) {
  notifications.unshift({text, time:new Date().toLocaleString('it-IT'), read:false});
  if(notifications.length>50) notifications=notifications.slice(0,50);
  saveData(LS_NOTIFS, notifications);
  renderNotifList();
}
function renderNotifList() {
  const unread = notifications.filter(n=>!n.read).length;
  const dot = document.getElementById('notifDot');
  if(dot) dot.style.display = unread>0?'block':'none';
  const list = document.getElementById('notifList');
  if(!list) return;
  list.innerHTML = notifications.slice(0,20).map((n,i)=>`
    <div style="padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;background:${n.read?'transparent':'rgba(79,124,255,.04)'}" onclick="markRead(${i})">
      <div style="display:flex;gap:8px;align-items:flex-start">
        <div style="width:6px;height:6px;border-radius:50%;background:${n.read?'transparent':'var(--accent)'};flex-shrink:0;margin-top:4px"></div>
        <div>
          <div style="font-size:12px;line-height:1.4">${n.text}</div>
          <div style="font-size:10px;color:var(--text3);font-family:var(--mono);margin-top:2px">${n.time}</div>
        </div>
      </div>
    </div>`).join('') || '<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px">Nessuna notifica</div>';
}
function markRead(i) { notifications[i].read=true; saveData(LS_NOTIFS,notifications); renderNotifList(); }
function markAllRead() { notifications.forEach(n=>n.read=true); saveData(LS_NOTIFS,notifications); renderNotifList(); }
function toggleNotifPanel() { document.getElementById('notifPanel').classList.toggle('open'); }
document.addEventListener('click',e=>{ if(!e.target.closest('.notif-wrap')) document.getElementById('notifPanel')?.classList.remove('open'); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-ov').forEach(o=>o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); }));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR PICKER - CORRETTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let calTargetInput = null;
let calDate = new Date();
let calSelected = null;

function openCalPicker(inputId, event) {
  event.preventDefault();
  event.stopPropagation();
  
  calTargetInput = inputId;
  const input = document.getElementById(inputId);
  
  // Inizializza sempre calSelected
  if(input?.value) {
    const d = new Date(input.value);
    if(!isNaN(d.getTime())) { 
      calDate = new Date(d); 
      calSelected = new Date(d); 
    } else {
      calDate = new Date(); 
      calSelected = new Date();
    }
  } else {
    calDate = new Date(); 
    calSelected = new Date();
  }
  
  const ov = document.getElementById('calPickerOv');
  const picker = document.getElementById('calPicker');
  
  ov.classList.add('open');
  
  // Posizionamento intelligente
  const rect = event.target.getBoundingClientRect();
  const pickerHeight = 380;
  const pickerWidth = 280;
  const spaceBelow = window.innerHeight - rect.bottom;
  const spaceAbove = rect.top;
  
  if(spaceBelow < pickerHeight && spaceAbove > spaceBelow) {
    picker.style.top = Math.max(8, rect.top - pickerHeight - 8) + 'px';
  } else {
    picker.style.top = Math.min(window.innerHeight - pickerHeight - 8, rect.bottom + 8) + 'px';
  }
  
  picker.style.left = Math.min(Math.max(8, rect.left), window.innerWidth - pickerWidth - 8) + 'px';
  
  renderCalPicker();
  setTimeout(()=>document.getElementById('calTime')?.focus(), 100);
}

function calSetDate(y, m, d) {
  calSelected = new Date(y, m, d);
  calDate = new Date(y, m, d);
  renderCalPicker();
}

function confirmCalPicker() {
  if(!calSelected || !calTargetInput) { 
    closeCalPicker(); 
    return; 
  }
  
  const time = document.getElementById('calTime').value || '09:00';
  const [hh, mm] = time.split(':');
  
  calSelected.setHours(parseInt(hh) || 0, parseInt(mm) || 0, 0, 0);
  
  const pad = n => String(n).padStart(2, '0');
  const str = `${calSelected.getFullYear()}-${pad(calSelected.getMonth()+1)}-${pad(calSelected.getDate())} ${pad(calSelected.getHours())}:${pad(calSelected.getMinutes())}`;
  
  const el = document.getElementById(calTargetInput);
  if(el) {
    el.value = str;
  }
  
  closeCalPicker();
}

function closeCalPicker() { 
  document.getElementById('calPickerOv').classList.remove('open'); 
  calSelected = null;
  calTargetInput = null;
}

function closeCalPickerIfOutside(e) {
  const ov = document.getElementById('calPickerOv');
  const picker = document.getElementById('calPicker');
  if(e.target === ov || (!picker.contains(e.target) && !e.target.closest('.cal-picker'))) {
    closeCalPicker();
  }
}

function renderCalPicker() {
  const months=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  document.getElementById('calMonthLbl').textContent = `${months[calDate.getMonth()]} ${calDate.getFullYear()}`;
  const firstDay = new Date(calDate.getFullYear(), calDate.getMonth(), 1);
  const lastDay  = new Date(calDate.getFullYear(), calDate.getMonth()+1, 0);
  const today    = new Date();
  let offset = firstDay.getDay()-1; if(offset<0) offset=6;
  let html='';
  for(let i=0;i<offset;i++){
    const d=new Date(calDate.getFullYear(),calDate.getMonth(),-(offset-1-i));
    html+=`<div class="cal-d other-month" onclick="calSetDate(${d.getFullYear()},${d.getMonth()},${d.getDate()})">${d.getDate()}</div>`;
  }
  for(let d=1;d<=lastDay.getDate();d++){
    const isToday=(d===today.getDate()&&calDate.getMonth()===today.getMonth()&&calDate.getFullYear()===today.getFullYear());
    const isSel=(calSelected&&d===calSelected.getDate()&&calDate.getMonth()===calSelected.getMonth()&&calDate.getFullYear()===calSelected.getFullYear());
    html+=`<div class="cal-d ${isToday?'today':''} ${isSel?'selected':''}" onclick="calSetDate(${calDate.getFullYear()},${calDate.getMonth()},${d})">${d}</div>`;
  }
  document.getElementById('calDays').innerHTML=html;
  if(calSelected) {
    const h=String(calSelected.getHours()).padStart(2,'0');
    const m=String(calSelected.getMinutes()).padStart(2,'0');
    document.getElementById('calTime').value=`${h}:${m}`;
  }
}

function calNavMonth(dir) {
  calDate.setMonth(calDate.getMonth()+dir);
  renderCalPicker();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadUsers() {
  document.getElementById('loginLoadingMsg').style.display = 'block';
  try {
    const resp = await fetch('./users.json', { cache: 'no-cache' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const json = await resp.json();
    const list = json.users || json;
    if (Array.isArray(list) && list.length > 0) {
      USERS = list;
      console.info(`[ChangeFlow] users.json caricato: ${USERS.length} utenti`);
      document.getElementById('loginSourceTag').textContent = 'üìÑ utenti da users.json';
    } else {
      throw new Error('Array vuoto');
    }
  } catch (e) {
    console.warn('[ChangeFlow] users.json non raggiungibile, uso fallback embedded:', e.message);
    USERS = USERS_FALLBACK;
    document.getElementById('loginSourceTag').textContent = '‚ö† utenti da fallback embedded';
    document.getElementById('loginSourceTag').style.color = 'var(--accent4)';
  }
  document.getElementById('loginLoadingMsg').style.display = 'none';
  initLogin();
}

loadUsers();
</script>
</body>
</html>
